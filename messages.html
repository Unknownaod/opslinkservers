<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Messages - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6">
  <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
  <div class="flex items-center gap-8 text-sm">
    <a href="index.html" class="hover:opacity-80">Home</a>
    <a href="browse.html" class="hover:opacity-80">Browse</a>
    <a href="submit.html" class="hover:opacity-80">Submit</a>
    <a href="login.html" id="loginBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">
      Login
    </a>
  </div>
</nav>

<!-- MAIN -->
<section class="px-10 py-12 max-w-6xl mx-auto">
  <h1 class="text-5xl font-bold mb-8">Messages</h1>

  <!-- TABS -->
  <div class="flex border-b border-zinc-700 mb-8">
    <button id="tabSystem" class="px-5 py-3 font-medium border-b-2 border-indigo-600">
      System
    </button>
    <button id="tabMyServers" class="px-5 py-3 font-medium text-zinc-400 hover:text-white">
      My Servers
    </button>
    <button id="tabChats" class="px-5 py-3 font-medium text-zinc-400 hover:text-white">
      Chat Messages
    </button>
  </div>

  <!-- SYSTEM -->
  <div id="systemMessages" class="flex flex-col gap-4">
    <p class="text-zinc-400">System messages will appear here.</p>
  </div>

  <!-- MY SERVERS -->
  <div id="myServersMessages" class="hidden">
    <p class="text-zinc-400">Your server-related messages will appear here.</p>
  </div>

  <!-- CHAT MESSAGES -->
  <div id="chatMessages" class="hidden border border-zinc-700 rounded-lg overflow-hidden bg-zinc-900">

    <!-- Header -->
    <div class="px-6 py-4 border-b border-zinc-700">
      <h2 class="text-xl font-semibold">Chat Messages</h2>
      <p class="text-sm text-zinc-400">
        Direct conversations with other OpsLink users.
      </p>
    </div>

    <!-- Layout -->
    <div class="grid grid-cols-4 min-h-[480px]">

      <!-- LEFT: SEARCH + CHAT LIST -->
      <div class="col-span-1 bg-zinc-950 border-r border-zinc-700 flex flex-col">

        <!-- Search -->
        <div class="p-4 border-b border-zinc-700">
          <input
            id="userSearch"
            placeholder="Search username..."
            class="w-full bg-zinc-800 px-3 py-2 rounded text-sm outline-none"
          />
          <div id="searchResults" class="mt-2"></div>
        </div>

        <!-- Chats -->
        <div id="chatList" class="flex-1 overflow-y-auto">
          <p class="p-4 text-sm text-zinc-400">
            No chats open currently.
          </p>
        </div>

      </div>

      <!-- RIGHT: CHAT WINDOW -->
      <div class="col-span-3 flex flex-col">

        <div id="chatHeader" class="p-4 border-b border-zinc-700 text-lg font-semibold">
          No chat selected
        </div>

        <div
          id="chatBody"
          class="flex-1 p-6 overflow-y-auto flex flex-col gap-2 text-sm"
        >
          <p class="text-zinc-400 text-center mt-10">
            Select a chat or search for a user to start a new conversation.
          </p>
        </div>

        <div class="p-4 border-t border-zinc-700 flex gap-2">
          <input
            id="chatInput"
            class="flex-1 bg-zinc-800 rounded px-3 py-2 outline-none"
            placeholder="Type a message..."
          />
          <button
            id="sendBtn"
            class="px-5 py-2 rounded bg-indigo-600 hover:bg-indigo-700"
          >
            Send
          </button>
        </div>

      </div>
    </div>
  </div>
</section>

<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>Â© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API = 'https://opslinkservers-backend.onrender.com';

const tabSystem = document.getElementById('tabSystem');
const tabMyServers = document.getElementById('tabMyServers');
const tabChats = document.getElementById('tabChats');

const systemMessages = document.getElementById('systemMessages');
const myServersMessages = document.getElementById('myServersMessages');
const chatMessages = document.getElementById('chatMessages');

const chatList = document.getElementById('chatList');
const chatBody = document.getElementById('chatBody');
const chatHeader = document.getElementById('chatHeader');

const loginBtn = document.getElementById('loginBtn');

const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user'));

let activeChat = null;

/* ---------- LOGIN ---------- */
if (token && user) {
  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.onclick = () => {
    localStorage.clear();
    location.reload();
  };
}

/* ---------- TAB HANDLING ---------- */
function activate(tab) {
  [tabSystem, tabMyServers, tabChats].forEach(t => {
    t.classList.remove('border-indigo-600');
    t.classList.add('text-zinc-400');
  });
  tab.classList.add('border-indigo-600');
  tab.classList.remove('text-zinc-400');

  systemMessages.classList.add('hidden');
  myServersMessages.classList.add('hidden');
  chatMessages.classList.add('hidden');
}

tabSystem.onclick = () => {
  activate(tabSystem);
  systemMessages.classList.remove('hidden');
};

tabMyServers.onclick = () => {
  activate(tabMyServers);
  myServersMessages.classList.remove('hidden');
};

tabChats.onclick = () => {
  activate(tabChats);
  chatMessages.classList.remove('hidden');
  loadChats();
};

/* ---------- LOAD CHATS ---------- */
async function loadChats() {
  chatList.innerHTML = '<p class="p-4 text-sm text-zinc-400">Loading chats...</p>';

  const res = await fetch(`${API}/api/messages`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const chats = await res.json();

  if (!chats.length) {
    chatList.innerHTML =
      '<p class="p-4 text-sm text-zinc-400">No chats open currently.</p>';
    return;
  }

  chatList.innerHTML = '';
  chats.forEach(chat => {
    const other = chat.participants.find(p => p._id !== user._id);
    const div = document.createElement('div');
    div.className = 'p-4 border-b border-zinc-800 hover:bg-zinc-800 cursor-pointer';
    div.innerHTML = `
      <div class="font-medium">${other.username}</div>
      <div class="text-xs text-zinc-400 truncate">${chat.lastMessage || ''}</div>
    `;
    div.onclick = () => openChat(chat._id, other.username);
    chatList.appendChild(div);
  });
}

/* ---------- OPEN CHAT ---------- */
async function openChat(chatId, name) {
  activeChat = chatId;
  chatHeader.textContent = name;
  chatBody.innerHTML = '';

  const res = await fetch(`${API}/api/messages/${chatId}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const chat = await res.json();

  chat.messages.forEach(m => {
    const div = document.createElement('div');
    div.className = `max-w-md px-3 py-2 rounded ${
      m.sender._id === user._id
        ? 'bg-indigo-600 self-end'
        : 'bg-zinc-800 self-start'
    }`;
    div.textContent = m.content;
    chatBody.appendChild(div);
  });

  chatBody.scrollTop = chatBody.scrollHeight;
}

/* ---------- SEND MESSAGE ---------- */
document.getElementById('sendBtn').onclick = async () => {
  const input = document.getElementById('chatInput');
  if (!activeChat || !input.value.trim()) return;

  await fetch(`${API}/api/messages/${activeChat}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({ content: input.value })
  });

  input.value = '';
  openChat(activeChat, chatHeader.textContent);
};

/* ---------- SEARCH USERS ---------- */
document.getElementById('userSearch').oninput = async e => {
  const q = e.target.value.trim();
  const results = document.getElementById('searchResults');
  results.innerHTML = '';
  if (!q) return;

  const res = await fetch(`${API}/api/users/search?q=${q}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const users = await res.json();

  users.forEach(u => {
    const d = document.createElement('div');
    d.className = 'text-sm p-2 hover:bg-zinc-800 cursor-pointer';
    d.textContent = u.username;
    d.onclick = async () => {
      const r = await fetch(`${API}/api/messages/start`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ username: u.username })
      });
      const data = await r.json();
      results.innerHTML = '';
      loadChats();
      openChat(data.chatId, u.username);
    };
    results.appendChild(d);
  });
};

/* INIT */
tabSystem.click();
</script>

</body>
</html>
