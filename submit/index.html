<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Server - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-10 py-6">
    <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
    <div class="flex items-center gap-8 text-sm" id="navLinks">
      <a href="/" class="hover:opacity-80">Home</a>
      <a href="/servers/" class="hover:opacity-80">Browse</a>
      <a href="/submit/" class="hover:opacity-80">Submit</a>
      <a href="/messages/" class="hover:opacity-80">Messages</a>
      <a href="/support/" class="hover:opacity-80">Support</a>
      <a href="/auth/login/" id="loginBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Login</a>
      <a href="#" id="adminBtn" class="hidden rounded-full bg-red-600 text-white px-4 py-2 hover:bg-red-700">Admin Dashboard</a>
    </div>
  </nav>

  <section class="px-10 py-10 max-w-2xl mx-auto">
    <h1 class="text-5xl font-bold mb-6">Submit Your Discord Server</h1>

<!-- Instructions & Rules -->
<div class="bg-zinc-800 p-4 rounded text-zinc-300 mb-6">
  <h2 class="font-semibold mb-2">Submission Rules & Responsibilities</h2>
  <ul class="list-disc list-inside text-sm space-y-1">
    <li>You must be the <strong>server owner</strong> or an <strong>authorized representative</strong>.</li>
    <li>All information submitted must be <strong>accurate and truthful</strong>.</li>
    <li>If your server is approved, <strong>you are responsible for its content, moderation, and community management</strong>.</li>
    <li>OpsLink Servers reserves the right to remove your server if it violates our guidelines.</li>
    <li>NSFW content must be properly labeled, or your server will be denied.</li>
    <li><strong>You must have our bot added to your server</strong> for live statistics (member count, online users) to work. Without it, your server submission may be denied.</li>


    <li class="mt-3"><strong>Here's how to get your server ID:</strong> <a href="https://www.youtube.com/watch?v=F-_R7e4W0wk" class="text-blue-400 underline" target="_blank">Watch this guide</a></li>
    <li><strong>You may use any media platform for the logo as long as it shows in the logo preview!</strong></li>
    <li><strong>To get a logo from Discord, you may use any serverinfo command or post the photo from your computer into Discord then Right Click the photo and Below Save & Copy Image there is Copy Link, you click that.</strong></li>
  </ul>
</div>

    <!-- Submission Form -->
    <div class="bg-zinc-900/80 border border-zinc-800 p-6 rounded">
      <form id="submitForm" class="flex flex-col gap-4">

        <!-- Basic Info -->
        <input name="name" placeholder="Server Name" class="p-2 rounded bg-zinc-800" required/>
        <input name="invite" placeholder="Server Invite Link(Must be https://discord.gg/ or discord.gg/)" class="p-2 rounded bg-zinc-800" required/>
        <textarea name="description" placeholder="Brief Description" class="p-2 rounded bg-zinc-800" required></textarea>

        <!-- Discord Bot Info -->
        <div class="bg-zinc-700 p-3 rounded text-sm mb-4">
          <p>To enable live statistics, you must add our bot to your server:</p>
          <a href="https://discord.com/oauth2/authorize?client_id=1466430352238055587&permissions=524288&integration_type=0&scope=bot"
             target="_blank"
             class="text-indigo-400 hover:underline">
            Add the OpsLink Bot
          </a>
          <p class="mt-2">Once added, enter your server's <strong>Discord Server ID</strong> below:</p>
          <input name="discordServerId" placeholder="Discord Server ID" class="p-2 rounded bg-zinc-800" required/>
        </div>

        <!-- Advanced Server Info -->
        <input name="language" placeholder="Primary Language(Eg, English. Only Put One!)" class="p-2 rounded bg-zinc-800"/>
        <input name="members" type="number" placeholder="Approximate Number of Members" class="p-2 rounded bg-zinc-800"/>
        <select name="type" class="p-2 rounded bg-zinc-800">
          <option value="">Server Type</option>
          <option value="gaming">Gaming</option>
          <option value="community">Community</option>
          <option value="education">Education</option>
          <option value="hobby">Hobby / Interest</option>
          <option value="other">Other</option>
        </select>
        <textarea name="rules" placeholder="Server Rules (Optional)" class="p-2 rounded bg-zinc-800"></textarea>
        <input name="website" placeholder="Website / Social Links (Optional)" class="p-2 rounded bg-zinc-800"/>
        <label class="flex items-center gap-2">
          <input type="checkbox" name="nsfw"/> NSFW
        </label>

        <!-- Server Logo -->
        <label class="flex flex-col gap-2">
          Server Logo <span class="text-red-500">*</span>
          <input type="url" name="logo" id="logoInput" placeholder="https://example.com/logo.png" class="p-2 rounded bg-zinc-800 text-white" required/>
          <div id="logoPreviewContainer" class="mt-2 w-32 h-32 border-2 border-zinc-700 rounded overflow-hidden hidden">
            <img id="logoPreview" class="w-full h-full object-cover" alt="Logo Preview"/>
          </div>
        </label>

        <!-- Tags -->
        <label class="text-sm">Tags (up to 5 tags):</label>
        <div id="tagsContainer" class="flex gap-2 mb-4">
          <input type="text" id="tagInput" class="p-2 rounded bg-zinc-800" placeholder="Enter tag" />
          <button type="button" id="addTagBtn" class="bg-zinc-600 px-4 py-2 rounded text-white">Add Tag</button>
        </div>
        <div id="tagsList" class="flex flex-wrap gap-2 mb-4"></div>

        <!-- Acknowledgment -->
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" name="acknowledge" required/>
          I confirm I am the server owner or authorized representative and understand all responsibilities.
        </label>

        <button type="submit" class="bg-white text-black px-4 py-2 rounded hover:bg-zinc-200">Submit Server</button>
      </form>
    </div>
  </section>

  <!-- Footer -->
  <footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
    <span>© 2026 OpsLink Servers</span>
    <span>Not affiliated with Discord</span>
  </footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
let tags = [];
let currentUser = null;

/* ---------------- TOAST SYSTEM ---------------- */
function showToast(message, type = 'info') {
  const colors = {
    success: 'bg-green-600',
    error: 'bg-red-600',
    info: 'bg-zinc-800',
    warning: 'bg-yellow-500 text-black'
  };

  let container = document.getElementById('toastContainer');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'fixed top-6 right-6 z-[10000] space-y-3';
    document.body.appendChild(container);
  }

  const toast = document.createElement('div');
  toast.className = `
    ${colors[type] || colors.info}
    text-white px-5 py-3 rounded-lg shadow-lg
    flex items-center gap-3
    animate-slide-in
  `;
  toast.innerHTML = `
    <span class="flex-1 text-sm">${message}</span>
    <button class="text-lg leading-none opacity-70 hover:opacity-100">&times;</button>
  `;

  toast.querySelector('button').onclick = () => toast.remove();
  container.appendChild(toast);

  setTimeout(() => {
    toast.classList.add('opacity-0');
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

/* ---------------- AUTH / NAV ---------------- */
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');
const loginBtn = document.getElementById('loginBtn');
const adminBtn = document.getElementById('adminBtn');
const navLinks = document.getElementById('navLinks');

if (token && userStr) {
  currentUser = JSON.parse(userStr);
  let userId;
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    userId = payload.id || payload._id;
  } catch {
    userId = currentUser._id;
  }

  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.onclick = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    showToast('Logged out successfully', 'info');
    setTimeout(() => window.location.reload(), 800);
  };

// Create dropdown container
const dropdownContainer = document.createElement('div');
dropdownContainer.className = 'relative ml-2';

// Create trigger button
const welcomeBtn = document.createElement('button');
welcomeBtn.textContent = `Welcome, ${currentUser.discordUsername}`; // <-- fixed
welcomeBtn.className = 'text-sm text-zinc-300 mr-2 px-2 py-1 hover:bg-white/10 rounded transition';
dropdownContainer.appendChild(welcomeBtn);

// Create dropdown menu
const dropdownMenu = document.createElement('div');
dropdownMenu.className = 'absolute right-0 mt-2 w-36 bg-zinc-900 border border-zinc-700 rounded shadow-lg text-sm text-white opacity-0 pointer-events-none transition-opacity';
dropdownMenu.innerHTML = `
  <a href="/profile/?id=${userId}" class="block px-4 py-2 hover:bg-zinc-700">View Profile</a>
  <a href="/settings/" class="block px-4 py-2 hover:bg-zinc-700">Settings</a>
`;
dropdownContainer.appendChild(dropdownMenu);

// Toggle dropdown on click
welcomeBtn.addEventListener('click', (e) => {
  e.stopPropagation(); // prevent the document click from immediately closing it
  const isOpen = dropdownMenu.classList.contains('opacity-100');
  if (isOpen) {
    dropdownMenu.classList.remove('opacity-100');
    dropdownMenu.classList.add('opacity-0', 'pointer-events-none');
  } else {
    dropdownMenu.classList.remove('opacity-0', 'pointer-events-none');
    dropdownMenu.classList.add('opacity-100');
  }
});

// Hide dropdown when clicking outside
document.addEventListener('click', (e) => {
  if (!dropdownContainer.contains(e.target)) {
    dropdownMenu.classList.remove('opacity-100');
    dropdownMenu.classList.add('opacity-0', 'pointer-events-none');
  }
});

// Insert dropdown into nav
navLinks.insertBefore(dropdownContainer, loginBtn);



if (currentUser.role === 'admin' || currentUser.role === 'management') {
  adminBtn.classList.remove('hidden');
  adminBtn.href = 'dashboard.html';
}


/* ---------------- TAGS ---------------- */
const tagInput = document.getElementById('tagInput');
const addTagBtn = document.getElementById('addTagBtn');
const tagsList = document.getElementById('tagsList');

addTagBtn.onclick = () => {
  const value = tagInput.value.trim();

  if (!value) return;
  if (tags.includes(value)) {
    showToast('Tag already added', 'warning');
    return;
  }
  if (tags.length >= 5) {
    showToast('Maximum of 5 tags allowed', 'warning');
    return;
  }

  tags.push(value);
  renderTags();
  tagInput.value = '';
};

function renderTags() {
  tagsList.innerHTML = '';
  tags.forEach(tag => {
    const span = document.createElement('span');
    span.className = 'bg-zinc-700 px-3 py-1 rounded flex items-center gap-1';
    span.textContent = tag;

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = '×';
    removeBtn.onclick = () => {
      tags = tags.filter(t => t !== tag);
      renderTags();
    };

    span.appendChild(removeBtn);
    tagsList.appendChild(span);
  });
}

/* ---------------- LOGO PREVIEW ---------------- */
const logoInput = document.getElementById('logoInput');
const logoPreview = document.getElementById('logoPreview');
const logoPreviewContainer = document.getElementById('logoPreviewContainer');

logoInput.addEventListener('input', () => {
  const url = logoInput.value.trim();
  if (url) {
    logoPreview.src = url;
    logoPreviewContainer.classList.remove('hidden');
  } else {
    logoPreview.src = '';
    logoPreviewContainer.classList.add('hidden');
  }
});

/* ---------------- SUBMIT ---------------- */
document.getElementById('submitForm').addEventListener('submit', async e => {
  e.preventDefault();

  if (!currentUser || !token) {
    showToast('You must be logged in to submit a server', 'error');
    return setTimeout(() => (window.location.href = 'login.html'), 1200);
  }

  const payload = {
    name: e.target.name.value.trim(),
    invite: e.target.invite.value.trim(),
    description: e.target.description.value.trim(),
    language: e.target.language.value.trim(),
    members: e.target.members.value,
    type: e.target.type.value,
    rules: e.target.rules.value.trim(),
    website: e.target.website.value.trim(),
    logo: logoInput.value.trim(),
    nsfw: e.target.nsfw.checked,
    tags,
    discordServerId: e.target.discordServerId.value.trim()
  };

  if (!payload.logo) {
    showToast('Server logo is required', 'warning');
    return;
  }

  if (!payload.discordServerId) {
    showToast('Add the OpsLink bot and provide your server ID', 'warning');
    return;
  }

  try {
    showToast('Submitting server...', 'info');

    const res = await fetch(`${API_URL}/api/servers`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      showToast(data.error || 'Submission failed', 'error');
      return;
    }

    showToast('Server submitted! Awaiting approval.', 'success');
    e.target.reset();
    tags = [];
    renderTags();
    logoPreviewContainer.classList.add('hidden');

  } catch (err) {
    console.error(err);
    showToast('Network error. Please try again.', 'error');
  }
});
}
</script>

</body>
</html>
