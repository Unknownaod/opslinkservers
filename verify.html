<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verify Your Email - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white flex flex-col">

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-10 py-6">
    <div class="flex items-center gap-3 text-xl font-semibold tracking-wide">
      <img src="https://i.imgur.com/cafgdNU.png" alt="OpsLink Logo" class="w-10 h-10"/>
      OpsLink Servers
    </div>
    <div class="flex items-center gap-8 text-sm">
      <a href="index.html" class="hover:opacity-80">Home</a>
      <a href="browse.html" class="hover:opacity-80">Browse</a>
      <a href="submit.html" class="hover:opacity-80">Submit</a>
      <a href="login.html" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Login</a>
      <a href="signup.html" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Sign Up</a>
    </div>
  </nav>

  <!-- Verification Card -->
  <section class="flex-grow flex items-center justify-center px-4">
    <div class="bg-zinc-900/80 border border-zinc-800 p-10 rounded-2xl shadow-2xl max-w-md w-full text-center">
      <img src="https://i.imgur.com/cafgdNU.png" alt="Verify Email" class="w-24 mx-auto mb-6 rounded-full shadow-lg">

      <h1 class="text-3xl font-bold mb-4">Verify Your Email</h1>
      <p class="text-zinc-400 mb-6">
        We sent a verification link to your email. Please check your inbox.
        If you didn’t receive it, you can resend or change your email below.
      </p>

      <!-- Buttons -->
      <div class="flex justify-center gap-4 flex-wrap mb-4">
        <button class="bg-white text-black px-5 py-2 rounded-lg font-semibold hover:bg-zinc-200" onclick="resendEmail()">Resend Email</button>
        <button class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700" onclick="toggleChange()">Change Email</button>
      </div>

      <!-- Change Email Input -->
      <div class="flex flex-col gap-2 mb-2">
        <input type="email" id="newEmail" placeholder="Enter new email" class="bg-zinc-800 text-white p-2 rounded-lg hidden" />
        <button id="saveBtn" class="bg-green-500 text-black px-5 py-2 rounded-lg font-semibold hidden hover:bg-green-600" onclick="changeEmail()">Save New Email</button>
      </div>

      <!-- Status Message -->
      <p id="status" class="text-sm text-zinc-400 mt-2 min-h-[24px]"></p>
    </div>
  </section>

  <!-- Footer -->
  <footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
    <span>© 2026 OpsLink Servers</span>
    <span>Not affiliated with Discord</span>
  </footer>

  <script>
    const API_URL = 'https://opslinkservers-backend.onrender.com';
    const status = document.getElementById('status');
    const newEmailInput = document.getElementById('newEmail');
    const saveBtn = document.getElementById('saveBtn');

    // Get pending email from localStorage (saved during signup)
    const email = localStorage.getItem('pendingEmail');
    if (!email) {
      status.textContent = "⚠️ Missing email session. Please re-register.";
    }

    // Resend verification email
    async function resendEmail() {
      if (!email) return status.textContent = "⚠️ Missing email session. Please re-register.";

      status.textContent = "⏳ Resending verification email...";

      try {
        const res = await fetch(`${API_URL}/api/auth/resend-verification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        status.textContent = "✅ Verification email resent successfully.";
      } catch (err) {
        status.textContent = `❌ ${err.message || "Something went wrong."}`;
      }
    }

    // Show change email input
    function toggleChange() {
      newEmailInput.classList.toggle('hidden');
      saveBtn.classList.toggle('hidden');
      newEmailInput.focus();
    }

    // Change email and resend verification
    async function changeEmail() {
      const newEmail = newEmailInput.value.trim();
      if (!newEmail) return status.textContent = "⚠️ Enter a valid email.";

      status.textContent = "⏳ Updating email...";

      try {
        const res = await fetch(`${API_URL}/api/auth/change-email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ oldEmail: email, newEmail })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        localStorage.setItem('pendingEmail', newEmail);
        status.textContent = "✅ Email updated successfully. Verification sent!";
        newEmailInput.value = '';
        newEmailInput.classList.add('hidden');
        saveBtn.classList.add('hidden');
      } catch (err) {
        status.textContent = `❌ ${err.message || "Something went wrong."}`;
      }
    }
  </script>
</body>
</html>
