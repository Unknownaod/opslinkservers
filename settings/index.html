<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpsLink · Settings</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    .glass {
      background: rgba(24, 24, 27, 0.85);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255,255,255,0.06);
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white flex">

  <!-- Sidebar -->
  <aside class="w-72 glass p-8 hidden lg:flex flex-col gap-10">
    <div>
      <h1 class="text-2xl font-bold">OpsLink</h1>
      <p class="text-sm text-zinc-400">Account Settings</p>
    </div>

    <nav class="flex flex-col gap-2 text-zinc-300">
      <a href="/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-zinc-800">
        <i data-feather="home"></i> Home
      </a>
      <a href="#profile" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-zinc-800">
        <i data-feather="user"></i> Profile
      </a>
      <a href="#servers" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-zinc-800">
        <i data-feather="server"></i> My Servers
      </a>
      <a href="#security" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-zinc-800">
        <i data-feather="shield"></i> Security
      </a>
        <a href="#socials" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-zinc-800">
        <i data-feather="instagram"></i> Socials
      </a>
      <a href="#socials" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-zinc-800">
        <i data-feather="link"></i> Connections
      </a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-10 space-y-14">

    <header>
      <h2 class="text-4xl font-semibold">Account</h2>
      <p class="text-zinc-400 mt-2">
        Manage your account, servers, and security.
      </p>
    </header>

    <!-- Profile -->
    <section id="profile" class="glass rounded-2xl p-8 space-y-6">
      <div class="flex items-center gap-4">
        <div id="avatar"
          class="w-14 h-14 rounded-full bg-indigo-600 flex items-center justify-center text-xl font-bold">
          ?
        </div>
        <div>
          <h3 class="text-xl font-semibold">Profile</h3>
          <p class="text-sm text-zinc-400">Account identity</p>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <div>
          <p class="text-xs uppercase text-zinc-500">Email</p>
          <p id="email" class="text-indigo-400 font-medium mt-1"></p>
        </div>
        <div>
          <p class="text-xs uppercase text-zinc-500">Discord</p>
          <p id="discord" class="font-medium mt-1"></p>
        </div>
        <div>
          <p class="text-xs uppercase text-zinc-500">Role</p>
          <p id="role" class="font-medium mt-1"></p>
        </div>
      </div>
    </section>

    <!-- My Servers -->
    <section id="servers" class="glass rounded-2xl p-8 space-y-6">
      <div>
        <h3 class="text-xl font-semibold">My Servers</h3>
        <p class="text-sm text-zinc-400">Servers you own or submitted</p>
      </div>

      <div id="servers-list" class="grid md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
      <p id="servers-empty" class="hidden text-sm text-zinc-400">
        No servers found.
      </p>
    </section>

    <!-- Security -->
    <section id="security" class="glass rounded-2xl p-8 space-y-8">

      <div>
        <h3 class="text-xl font-semibold">Security</h3>
        <p class="text-sm text-zinc-400">Email & password management</p>
      </div>


      <hr class="border-zinc-800">

<div class="flex flex-col md:flex-row justify-between gap-6">
  <div>
    <p class="font-medium">Change Discord Username</p>
    <p class="text-sm text-zinc-400">
      Update your Discord username displayed on OpsLink.
    </p>
  </div>

  <button id="change-username"
    class="bg-green-600 hover:bg-green-500 transition px-6 py-3 rounded-lg font-medium">
    Change Username
  </button>
</div>

      <div class="flex flex-col md:flex-row justify-between gap-6">
        <div>
          <p class="font-medium">Change Email</p>
          <p class="text-sm text-zinc-400">
            Update your email and re-verify it.
          </p>
        </div>

        <button id="change-email"
          class="bg-indigo-600 hover:bg-indigo-500 transition px-6 py-3 rounded-lg font-medium">
          Change Email
        </button>
      </div>

      <hr class="border-zinc-800">

      <div class="flex flex-col md:flex-row justify-between gap-6">
        <div>
          <p class="font-medium">Change Password</p>
          <p class="text-sm text-zinc-400">
            We’ll email you a reset link.
          </p>
        </div>

        <button id="change-password"
          class="bg-red-600 hover:bg-red-500 transition px-6 py-3 rounded-lg font-medium">
          Send Reset Email
        </button>
      </div>


  

    </section>

<!-- Socials -->
<section id="socials" class="glass rounded-2xl p-8 space-y-6">
  <div>
    <h3 class="text-xl font-semibold">Socials</h3>
    <p class="text-sm text-zinc-400">Manage your social accounts</p>
  </div>

  <!-- List of socials -->
  <div id="socials-list" class="grid md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
  <p id="socials-empty" class="hidden text-sm text-zinc-400">
    No socials added.
  </p>

  <!-- Add Social Form -->
  <div id="add-socials-form" class="flex flex-col md:flex-row gap-3 mt-4">
    <select id="social-platform" class="p-2 rounded border border-zinc-700 bg-zinc-800 text-white">
      <option value="">Select Platform</option>
      <option value="discord">Discord</option>
      <option value="twitter">Twitter</option>
      <option value="instagram">Instagram</option>
      <option value="github">GitHub</option>
      <option value="tiktok">TikTok</option>
      <option value="linkedin">LinkedIn</option>
    </select>

    <input id="social-handle" type="text" placeholder="Username or URL" class="flex-1 p-2 rounded border border-zinc-700 bg-zinc-800 text-white" />

    <button id="add-social-btn" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-white">
      Add
    </button>
  </div>
  <p id="social-msg" class="text-sm text-red-500 mt-1"></p>
</section>

    
<!-- Connections -->
<section id="connections" class="glass rounded-2xl p-8 space-y-6">
  <div>
    <h3 class="text-xl font-semibold">Connections</h3>
    <p class="text-sm text-zinc-400">Link external accounts like Spotify, Twitch, YouTube, GitHub, and more.</p>
  </div>

  <!-- Connections grid -->
  <div id="connections-list" class="grid md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
  <p id="connections-empty" class="hidden text-sm text-zinc-400">No connections linked.</p>
</section>

    
  </main>

 <script>
feather.replace();

/* ===== FULL API URL ===== */
const API_URL = 'https://opslinkservers-backend.onrender.com/api';

/* ========= GET TOKEN & USER ========= */
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');

function redirectLogin() {
  localStorage.clear();
  window.location.href = '/auth/login/';
}

if (!token || !userStr) redirectLogin();

let user;
try {
  user = JSON.parse(userStr);
} catch {
  redirectLogin();
}

/* ========= POPULATE PROFILE ========= */
document.getElementById('email').textContent = user.email;
document.getElementById('discord').textContent =
  user.discordUsername + (user.discordTag ? `#${user.discordTag}` : '');
document.getElementById('role').textContent = user.role || 'user';
document.getElementById('avatar').textContent =
  user.discordUsername?.[0]?.toUpperCase() || '?';

/* ========= CUSTOM MODAL UTILS ========= */
function createModal({ title = '', message = '', placeholder = '', confirmText = 'OK', onConfirm }) {
  // Remove existing modal if present
  const existing = document.getElementById('custom-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'custom-modal';
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/70';

  modal.innerHTML = `
    <div class="bg-zinc-900 rounded-xl p-8 w-96 flex flex-col gap-4 shadow-lg">
      <h3 class="text-xl font-semibold">${title}</h3>
      ${message ? `<p class="text-zinc-400">${message}</p>` : ''}
      ${placeholder !== null ? `<input id="modal-input" type="text" placeholder="${placeholder}" class="w-full p-2 rounded bg-zinc-800 text-white border border-zinc-700">` : ''}
      <div class="flex justify-end gap-2">
        <button id="modal-cancel" class="px-4 py-2 bg-zinc-700 rounded hover:bg-zinc-600">Cancel</button>
        <button id="modal-confirm" class="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-500">${confirmText}</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  return new Promise((resolve, reject) => {
    modal.querySelector('#modal-cancel').onclick = () => {
      modal.remove();
      reject('cancelled');
    };
    modal.querySelector('#modal-confirm').onclick = () => {
      const value = modal.querySelector('#modal-input')?.value || null;
      modal.remove();
      resolve(value);
    };
  });
}

function showMessage({ title = '', message = '', confirmText = 'OK' }) {
  createModal({ title, message, placeholder: null, confirmText }).catch(() => {});
}

/* ========= LOAD MY SERVERS ========= */
async function loadServers() {
  try {
    const res = await fetch(`${API_URL}/servers/mine`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (res.status === 401) return redirectLogin();

    const servers = await res.json();
    const list = document.getElementById('servers-list');
    const empty = document.getElementById('servers-empty');

    list.innerHTML = '';
    if (!Array.isArray(servers) || servers.length === 0) {
      empty.classList.remove('hidden');
      return;
    }

    empty.classList.add('hidden');
    servers.forEach(s => {
      const card = document.createElement('div');
      card.className = 'bg-zinc-900/60 border border-zinc-800 rounded-xl p-5 space-y-3';
      card.innerHTML = `
        <div class="flex items-center gap-3">
          <img src="${s.logo}" class="w-10 h-10 rounded-md object-cover" />
          <div>
            <p class="font-medium">${s.name}</p>
            <p class="text-xs text-zinc-400">${s.status || 'pending'}</p>
          </div>
        </div>
      `;
      list.appendChild(card);
    });

  } catch (err) {
    console.error('Error fetching servers:', err);
    const list = document.getElementById('servers-list');
    list.innerHTML = `<p class="text-red-500">Failed to load servers. Try again later.</p>`;
  }
}
loadServers();

/* ========= CHANGE EMAIL ========= */
document.getElementById('change-email').onclick = async () => {
  try {
    const newEmail = await createModal({
      title: 'Change Email',
      message: 'Enter your new email address',
      placeholder: 'new-email@example.com',
      confirmText: 'Update'
    });

    if (!newEmail) return;

    const res = await fetch(`${API_URL}/auth/change-email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ newEmail })
    });

    if (res.status === 401) return redirectLogin();

    const data = await res.json();
    showMessage({
      title: 'Email Update',
      message: res.ok ? 'Email updated successfully. Please verify it.' : data.error
    });
  } catch (err) {
    if (err !== 'cancelled') {
      console.error('Error changing email:', err);
      showMessage({ title: 'Error', message: 'Something went wrong. Try again later.' });
    }
  }
};

/* ========= CHANGE PASSWORD ========= */
document.getElementById('change-password').onclick = async () => {
  try {
    const res = await fetch(`${API_URL}/auth/forgot-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: user.email })
    });

    const data = await res.json();
    showMessage({
      title: 'Password Reset',
      message: res.ok ? 'Password reset email sent.' : data.error
    });
  } catch (err) {
    console.error('Error sending reset email:', err);
    showMessage({ title: 'Error', message: 'Something went wrong. Try again later.' });
  }
};

/* ========= CHANGE DISCORD USERNAME ========= */
document.getElementById('change-username').onclick = async () => {
  try {
    const newUsername = await createModal({
      title: 'Change Discord Username',
      message: 'Enter your new Discord username',
      placeholder: 'NewUsername',
      confirmText: 'Update'
    });

    if (!newUsername) return;

    // Send only the newDiscordUsername — JWT identifies the user
    const res = await fetch(`${API_URL}/auth/change-username`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ newDiscordUsername: newUsername })
    });

    if (res.status === 401) return redirectLogin();

    const data = await res.json();
    if (res.ok) {
      showMessage({
        title: 'Username Updated',
        message: `Your Discord username is now ${newUsername}`
      });

      // Update local user object and page display
      user.discordUsername = newUsername;
      localStorage.setItem('user', JSON.stringify(user));
      document.getElementById('discord').textContent =
        user.discordUsername + (user.discordTag ? `#${user.discordTag}` : '');
      document.getElementById('avatar').textContent =
        user.discordUsername?.[0]?.toUpperCase() || '?';
    } else {
      showMessage({ title: 'Error', message: data.error });
    }
  } catch (err) {
    if (err !== 'cancelled') {
      console.error('Error changing username:', err);
      showMessage({ title: 'Error', message: 'Something went wrong. Try again later.' });
    }
  }
};

const socialsList = document.getElementById('socials-list');
const socialsEmpty = document.getElementById('socials-empty');
const addSocialForm = document.getElementById('add-socials-form');
const socialPlatform = document.getElementById('social-platform');
const socialHandle = document.getElementById('social-handle');
const addSocialBtn = document.getElementById('add-social-btn');
const socialMsg = document.getElementById('social-msg');

const platformLogos = {
  discord: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/discord.svg',
  twitter: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/twitter.svg',
  instagram: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg',
  github: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/github.svg',
  tiktok: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg',
  linkedin: 'https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/linkedin.svg',
};

// Fetch user socials
async function loadSocials() {
  try {
    const res = await fetch(`${API_URL}/profile`, { headers: { Authorization: `Bearer ${token}` } });
    if (res.status === 401) return redirectLogin();

    const data = await res.json();
    const socials = data.socials || [];

    socialsList.innerHTML = '';
    if (!socials.length) {
      socialsEmpty.classList.remove('hidden');
      return;
    }
    socialsEmpty.classList.add('hidden');

    socials.forEach(s => {
      const card = document.createElement('div');
      card.className = 'bg-zinc-900/60 border border-zinc-800 rounded-xl p-3 flex items-center justify-between gap-2';
      card.innerHTML = `
        <div class="flex items-center gap-2">
          <img src="${platformLogos[s.platform] || ''}" class="w-5 h-5" />
          <a href="${s.url}" target="_blank" class="underline text-blue-400">${s.handle}</a>
        </div>
        <button class="bg-red-600 hover:bg-red-500 text-xs px-2 py-1 rounded" onclick="deleteSocial('${s._id}')">Delete</button>
      `;
      socialsList.appendChild(card);
    });
  } catch (err) {
    console.error('Failed to load socials', err);
    socialsList.innerHTML = `<p class="text-red-500">Failed to load socials.</p>`;
  }
}

// Add a social
addSocialBtn.onclick = async () => {
  socialMsg.textContent = '';
  const platform = socialPlatform.value;
  const handle = socialHandle.value.trim();
  if (!platform || !handle) {
    socialMsg.textContent = 'Select a platform and enter a username or URL.';
    return;
  }

  try {
    const res = await fetch(`${API_URL}/profile/socials/add`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ platform, handle })
    });
    const data = await res.json();
    if (data.success) {
      socialHandle.value = '';
      socialPlatform.value = '';
      loadSocials();
    } else {
      socialMsg.textContent = data.message || 'Failed to add social.';
    }
  } catch (err) {
    console.error(err);
    socialMsg.textContent = 'Failed to add social.';
  }
};

// Delete a social
async function deleteSocial(id) {
  try {
    const res = await fetch(`${API_URL}/profile/socials/delete/${id}`, { method:'DELETE', headers:{ Authorization: `Bearer ${token}` } });
    const data = await res.json();
    if (data.success) loadSocials();
    else alert('Failed to delete social.');
  } catch (err) {
    console.error(err);
    alert('Failed to delete social.');
  }
}

// Initial load
loadSocials();
/* ========= SOCIAL CONNECTIONS ========= */
const connectionsList = document.getElementById('connections-list');
const connectionsEmpty = document.getElementById('connections-empty');

const platforms = {
  spotify: { name:"Spotify", logo:"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/spotify.svg", oauth:`${API_URL}/auth/connect/spotify` },
  github: { name:"GitHub", logo:"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/github.svg", oauth:`${API_URL}/auth/connect/github` },
  twitch: { name:"Twitch", logo:"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/twitch.svg", oauth:`${API_URL}/auth/connect/twitch` },
  youtube: { name:"YouTube", logo:"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg", oauth:`${API_URL}/auth/connect/youtube` }
};

async function loadConnections() {
  if (!token) return redirectLogin();
  try {
    const res = await fetch(`${API_URL}/profile/connections?token=${encodeURIComponent(token)}`);
    if (!res.ok) {
      if (res.status === 401) return redirectLogin();
      throw new Error(`HTTP ${res.status}`);
    }

    const data = await res.json();
    const socials = data.socials || [];
    connectionsList.innerHTML = '';

    const connected = socials.filter(s => s.connected);
    if (!connected.length) {
      connectionsEmpty.classList.remove('hidden');
    } else {
      connectionsEmpty.classList.add('hidden');
      connected.forEach(s => {
        const card = document.createElement('div');
        card.className = "bg-zinc-900/60 border border-zinc-800 rounded-xl p-4 flex items-center justify-between";
        card.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${platforms[s.platform]?.logo || ''}" class="w-6 h-6" />
            <div>
              <p class="font-medium">${s.username}</p>
              <a href="${s.profileUrl}" target="_blank" class="text-xs text-indigo-400 hover:underline">View Profile</a>
            </div>
          </div>
          <span class="text-xs bg-green-600/20 text-green-400 px-2 py-1 rounded">Connected</span>
        `;
        connectionsList.appendChild(card);
      });
    }
  } catch (err) {
    console.error('Failed to load connections', err);
    connectionsList.innerHTML = `<p class="text-red-500">Failed to load connections.</p>`;
  }
}

function connectPlatform(platform) {
  if (!platforms[platform] || !token) return redirectLogin();
  // Open in a new browser tab
  window.open(
    `${platforms[platform].oauth}?token=${encodeURIComponent(token)}`,
    "_blank"
  );
  alert("A new tab has opened for OAuth. After connecting, refresh this page to see your connected accounts.");
}

/* ========= CONNECTION BUTTONS ========= */
const connectButtonsContainer = document.createElement("div");
connectButtonsContainer.className = "flex flex-wrap gap-3 mt-4";

Object.keys(platforms).forEach(p => {
  const btn = document.createElement("button");
  btn.className = "bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded text-white flex items-center gap-2";
  btn.innerHTML = `<img src="${platforms[p].logo}" class="w-4 h-4"/> Connect ${platforms[p].name}`;
  btn.onclick = () => connectPlatform(p);
  connectButtonsContainer.appendChild(btn);
});

connectionsList.parentNode.insertBefore(connectButtonsContainer, connectionsList);

/* ========= INITIAL LOAD ========= */
loadConnections();


</script>


</body>
</html>
