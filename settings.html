<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Settings - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white">

<div class="flex min-h-screen">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-black/40 border-r border-white/10 p-5 flex flex-col gap-1">
    <h2 class="text-xs text-zinc-500 uppercase mb-2">User Settings</h2>

    <button onclick="openTab('account')" class="tab-btn">My Account</button>
    <button onclick="openTab('security')" class="tab-btn">Security</button>
    <button onclick="openTab('sessions')" class="tab-btn">Devices</button>
    <button onclick="openTab('billing')" class="tab-btn">Billing</button>
    <button onclick="openTab('privacy')" class="tab-btn">Privacy</button>

    <div class="mt-auto pt-4 border-t border-white/10">
      <button onclick="logout()" class="w-full text-left px-3 py-2 text-red-400 hover:bg-red-500/10 rounded">
        Log Out
      </button>
    </div>
  </aside>

  <!-- CONTENT -->
  <main class="flex-1 p-10 overflow-y-auto">

    <!-- ACCOUNT -->
    <section id="account" class="tab-content max-w-5xl">
      <h1 class="text-3xl font-bold mb-6">My Account</h1>

      <div class="bg-white/5 border border-white/10 rounded-xl p-6 space-y-6">

        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center text-2xl font-bold">
            <span id="avatarLetter">U</span>
          </div>
          <div>
            <h2 id="discordUsername" class="text-xl font-semibold"></h2>
            <p id="discordTag" class="text-sm text-zinc-400"></p>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-zinc-400">Email</label>
            <input id="email" disabled class="input"/>
          </div>
          <div>
            <label class="text-sm text-zinc-400">Discord ID</label>
            <input id="discordID" disabled class="input"/>
          </div>
        </div>

        <div class="border-t border-white/10 pt-6">
          <h3 class="font-semibold mb-2">Change Email</h3>
          <div class="grid md:grid-cols-2 gap-3">
            <input id="newEmail" placeholder="New Email" class="input"/>
            <input id="emailPassword" type="password" placeholder="Current Password" class="input"/>
          </div>
          <button onclick="changeEmail()" class="btn-primary mt-3">Update Email</button>
        </div>

        <div class="border-t border-white/10 pt-6">
          <h3 class="font-semibold mb-2">Change Password</h3>
          <div class="grid md:grid-cols-3 gap-3">
            <input id="currentPassword" type="password" placeholder="Current" class="input"/>
            <input id="newPassword" type="password" placeholder="New" class="input"/>
            <input id="confirmPassword" type="password" placeholder="Confirm" class="input"/>
          </div>
          <button onclick="changePassword()" class="btn-primary mt-3">Update Password</button>
        </div>

      </div>
    </section>

    <!-- SECURITY -->
    <section id="security" class="tab-content hidden max-w-5xl">
      <h1 class="text-3xl font-bold mb-6">Security</h1>

      <div class="bg-white/5 border border-white/10 rounded-xl p-6 space-y-4">

        <div class="flex gap-4 flex-wrap">
          <button onclick="rotateTokens()" class="btn-warning">Logout All Sessions</button>
          <button onclick="rotateTokens()" class="btn-danger">Force Token Reset</button>
        </div>

        <div class="border-t border-white/10 pt-4">
          <h3 class="font-semibold mb-3">Security Activity</h3>
          <div id="securityLogs" class="space-y-2 text-sm text-zinc-300">
            Loading security logs...
          </div>
        </div>

      </div>
    </section>

    <!-- DEVICES -->
    <section id="sessions" class="tab-content hidden max-w-5xl">
      <h1 class="text-3xl font-bold mb-6">Devices</h1>

      <div class="bg-white/5 border border-white/10 rounded-xl p-6 space-y-4">
        <h3 class="font-semibold">Active Sessions</h3>
        <div id="sessionsList" class="space-y-3 text-sm">
          Loading sessions...
        </div>
      </div>
    </section>

    <!-- BILLING -->
    <section id="billing" class="tab-content hidden max-w-5xl">
      <h1 class="text-3xl font-bold mb-6">Billing</h1>

      <div class="bg-white/5 border border-white/10 rounded-xl p-6 space-y-6">

        <div>
          <h3 class="font-semibold mb-3">Payment Methods</h3>
          <div id="cardList" class="space-y-3 mb-4">
            No saved cards.
          </div>
        </div>

        <div class="border-t border-white/10 pt-6">
          <h3 class="font-semibold mb-3">Add New Card</h3>
          <div class="grid md:grid-cols-2 gap-3">
            <input id="cardName" placeholder="Cardholder Name" class="input"/>
            <input id="cardNumber" placeholder="Card Number" class="input"/>
            <input id="cardExp" placeholder="MM/YY" class="input"/>
            <input id="cardCVC" placeholder="CVC" class="input"/>
          </div>
          <button onclick="addCard()" class="btn-success mt-3">Add Card</button>
        </div>

        <div class="border-t border-white/10 pt-6">
          <h3 class="font-semibold mb-3">Billing Address</h3>
          <div class="grid md:grid-cols-2 gap-3">
            <input id="billStreet" placeholder="Street" class="input"/>
            <input id="billCity" placeholder="City" class="input"/>
            <input id="billState" placeholder="Province" class="input"/>
            <input id="billZip" placeholder="Postal Code" class="input"/>
          </div>
          <button onclick="saveBillingAddress()" class="btn-primary mt-3">Save Address</button>
        </div>

      </div>
    </section>

    <!-- PRIVACY -->
    <section id="privacy" class="tab-content hidden max-w-5xl">
      <h1 class="text-3xl font-bold mb-6">Privacy</h1>

      <div class="bg-white/5 border border-white/10 rounded-xl p-6 space-y-4">
        <label class="flex items-center gap-3">
          <input type="checkbox" checked>
          Show profile publicly
        </label>

        <label class="flex items-center gap-3">
          <input type="checkbox">
          Allow analytics tracking
        </label>
      </div>

      <div class="bg-red-950/30 border border-red-500/20 rounded-xl p-6 mt-8">
        <h3 class="text-red-400 font-semibold mb-2">Danger Zone</h3>
        <button onclick="deleteAccount()" class="btn-danger">Delete Account</button>
      </div>
    </section>

  </main>
</div>

<!-- STYLES -->
<style>
  .tab-btn { @apply w-full text-left px-3 py-2 rounded hover:bg-white/10 text-zinc-300; }
  .input { @apply w-full bg-black/40 border border-white/10 rounded px-3 py-2; }
  .btn-primary { @apply px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded; }
  .btn-warning { @apply px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded; }
  .btn-danger { @apply px-4 py-2 bg-red-600 hover:bg-red-700 rounded; }
  .btn-success { @apply px-4 py-2 bg-green-600 hover:bg-green-700 rounded; }
</style>

<script>
const API = "https://opslinkservers-backend.onrender.com";
const token = localStorage.getItem("token");

if(!token) location.href = "login.html";

function openTab(id){
  document.querySelectorAll(".tab-content").forEach(e=>e.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

async function api(endpoint, data={}, method="POST"){
  const res = await fetch(API + endpoint, {
    method,
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + token
    },
    body: method==="GET"?null:JSON.stringify(data)
  });
  return res.json();
}

/* ================= LOAD USER ================= */

async function loadUser(){
  const res = await api("/auth/me", {}, "GET");

  discordUsername.textContent = res.discordUsername;
  discordTag.textContent = res.discordTag || "";
  email.value = res.email;
  discordID.value = res.discordUserID;
  avatarLetter.textContent = res.discordUsername[0].toUpperCase();
}

/* ================= ACCOUNT ================= */

async function changeEmail(){
  const res = await api("/auth/change-email", {
    email:newEmail.value,
    password:emailPassword.value
  });
  alert(res.message || res.error);
}

async function changePassword(){
  if(newPassword.value !== confirmPassword.value) return alert("Passwords do not match");

  const res = await api("/auth/change-password", {
    current:currentPassword.value,
    pass:newPassword.value
  });

  alert(res.message || res.error);
}

/* ================= SECURITY ================= */

async function rotateTokens(){
  await api("/auth/rotate-token-version");
  logout();
}

async function loadSecurityLogs(){
  const res = await api("/security/logs", {}, "GET");
  securityLogs.innerHTML = res.map(l => 
    `<div class="p-2 rounded bg-black/40 border border-white/10">
      ${l.action} • ${l.ip} • ${l.device} • ${new Date(l.createdAt).toLocaleString()}
    </div>`
  ).join("");
}

/* ================= SESSIONS ================= */

async function loadSessions(){
  const res = await api("/security/sessions", {}, "GET");
  sessionsList.innerHTML = res.map(s => 
    `<div class="flex justify-between items-center p-3 bg-black/40 border border-white/10 rounded">
      <div>
        <p>${s.device}</p>
        <p class="text-xs text-zinc-400">${s.ip} • ${new Date(s.lastUsed).toLocaleString()}</p>
      </div>
      <button onclick="killSession('${s._id}')" class="text-red-400 hover:text-red-300">Logout</button>
    </div>`
  ).join("");
}

async function killSession(id){
  await api("/security/sessions/" + id, {}, "DELETE");
  loadSessions();
}

/* ================= BILLING ================= */

async function loadCards(){
  const res = await api("/billing/cards", {}, "GET");
  cardList.innerHTML = res.length ? res.map(c => 
    `<div class="flex justify-between items-center p-3 bg-black/40 border border-white/10 rounded">
      <span>**** **** **** ${c.last4} • ${c.brand}</span>
      <button onclick="removeCard('${c._id}')" class="text-red-400 hover:text-red-300">Remove</button>
    </div>`
  ).join("") : "No saved cards.";
}

async function addCard(){
  const res = await api("/billing/cards", {
    name:cardName.value,
    number:cardNumber.value,
    exp:cardExp.value,
    cvc:cardCVC.value
  });
  alert(res.message || "Card added");
  loadCards();
}

async function removeCard(id){
  await api("/billing/cards/" + id, {}, "DELETE");
  loadCards();
}

async function saveBillingAddress(){
  const res = await api("/billing/address", {
    street:billStreet.value,
    city:billCity.value,
    state:billState.value,
    zip:billZip.value
  });
  alert(res.message || "Saved");
}

/* ================= DANGER ================= */

async function deleteAccount(){
  if(!confirm("This is permanent.")) return;
  await api("/auth/delete");
  logout();
}

function logout(){
  localStorage.clear();
  location.href="login.html";
}

/* ================= INIT ================= */

loadUser();
loadSessions();
loadSecurityLogs();
loadCards();
openTab("account");

</script>

</body>
</html>
