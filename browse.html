<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Servers - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
  <div class="flex items-center gap-8 text-sm" id="navLinks">
    <a href="index.html" class="hover:opacity-80">Home</a>
    <a href="browse.html" class="hover:opacity-80">Browse</a>
    <a href="submit.html" class="hover:opacity-80">Submit</a>
    <a href="messages.html" class="hover:opacity-80">Messages</a>
    <a href="login.html" id="loginBtn"
      class="rounded-full border border-white/20 px-4 py-2 hover:bg-white/10 transition">
      Login
    </a>
    <a href="#" id="adminBtn"
      class="hidden rounded-full bg-gradient-to-r from-red-600 to-red-500 text-white px-4 py-2 hover:brightness-110 transition">
      Admin Dashboard
    </a>
  </div>
</nav>

<section class="px-10 py-10">

  <h1 class="text-5xl font-bold mb-6">Browse Servers</h1>

  <!-- SEARCH / TAG FILTERS -->
  <div class="flex flex-wrap gap-4 mb-6 items-center">
    <input id="searchInput" type="text" placeholder="Search servers..."
      class="p-3 rounded-xl bg-zinc-900 border border-zinc-800 flex-grow outline-none focus:border-white/20"/>

    <div id="tagsFilterContainer" class="flex flex-wrap gap-2 max-w-xl"></div>

    <label class="ml-auto flex items-center gap-2 text-sm">
      <input type="checkbox" id="nsfwToggle"/> Show NSFW
    </label>
  </div>

  <!-- SERVERS GRID -->
  <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>

</section>

<!-- SERVER MODAL -->
<div id="serverModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-6 z-50">
  <div class="bg-zinc-900 rounded-2xl p-8 max-w-3xl w-full relative border border-zinc-800">

    <button id="closeModal" class="absolute top-4 right-4 text-zinc-400 hover:text-white text-2xl">&times;</button>

    <div class="flex items-center gap-4 mb-4">
      <div class="w-20 h-20 rounded-full border border-zinc-700 bg-zinc-950 flex items-center justify-center overflow-hidden">
        <img id="modalLogo" class="max-w-full max-h-full object-contain"/>
      </div>
      <div>
        <h2 id="modalName" class="text-3xl font-bold"></h2>
        <p id="modalTags" class="text-xs text-zinc-400"></p>
        <p id="modalOwner" class="text-xs text-zinc-400 mt-1"></p>
      </div>
    </div>

    <p id="modalDescription" class="text-zinc-300 mb-4"></p>

    <a id="modalInvite" target="_blank"
      class="inline-flex items-center justify-center px-8 py-3 rounded-xl font-semibold bg-gradient-to-r from-indigo-500 to-purple-600 hover:brightness-110 hover:scale-105 transition shadow-lg">
      ðŸš€ Join Server
    </a>

    <hr class="border-zinc-800 my-6"/>

    <h3 class="font-semibold mb-2">Reviews & Comments</h3>
    <div id="modalComments" class="flex flex-col gap-2 mb-4 max-h-60 overflow-y-auto"></div>

    <form id="commentForm" class="flex flex-col gap-3">
      <textarea name="comment" placeholder="Write a comment..."
        class="p-3 rounded-xl bg-zinc-800 border border-zinc-700 focus:border-white/20 outline-none"
        required></textarea>
      <button type="submit"
        class="bg-white text-black px-4 py-2 rounded-xl hover:bg-zinc-200 transition">
        Post Comment
      </button>
    </form>

    <button id="reportServerBtn"
      class="mt-4 bg-red-600 px-4 py-2 rounded-xl hover:bg-red-700 transition">
      Report Server
    </button>

  </div>
</div>

<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>Â© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
let servers = [];
let activeTags = new Set();
let allTags = new Set();
let currentServerId = null;

// --- AUTH ---
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');

// --- NAV LOGIN ---
const loginBtn = document.getElementById('loginBtn');
const adminBtn = document.getElementById('adminBtn');
const navLinks = document.getElementById('navLinks');

if (token && userStr) {
  const user = JSON.parse(userStr);

  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.onclick = () => {
    localStorage.clear();
    location.reload();
  };

  const welcome = document.createElement('span');
  welcome.textContent = `Welcome, ${user.discordUsername}`;
  welcome.className = 'text-zinc-300 text-sm';
  navLinks.insertBefore(welcome, loginBtn);

  if (user.role === 'admin') {
    adminBtn.classList.remove('hidden');
    adminBtn.href = 'dashboard.html';
  }
}

// --- LOAD SERVERS ---
async function loadServers() {
  const res = await fetch(`${API_URL}/api/servers`);
  servers = await res.json();

  // Collect all tags
  allTags.clear();
  servers.forEach(s => {
    (s.tags || []).forEach(tag => allTags.add(tag));
  });

  renderTagFilters();
  renderServers();
}

// --- RENDER TAG FILTERS ---
function renderTagFilters() {
  const container = document.getElementById('tagsFilterContainer');
  container.innerHTML = '';

  // "All" button
  const allBtn = document.createElement('button');
  allBtn.textContent = 'All';
  allBtn.className = 'filter-tag-btn px-3 py-1 rounded-xl bg-zinc-900 border border-zinc-800 hover:border-white/20 transition';
  allBtn.onclick = () => {
    activeTags.clear();
    renderServers();
  };
  container.appendChild(allBtn);

  // Buttons for existing tags
  allTags.forEach(tag => {
    const btn = document.createElement('button');
    btn.textContent = tag;
    btn.className = 'filter-tag-btn px-3 py-1 rounded-xl bg-zinc-900 border border-zinc-800 hover:border-white/20 transition';
    btn.onclick = () => {
      if (activeTags.has(tag)) activeTags.delete(tag);
      else activeTags.add(tag);
      renderServers();
    };
    container.appendChild(btn);
  });
}

// --- RENDER SERVERS ---
function renderServers() {
  const grid = document.getElementById('serversGrid');
  const search = document.getElementById('searchInput').value.toLowerCase();
  const nsfw = document.getElementById('nsfwToggle').checked;

  grid.innerHTML = '';

  const filtered = servers
    .filter(s => nsfw || !s.nsfw)
    .filter(s => activeTags.size === 0 || s.tags.some(tag => activeTags.has(tag)))
    .filter(s =>
      s.name.toLowerCase().includes(search) ||
      s.description.toLowerCase().includes(search)
    );

  if (!filtered.length) {
    grid.innerHTML = '<div class="col-span-full text-center text-zinc-400 mt-10">No servers found</div>';
    return;
  }

  filtered.forEach(s => {
    let invite = s.invite || '';
    if (invite.startsWith('discord.gg/')) invite = 'https://' + invite;

    const owner = s.submitterDiscord
      ? `${s.submitterDiscord.username}${s.submitterDiscord.tag ? '#' + s.submitterDiscord.tag : ''}`
      : 'Unknown';

    const card = document.createElement('div');
    card.className = 'group bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden hover:scale-[1.03] transition cursor-pointer';

    card.innerHTML = `
      <div class="relative h-44 bg-black">
        <img src="${s.logo}" class="w-full h-full object-contain p-2"/>
      </div>

      <div class="p-5 space-y-2">
        <h3 class="text-lg font-semibold">${s.name}</h3>

        <p class="text-xs text-zinc-400">
          Server Owner: <span class="text-zinc-200">${owner}</span>
        </p>

        <p class="text-sm text-zinc-300 line-clamp-2">${s.description}</p>

        <div class="flex flex-wrap gap-1.5">
          ${(s.tags || []).map(tag => `
            <span class="px-2 py-0.5 text-[11px] font-semibold rounded-full bg-zinc-800 border border-zinc-700">
              #${tag}
            </span>
          `).join('')}
        </div>

        <div class="flex justify-between items-center pt-1">
          <span class="text-xs text-zinc-500 members-count" data-id="${s.discordServerId}">
            ${s.members != null ? s.members : 'N/A'} members
          </span>

          <a href="${invite}" target="_blank"
             class="px-4 py-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-sm font-semibold hover:brightness-110">
             ðŸš€ Join
          </a>
        </div>
      </div>
    `;

    card.onclick = e => {
      if (e.target.tagName !== 'A') openServerModal(s._id);
    };

    grid.appendChild(card);
  });
}

// --- OPEN MODAL ---
async function openServerModal(id) {
  currentServerId = id;

  const res = await fetch(`${API_URL}/api/servers/${id}`);
  const server = await res.json();

  const owner = server.submitterDiscord;

  document.getElementById('modalLogo').src = server.logo;
  document.getElementById('modalName').textContent = server.name;
  document.getElementById('modalDescription').textContent = server.description;
  document.getElementById('modalTags').textContent = 'Tags: ' + server.tags.join(', ');
  document.getElementById('modalOwner').textContent = owner
    ? `Server Owner: ${owner.username}${owner.tag ? '#' + owner.tag : ''} (${owner.userID})`
    : 'Server Owner: Unknown';
  document.getElementById('modalInvite').href = server.invite;

  const comments = document.getElementById('modalComments');
  comments.innerHTML = '';

  server.comments.forEach(c => {
    const div = document.createElement('div');
    div.className = 'bg-zinc-800 p-3 rounded-xl text-sm';
    div.textContent = `${c.user}: ${c.text}`;
    comments.appendChild(div);
  });

  document.getElementById('serverModal').classList.remove('hidden');
}

// --- CLOSE MODAL ---
document.getElementById('closeModal').onclick = () => {
  document.getElementById('serverModal').classList.add('hidden');
};

// --- POST COMMENT ---
document.getElementById('commentForm').onsubmit = async e => {
  e.preventDefault();
  if (!token) return alert('Login required to comment.');

  const text = e.target.comment.value.trim();
  if (!text) return;

  await fetch(`${API_URL}/api/servers/${currentServerId}/comments`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ text })
  });

  e.target.reset();
  openServerModal(currentServerId);
};

// --- REPORT SERVER ---
document.getElementById('reportServerBtn').onclick = async () => {
  if (!token) return alert('Login required to report servers.');

  const reason = prompt('Why are you reporting this server?');
  if (!reason) return;

  await fetch(`${API_URL}/api/servers/${currentServerId}/report`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ reason })
  });

  alert('Server reported successfully.');
};

// --- SEARCH / FILTER EVENTS ---
document.getElementById('searchInput').oninput = renderServers;
document.getElementById('nsfwToggle').onchange = renderServers;

// Load servers
loadServers();
</script>

</body>
</html>
