<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Servers - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-10 py-6">
    <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
    <div class="flex items-center gap-8 text-sm" id="navLinks">
      <a href="index.html" class="hover:opacity-80">Home</a>
      <a href="browse.html" class="hover:opacity-80">Browse</a>
      <a href="submit.html" class="hover:opacity-80">Submit</a>
      <a href="messages.html" class="hover:opacity-80">Messages</a>
      <a href="login.html" id="loginBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Login</a>
      <a href="#" id="adminBtn" class="hidden rounded-full bg-red-600 text-white px-4 py-2 hover:bg-red-700">Admin Dashboard</a>
    </div>
  </nav>

  <!-- Notification Banner -->
  <div id="notificationBanner" class="fixed top-0 left-0 w-full bg-yellow-500 text-black text-center py-2 hidden">
    <span id="notificationMessage" class="font-semibold">New System Message! Check now!</span>
    <button id="dismissNotification" class="absolute right-5 top-1/2 transform -translate-y-1/2 text-black font-bold">X</button>
  </div>

  <section class="px-10 py-10">
    <h1 class="text-5xl font-bold mb-6">Browse Servers</h1>

    <!-- Search / Filters / NSFW -->
    <div class="flex flex-wrap gap-4 mb-6 items-center">
      <input id="searchInput" type="text" placeholder="Search servers..." class="p-2 rounded bg-zinc-800 flex-grow"/>
      <button class="px-3 py-1 bg-zinc-800 rounded filter-btn" data-tag="all">All</button>
      <button class="px-3 py-1 bg-zinc-800 rounded filter-btn" data-tag="gaming">Gaming</button>
      <button class="px-3 py-1 bg-zinc-800 rounded filter-btn" data-tag="community">Community</button>
      <button class="px-3 py-1 bg-zinc-800 rounded filter-btn" data-tag="art">Art</button>
      <button class="px-3 py-1 bg-zinc-800 rounded filter-btn" data-tag="tech">Tech</button>
      <label class="ml-auto flex items-center gap-2 text-sm">
        <input type="checkbox" id="nsfwToggle"/> Show NSFW
      </label>
    </div>

    <!-- Servers Grid -->
    <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Server Modal -->
  <div id="serverModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-6 z-50">
    <div class="bg-zinc-900 rounded p-6 max-w-3xl w-full relative">
      <button id="closeModal" class="absolute top-4 right-4 text-zinc-400 hover:text-white">&times;</button>
      <h2 id="modalName" class="text-3xl font-bold mb-2"></h2>
      <p id="modalDescription" class="text-zinc-300 mb-2"></p>
      <p id="modalTags" class="text-xs text-zinc-500 mb-4"></p>
      <a id="modalInvite" href="#" target="_blank" class="text-blue-400 underline mb-4 inline-block">Join Server</a>

      <hr class="border-zinc-700 my-4"/>

      <div>
        <h3 class="font-semibold mb-2">Reviews & Comments</h3>
        <div id="modalComments" class="flex flex-col gap-2 mb-4 max-h-60 overflow-y-auto"></div>

        <form id="commentForm" class="flex flex-col gap-2">
          <textarea name="comment" placeholder="Write a comment..." class="p-2 rounded bg-zinc-800" required></textarea>
          <button type="submit" class="bg-white text-black px-4 py-2 rounded hover:bg-zinc-200">Post Comment</button>
        </form>

        <!-- Report Server Button -->
        <button id="reportServerBtn" class="mt-4 bg-red-600 px-4 py-2 rounded hover:bg-red-700">Report Server</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
    <span>Â© 2026 OpsLink Servers</span>
    <span>Not affiliated with Discord</span>
  </footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
let servers = [];
let activeTag = 'all';
let hasNewMessage = false;

// --- LocalStorage login handling ---
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');
const loginBtn = document.getElementById('loginBtn');
const adminBtn = document.getElementById('adminBtn');
const navLinks = document.getElementById('navLinks');
const notificationBanner = document.getElementById('notificationBanner');
const dismissNotification = document.getElementById('dismissNotification');

if (token && userStr) {
  const user = JSON.parse(userStr);

  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.reload();
  });

  const welcomeSpan = document.createElement('span');
  welcomeSpan.textContent = `Welcome, ${user.discordUsername}`;
  welcomeSpan.className = "text-sm text-zinc-300";
  navLinks.insertBefore(welcomeSpan, loginBtn);

  if (user.role === 'admin') {
    adminBtn.classList.remove('hidden');
    adminBtn.href = 'dashboard.html';
  }
} else {
  adminBtn.classList.add('hidden');
  loginBtn.textContent = 'Login';
  loginBtn.href = 'login.html';
  loginBtn.replaceWith(loginBtn.cloneNode(true));
}

// Show the notification banner when there's a new system message
function showNotificationBanner() {
  if (hasNewMessage) {
    notificationBanner.classList.remove('hidden');
  }
}

// Hide the notification banner when dismissed
dismissNotification.addEventListener('click', () => {
  notificationBanner.classList.add('hidden');
  hasNewMessage = false;
});

// --- Load servers ---
async function loadServers() {
  try {
    const res = await fetch(`${API_URL}/api/servers`);
    servers = await res.json();
    renderServers();
    checkForNewMessages();
  } catch (err) {
    console.error('Failed to load servers:', err);
  }
}

// --- Check for new messages ---
async function checkForNewMessages() {
  try {
    const res = await fetch(`${API_URL}/api/messages`);
    const messages = await res.json();
    
    // Check if there are new messages and update the state
    const newMessages = messages.filter(m => !m.read && m.userId === JSON.parse(localStorage.getItem('user'))._id);
    
    if (newMessages.length > 0) {
      hasNewMessage = true;
      showNotificationBanner();
    }
  } catch (err) {
    console.error('Failed to fetch messages:', err);
  }
}

// --- Render servers ---
function renderServers() {
  const container = document.getElementById('serversGrid');
  const search = document.getElementById('searchInput').value.toLowerCase();
  const nsfw = document.getElementById('nsfwToggle').checked;

  container.innerHTML = '';

  const filtered = servers
    .filter(s => (nsfw || !s.nsfw))
    .filter(s => activeTag === 'all' || s.tags.includes(activeTag))
    .filter(s => s.name.toLowerCase().includes(search) || s.description.toLowerCase().includes(search));

  if (filtered.length === 0) {
    const message = document.createElement('div');
    message.className = 'col-span-full text-center text-zinc-400 mt-10';
    message.textContent = 'No servers to show...';
    container.appendChild(message);
    return;
  }

  filtered.forEach(s => {
    const card = document.createElement('div');
    card.className = 'bg-zinc-900/80 border border-zinc-800 p-6 rounded hover:scale-105 transition-transform cursor-pointer';
    let inviteLink = s.invite || '';
    if (inviteLink.startsWith('discord.gg/')) inviteLink = 'https://' + inviteLink;

    card.innerHTML = `
      <h3 class="text-lg font-semibold mb-2">${s.name}</h3>
      <p class="text-sm text-zinc-300 mb-2">${s.description}</p>
      <p class="text-xs text-zinc-500 mb-1">Tags: ${s.tags.join(', ')}</p>
      <p class="text-xs text-zinc-500 mb-1">Server Type: ${s.type || 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-1">Members: ${s.members || 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-1">Language: ${s.language || 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-1">NSFW: ${s.nsfw ? 'Yes' : 'No'}</p>
      <p class="text-xs text-zinc-500 mb-1">Submitted by: ${s.submitterDiscord.username} (${s.submitterDiscord.tag})</p>
      <p class="text-xs text-zinc-500 mb-1">UserID: ${s.submitterDiscord.userID}</p>
      <p class="text-xs text-zinc-500 mb-2">Created: ${new Date(s.createdAt).toLocaleString()}</p>
      <a href="${inviteLink}" target="_blank" class="text-blue-400 underline">Join Server</a>
      <p class="text-sm mb-2">Status: <span class="text-${s.status === 'approved' ? 'green' : s.status === 'denied' ? 'red' : 'yellow'}-400">${s.status}</span></p>
    `;
    card.addEventListener('click', () => openServerModal(s._id));
    container.appendChild(card);
  });
}

// --- Server modal ---
async function openServerModal(serverId) {
  try {
    const res = await fetch(`${API_URL}/api/servers/${serverId}`);
    const server = await res.json();

    document.getElementById('modalName').textContent = server.name;
    document.getElementById('modalDescription').textContent = server.description;
    document.getElementById('modalTags').textContent = 'Tags: ' + server.tags.join(', ');
    document.getElementById('modalInvite').href = server.invite;

    const commentsContainer = document.getElementById('modalComments');
    commentsContainer.innerHTML = '';
    server.comments.forEach(c => {
      const div = document.createElement('div');
      div.className = 'bg-zinc-800 p-2 rounded text-sm';
      div.textContent = `${c.user}: ${c.text}`;
      commentsContainer.appendChild(div);
    });

    document.getElementById('serverModal').classList.remove('hidden');

    const commentForm = document.getElementById('commentForm');
    commentForm.onsubmit = async e => {
      e.preventDefault();
      if (!token || !userStr) {
        alert("You must be logged in to post a comment.");
        return;
      }

      const commentText = e.target.comment.value;
      await fetch(`${API_URL}/api/servers/${serverId}/comments`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ text: commentText })
      });
      e.target.reset();
      openServerModal(serverId);
    };
  } catch (err) {
    console.error('Failed to load server details:', err);
  }
}

document.getElementById('closeModal').addEventListener('click', () => {
  document.getElementById('serverModal').classList.add('hidden');
});

loadServers();
</script>

</body>
</html>
