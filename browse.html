<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Servers - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
  <div class="flex items-center gap-8 text-sm" id="navLinks">
    <a href="index.html" class="hover:opacity-80">Home</a>
    <a href="browse.html" class="hover:opacity-80">Browse</a>
    <a href="submit.html" class="hover:opacity-80">Submit</a>
    <a href="messages.html" class="hover:opacity-80">Messages</a>
    <a href="support.html" class="hover:opacity-80">Support</a>
    <a href="login.html" id="loginBtn"
      class="rounded-full border border-white/20 px-4 py-2 hover:bg-white/10 transition">
      Login
    </a>
    <a href="#" id="adminBtn"
      class="hidden rounded-full bg-gradient-to-r from-red-600 to-red-500 text-white px-4 py-2 hover:brightness-110 transition">
      Admin Dashboard
    </a>
  </div>
</nav>

<section class="px-10 py-10">

  <h1 class="text-5xl font-bold mb-6">Browse Servers</h1>

<!-- SEARCH / FILTERS -->
<div class="flex flex-wrap gap-4 mb-6 items-center">
  <input
    id="searchInput"
    type="text"
    placeholder="Search servers..."
    class="p-3 rounded-xl bg-zinc-900 border border-zinc-800 flex-grow outline-none focus:border-white/20"
  />

  <!-- NSFW Toggle Switch -->
  <label class="ml-auto flex items-center gap-3 cursor-pointer select-none text-sm">
    <span>Show NSFW</span>
    <div class="relative">
      <input type="checkbox" id="nsfwToggle" class="sr-only peer" />
      <div class="w-12 h-6 bg-zinc-700 rounded-full peer-checked:bg-red-600 transition-colors"></div>
      <div
        class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow-md transform transition-transform peer-checked:translate-x-6"
      ></div>
    </div>
  </label>
</div>


  <!-- SERVERS GRID -->
  <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>

</section>

<!-- SERVER MODAL -->
<div id="serverModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-6 z-50">
  <div class="bg-zinc-900 rounded-2xl p-8 max-w-3xl w-full relative border border-zinc-800">

    <button id="closeModal" class="absolute top-4 right-4 text-zinc-400 hover:text-white text-2xl">&times;</button>

    <div class="flex items-center gap-4 mb-4">
      <div class="w-20 h-20 rounded-full border border-zinc-700 bg-zinc-950 flex items-center justify-center overflow-hidden">
        <img id="modalLogo" class="max-w-full max-h-full object-contain"/>
      </div>
      <div>
        <h2 id="modalName" class="text-3xl font-bold"></h2>
        <p id="modalTags" class="text-xs text-zinc-400"></p>
        <p id="modalOwner" class="text-xs text-zinc-400 mt-1"></p>
      </div>
    </div>

    <p id="modalDescription" class="text-zinc-300 mb-4"></p>

    <a id="modalInvite" target="_blank"
      class="inline-flex items-center justify-center px-8 py-3 rounded-xl font-semibold bg-gradient-to-r from-indigo-500 to-purple-600 hover:brightness-110 hover:scale-105 transition shadow-lg">
      ðŸš€ Join Server
    </a>

    <hr class="border-zinc-800 my-6"/>

    <h3 class="font-semibold mb-2">Reviews & Comments</h3>
    <div id="modalComments" class="flex flex-col gap-2 mb-4 max-h-60 overflow-y-auto"></div>

    <form id="commentForm" class="flex flex-col gap-3">
      <textarea name="comment" placeholder="Write a comment..."
        class="p-3 rounded-xl bg-zinc-800 border border-zinc-700 focus:border-white/20 outline-none"
        required></textarea>
      <button type="submit"
        class="bg-white text-black px-4 py-2 rounded-xl hover:bg-zinc-200 transition">
        Post Comment
      </button>
    </form>

    <button id="reportServerBtn"
      class="mt-4 bg-red-600 px-4 py-2 rounded-xl hover:bg-red-700 transition">
      Report Server
    </button>

  </div>
</div>

<!-- EDIT REQUEST MODAL -->
<div id="editRequestModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-6 z-50">
  <div class="bg-zinc-900 rounded-2xl p-8 max-w-3xl w-full relative border border-zinc-800">

    <button id="closeEditModal" class="absolute top-4 right-4 text-zinc-400 hover:text-white text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Request Server Edit</h2>

    <form id="editRequestForm" class="flex flex-col gap-4">

      <input name="name" placeholder="Server Name" class="p-2 rounded bg-zinc-800" required/>
      <textarea name="description" placeholder="Description" class="p-2 rounded bg-zinc-800" required></textarea>
      <input name="logo" placeholder="Logo URL" class="p-2 rounded bg-zinc-800" required/>
      <input name="website" placeholder="Website / Social Links" class="p-2 rounded bg-zinc-800"/>
      <input name="language" placeholder="Primary Language" class="p-2 rounded bg-zinc-800"/>
      <input name="members" type="number" placeholder="Approximate Members" class="p-2 rounded bg-zinc-800"/>
      <select name="type" class="p-2 rounded bg-zinc-800">
        <option value="">Server Type</option>
        <option value="gaming">Gaming</option>
        <option value="community">Community</option>
        <option value="education">Education</option>
        <option value="hobby">Hobby / Interest</option>
        <option value="other">Other</option>
      </select>

      <label class="flex items-center gap-2">
        <input type="checkbox" name="nsfw"/> NSFW
      </label>

      <label class="text-sm">Tags (up to 5):</label>
      <div id="editTagsContainer" class="flex gap-2 mb-2">
        <input type="text" id="editTagInput" class="p-2 rounded bg-zinc-800" placeholder="Enter tag" />
        <button type="button" id="addEditTagBtn" class="bg-zinc-600 px-4 py-2 rounded text-white">Add Tag</button>
      </div>
      <div id="editTagsList" class="flex flex-wrap gap-2 mb-4"></div>

      <button type="submit" class="bg-white text-black px-4 py-2 rounded hover:bg-zinc-200 transition">
        Submit Edit Request
      </button>
    </form>
  </div>
</div>

<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>Â© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
let servers = [];
let activeTag = 'all';
let currentServerId = null;
let editTags = [];

// --- AUTH ---
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');
let currentUser = userStr ? JSON.parse(userStr) : null;

// --- NAV LOGIN ---
const loginBtn = document.getElementById('loginBtn');
const adminBtn = document.getElementById('adminBtn');
const navLinks = document.getElementById('navLinks');

if (currentUser) {
  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.onclick = () => { localStorage.clear(); location.reload(); };

  // --- DROPDOWN ---
  const dropdownContainer = document.createElement('div');
  dropdownContainer.className = 'relative ml-2';

  const welcomeBtn = document.createElement('button');
  welcomeBtn.textContent = `Welcome, ${currentUser.discordUsername}`;
  welcomeBtn.className = 'text-sm text-zinc-300 mr-2 px-2 py-1 hover:bg-white/10 rounded transition';
  dropdownContainer.appendChild(welcomeBtn);

  const dropdownMenu = document.createElement('div');
  dropdownMenu.className = 'absolute right-0 mt-2 w-36 bg-zinc-900 border border-zinc-700 rounded shadow-lg text-sm text-white opacity-0 pointer-events-none transition-opacity';
  dropdownMenu.innerHTML = `
    <a href="profile.html" class="block px-4 py-2 hover:bg-zinc-700">View Profile</a>
    <a href="settings.html" class="block px-4 py-2 hover:bg-zinc-700">Settings</a>
  `;
  dropdownContainer.appendChild(dropdownMenu);

  // Toggle dropdown on click
  welcomeBtn.addEventListener('click', () => {
    const isOpen = dropdownMenu.classList.contains('opacity-100');
    if (isOpen) {
      dropdownMenu.classList.remove('opacity-100');
      dropdownMenu.classList.add('opacity-0', 'pointer-events-none');
    } else {
      dropdownMenu.classList.remove('opacity-0', 'pointer-events-none');
      dropdownMenu.classList.add('opacity-100');
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!dropdownContainer.contains(e.target)) {
      dropdownMenu.classList.remove('opacity-100');
      dropdownMenu.classList.add('opacity-0', 'pointer-events-none');
    }
  });

  navLinks.insertBefore(dropdownContainer, loginBtn);

  // Show admin button if applicable
  if (currentUser.role === 'admin') {
    adminBtn.classList.remove('hidden');
    adminBtn.href = 'dashboard.html';
  }
}

// --- LOAD SERVERS ---
async function loadServers() {
  const res = await fetch(`${API_URL}/api/servers`);
  servers = await res.json();
  renderServers();
}

// --- RENDER SERVERS ---
function renderServers() {
  const grid = document.getElementById('serversGrid');
  const search = document.getElementById('searchInput').value.toLowerCase();
  const nsfw = document.getElementById('nsfwToggle').checked;

  grid.innerHTML = '';

  const filtered = servers
    .filter(s => nsfw || !s.nsfw)
    .filter(s => activeTag === 'all' || s.tags.includes(activeTag))
    .filter(s =>
      s.name.toLowerCase().includes(search) ||
      s.description.toLowerCase().includes(search)
    );

  if (!filtered.length) {
    grid.innerHTML = '<div class="col-span-full text-center text-zinc-400 mt-10">No servers found</div>';
    return;
  }

  filtered.forEach(s => {
    let invite = s.invite || '';
    if (!invite.startsWith('http')) invite = 'https://discord.gg/' + invite.replace(/^discord\.gg\/?/i, '');
    const owner = s.submitterDiscord
      ? `${s.submitterDiscord.username}${s.submitterDiscord.tag ? '#' + s.submitterDiscord.tag : ''}`
      : 'Unknown';

const card = document.createElement('div');
card.className =
    'group bg-gradient-to-br from-black via-zinc-900 to-black border border-zinc-900 rounded-3xl overflow-hidden shadow-lg hover:shadow-2xl transition transform hover:scale-[1.02] cursor-pointer flex flex-col'
    
card.innerHTML = `
  <!-- HEADER -->
  <div class="relative px-6 pt-6 flex items-start justify-between">

    <div class="flex items-center gap-4">
      <!-- SERVER LOGO -->
      <img src="${s.logo}" alt="${s.name}"
        class="w-14 h-14 rounded-2xl object-cover shadow-xl bg-black" />

      <!-- NAME + STATUS -->
      <div class="flex flex-col">
        <div class="flex items-center gap-3">
          <span class="w-3 h-3 bg-green-500 rounded-full"></span>
          <h3 class="text-2xl font-bold text-white truncate">
            ${s.name}
          </h3>
        </div>
      </div>
    </div>

  </div>

  <!-- CONTENT -->
  <div class="px-6 pb-6 pt-4 flex flex-col gap-4">

    <!-- TAGS -->
    <div class="flex flex-wrap gap-2">
      ${(s.tags || []).map(tag => `
        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-[#2a2d3d] text-white">
          ${tag.toUpperCase()}
        </span>
      `).join('')}
    </div>

    <!-- DESCRIPTION -->
    <p class="text-sm text-zinc-300 leading-relaxed line-clamp-3">
      ${s.description}
    </p>

    <!-- DIVIDER -->
    <div class="border-t border-[#2a2d3d]"></div>

    <!-- FOOTER -->
    <div class="flex items-center justify-between">
      <span class="text-xs text-zinc-400 members-count" data-id="${s.discordServerId}">
        ${s.members != null ? s.members.toLocaleString() : 'N/A'} members
      </span>

      <a href="${invite}" target="_blank"
        class="px-6 py-2 rounded-full bg-[#2b2f42] hover:bg-[#3a3f5c] font-bold tracking-wide transition">
        JOIN âžœ
      </a>
    </div>

  </div>
`;

card.onclick = e => {
  if (e.target.tagName !== 'A') {
    window.location.href = `server.html?guildid=${s._id}`;
  }
};


grid.appendChild(card); // <-- you were missing this

}); 
} 

// --- OPEN SERVER MODAL ---
async function openServerModal(id) {
  currentServerId = id;
  const res = await fetch(`${API_URL}/api/servers/${id}`);
  const server = await res.json();

  document.getElementById('modalLogo').src = server.logo;
  document.getElementById('modalName').textContent = server.name;
  document.getElementById('modalDescription').textContent = server.description;
  document.getElementById('modalTags').textContent = 'Tags: ' + server.tags.join(', ');
  const owner = server.submitterDiscord;
  document.getElementById('modalOwner').textContent = owner ? `Server Owner: ${owner.username}${owner.tag ? '#' + owner.tag : ''} (${owner.userID})` : 'Server Owner: Unknown';
  document.getElementById('modalInvite').href = server.invite.startsWith('http') ? server.invite : 'https://discord.gg/' + server.invite.replace(/^discord\.gg\/?/i, '');
  
  const comments = document.getElementById('modalComments');
  comments.innerHTML = '';
  server.comments.forEach(c => {
    const div = document.createElement('div');
    div.className = 'bg-zinc-800 p-3 rounded-xl text-sm';
    div.textContent = `${c.user}: ${c.text}`;
    comments.appendChild(div);
  });

  document.getElementById('serverModal').classList.remove('hidden');

  // --- REQUEST EDIT BUTTON ---
  const existingBtn = document.getElementById('requestEditBtn');
  if (existingBtn) existingBtn.remove();
  if (currentUser && owner && currentUser.discordUserID === owner.userID) {
    const btn = document.createElement('button');
    btn.id = 'requestEditBtn';
    btn.textContent = 'Request Edit';
    btn.className = 'mt-4 bg-indigo-600 px-4 py-2 rounded-xl hover:bg-indigo-700 transition';
    btn.onclick = () => openEditRequestModal(server);
    document.querySelector('#serverModal > div').appendChild(btn);
  }
}

// --- CLOSE SERVER MODAL ---
document.getElementById('closeModal').onclick = () => document.getElementById('serverModal').classList.add('hidden');

// --- OPEN EDIT REQUEST MODAL ---
function openEditRequestModal(server) {
  const modal = document.getElementById('editRequestModal');
  const form = document.getElementById('editRequestForm');
  form.name.value = server.name;
  form.description.value = server.description;
  form.logo.value = server.logo;
  form.website.value = server.website || '';
  form.language.value = server.language || '';
  form.members.value = server.members || '';
  form.type.value = server.type || '';
  form.nsfw.checked = server.nsfw || false;

  editTags = [...server.tags];
  renderEditTags();
  modal.classList.remove('hidden');
}

// --- CLOSE EDIT MODAL ---
document.getElementById('closeEditModal').onclick = () => document.getElementById('editRequestModal').classList.add('hidden');

// --- EDIT TAGS HANDLING ---
const editTagInput = document.getElementById('editTagInput');
const addEditTagBtn = document.getElementById('addEditTagBtn');
const editTagsList = document.getElementById('editTagsList');

addEditTagBtn.onclick = () => {
  const value = editTagInput.value.trim().toLowerCase();
  if(value && !editTags.includes(value) && editTags.length < 5) {
    editTags.push(value); renderEditTags();
  }
  editTagInput.value = '';
};
function renderEditTags() {
  editTagsList.innerHTML = '';
  editTags.forEach(tag => {
    const span = document.createElement('span');
    span.className = 'bg-zinc-700 px-3 py-1 rounded flex items-center gap-1';
    span.textContent = tag;
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'Ã—';
    removeBtn.onclick = () => { editTags = editTags.filter(t => t!==tag); renderEditTags(); };
    span.appendChild(removeBtn);
    editTagsList.appendChild(span);
  });
}

// --- SUBMIT EDIT REQUEST ---
document.getElementById('editRequestForm').onsubmit = async e => {
  e.preventDefault();
  if(!token) return alert('Login required.');
  const form = e.target;
  const payload = {
    name: form.name.value.trim(),
    description: form.description.value.trim(),
    logo: form.logo.value.trim(),
    website: form.website.value.trim(),
    language: form.language.value.trim(),
    members: form.members.value,
    type: form.type.value,
    nsfw: form.nsfw.checked,
    tags: editTags
  };
  try {
    const res = await fetch(`${API_URL}/api/servers/${currentServerId}/request-edit`, {
      method:'POST',
      headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) return alert(data.error || 'Failed to submit edit request');
    alert('Edit request submitted! Staff will review it.');
    document.getElementById('editRequestModal').classList.add('hidden');
  } catch(err) { console.error(err); alert('Failed to submit edit request'); }
};

// --- COMMENT FORM ---
document.getElementById('commentForm').onsubmit = async e => {
  e.preventDefault();
  if(!token) return alert('Login required to comment.');
  const text = e.target.comment.value.trim();
  if(!text) return;
  await fetch(`${API_URL}/api/servers/${currentServerId}/comments`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
    body: JSON.stringify({ text })
  });
  e.target.reset();
  openServerModal(currentServerId);
};

// --- REPORT SERVER ---
document.getElementById('reportServerBtn').onclick = async () => {
  if(!token) return alert('Login required to report servers.');
  const reason = prompt('Why are you reporting this server?');
  if(!reason) return;
  await fetch(`${API_URL}/api/servers/${currentServerId}/report`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
    body: JSON.stringify({ reason })
  });
  alert('Server reported successfully.');
};

// --- SEARCH & NSFW ---
document.getElementById('searchInput').oninput = renderServers;
document.getElementById('nsfwToggle').onchange = renderServers;

loadServers();
</script>



<div id="t" style="
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s ease;
  z-index:9999;
">
 <img id="tl" src="assets/opslinkservers.png" style="
    width:180px;
    opacity:0;
    transform:scale(0.8);
    filter:drop-shadow(0 0 0 rgba(80,200,255,0));
    transition:opacity .3s ease, transform .6s ease, filter .6s ease;
  ">
</div>

<script>
document.addEventListener('click', e => {
  const a = e.target.closest('a');
  if(!a) return;
  const h = a.getAttribute('href');
  if(!h || h.startsWith('#') || h.startsWith('http') || a.target) return;

  e.preventDefault();

  t.style.opacity = 1;
  t.style.pointerEvents = 'all';

  // Animate logo: scale up and glow
  tl.style.opacity = 1;
  tl.style.transform = 'scale(1.05)';
  tl.style.filter = 'drop-shadow(0 0 25px rgba(80,200,255,0.8))';

  // subtle pulse after first scale
  setTimeout(() => {
    tl.style.transform = 'scale(1)';
    tl.style.filter = 'drop-shadow(0 0 40px rgba(80,200,255,1))';
  }, 300);

  // go to next page after 1 second
  setTimeout(() => location.href = h, 1000);
});
</script>

</body>
</html>
