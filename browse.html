<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Browse Servers - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

<!-- ================= NAVBAR ================= -->
<nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold">OpsLink Servers</div>
  <div id="navLinks" class="flex items-center gap-8 text-sm">
    <a href="index.html">Home</a>
    <a href="browse.html">Browse</a>
    <a href="submit.html">Submit</a>
    <a href="messages.html">Messages</a>
    <a href="support.html">Support</a>
    <a href="login.html" id="loginBtn"
      class="rounded-full border border-white/20 px-4 py-2 hover:bg-white/10">
      Login
    </a>
    <a href="dashboard.html" id="adminBtn"
      class="hidden rounded-full bg-gradient-to-r from-red-600 to-red-500 px-4 py-2">
      Admin Dashboard
    </a>
  </div>
</nav>

<!-- ================= PAGE ================= -->
<section class="px-10 py-10">
  <h1 class="text-5xl font-bold mb-6">Browse Servers</h1>

  <!-- SEARCH / NSFW -->
  <div class="flex flex-wrap gap-4 mb-4 items-center">
    <input id="searchInput"
      placeholder="Search servers..."
      class="flex-grow p-3 rounded-xl bg-zinc-900 border border-zinc-800 outline-none"/>
    <label class="flex items-center gap-2 text-sm">
      <input type="checkbox" id="nsfwToggle"/> Show NSFW
    </label>
  </div>

  <!-- TAG FILTER -->
  <button id="toggleTagFilter"
    class="text-sm text-zinc-400 hover:text-white mb-2">
    Filter by tags
  </button>
  <div id="tagFilterBar" class="flex flex-wrap gap-2 mb-6 hidden"></div>

  <!-- GRID -->
  <div id="serversGrid"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
</section>

<!-- ================= SERVER MODAL ================= -->
<div id="serverModal"
  class="fixed inset-0 hidden flex items-center justify-center bg-black/80 p-6 z-50">
  <div class="bg-zinc-900 rounded-2xl p-8 max-w-3xl w-full relative border border-zinc-800">

    <button id="closeModal"
      class="absolute top-4 right-4 text-2xl text-zinc-400 hover:text-white">
      &times;
    </button>

    <div class="flex gap-4 mb-4">
      <img id="modalLogo"
        class="w-20 h-20 rounded-full bg-black border border-zinc-700 object-contain"/>
      <div>
        <h2 id="modalName" class="text-3xl font-bold"></h2>
        <p id="modalTags" class="text-xs text-zinc-400"></p>
        <p id="modalOwner" class="text-xs text-zinc-400"></p>
      </div>
    </div>

    <p id="modalDescription" class="text-zinc-300 mb-4"></p>

    <a id="modalInvite" target="_blank"
      class="inline-flex px-6 py-3 rounded-xl bg-indigo-600 font-semibold mb-4">
      üöÄ Join Server
    </a>

    <!-- RATING -->
    <div class="flex items-center gap-4 mb-4">
      <button id="likeBtn"
        class="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-green-600">
        üëç Like
      </button>
      <button id="dislikeBtn"
        class="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-red-600">
        üëé Dislike
      </button>
      <span id="ratingScore" class="text-sm text-zinc-300"></span>
    </div>

    <hr class="border-zinc-800 my-4"/>

    <!-- COMMENTS -->
    <h3 class="font-semibold mb-2">Comments</h3>
    <div id="modalComments"
      class="flex flex-col gap-2 mb-4 max-h-60 overflow-y-auto"></div>

    <form id="commentForm" class="flex flex-col gap-2">
      <textarea name="comment"
        class="p-2 rounded bg-zinc-800"
        placeholder="Write a comment..." required></textarea>
      <button class="bg-white text-black px-4 py-2 rounded">
        Post Comment
      </button>
    </form>

    <button id="reportServerBtn"
      class="mt-4 bg-red-600 px-4 py-2 rounded-xl">
      Report Server
    </button>
  </div>
</div>

<!-- ================= EDIT REQUEST MODAL ================= -->
<div id="editRequestModal"
  class="fixed inset-0 hidden flex items-center justify-center bg-black/80 p-6 z-50">
  <div class="bg-zinc-900 rounded-2xl p-8 max-w-3xl w-full relative border border-zinc-800">

    <button id="closeEditModal"
      class="absolute top-4 right-4 text-2xl">&times;</button>

    <h2 class="text-2xl font-bold mb-4">Request Server Edit</h2>

    <form id="editRequestForm" class="flex flex-col gap-3">
      <input name="name" class="p-2 rounded bg-zinc-800" required/>
      <textarea name="description" class="p-2 rounded bg-zinc-800" required></textarea>
      <input name="logo" class="p-2 rounded bg-zinc-800" required/>
      <input name="website" class="p-2 rounded bg-zinc-800"/>
      <input name="language" class="p-2 rounded bg-zinc-800"/>
      <input name="members" type="number" class="p-2 rounded bg-zinc-800"/>

      <label class="flex gap-2 items-center">
        <input type="checkbox" name="nsfw"/> NSFW
      </label>

      <div class="flex gap-2">
        <input id="editTagInput"
          class="p-2 rounded bg-zinc-800 flex-grow"
          placeholder="Add tag"/>
        <button type="button" id="addEditTagBtn"
          class="bg-zinc-600 px-4 py-2 rounded">
          Add
        </button>
      </div>

      <div id="editTagsList" class="flex flex-wrap gap-2"></div>

      <button class="bg-white text-black px-4 py-2 rounded">
        Submit Edit Request
      </button>
    </form>
  </div>
</div>

<!-- ================= FOOTER ================= -->
<footer class="px-10 py-6 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>¬© 2026 OpsLink</span>
  <span>Not affiliated with Discord</span>
</footer>

<!-- ================= SCRIPT ================= -->
<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';

let servers = [];
let activeTag = 'all';
let currentServerId = null;
let editTags = [];

const token = localStorage.getItem('token');
const currentUser = JSON.parse(localStorage.getItem('user') || 'null');

/* ================= AUTH UI ================= */
const loginBtn = document.getElementById('loginBtn');
const adminBtn = document.getElementById('adminBtn');

if (currentUser) {
  loginBtn.textContent = 'Logout';
  loginBtn.onclick = () => {
    localStorage.clear();
    location.reload();
  };
  if (currentUser.role === 'admin') {
    adminBtn.classList.remove('hidden');
  }
}

/* ================= LOAD ================= */
async function loadServers() {
  const res = await fetch(API_URL + '/api/servers');
  servers = await res.json();
  buildTagFilters();
  renderServers();
}

/* ================= TAG FILTERS ================= */
function buildTagFilters() {
  const tags = new Set();
  servers.forEach(s => (s.tags || []).forEach(t => tags.add(t)));

  tagFilterBar.innerHTML =
    `<button data-tag="all" class="px-3 py-1 bg-zinc-800 rounded-full">All</button>` +
    [...tags].map(t =>
      `<button data-tag="${t}" class="px-3 py-1 bg-zinc-800 rounded-full">#${t}</button>`
    ).join('');

  tagFilterBar.querySelectorAll('button').forEach(btn => {
    btn.onclick = () => {
      activeTag = btn.dataset.tag;
      renderServers();
    };
  });
}

toggleTagFilter.onclick = () =>
  tagFilterBar.classList.toggle('hidden');

/* ================= RENDER ================= */
function renderServers() {
  serversGrid.innerHTML = '';
  const search = searchInput.value.toLowerCase();

  servers
    .filter(s => nsfwToggle.checked || !s.nsfw)
    .filter(s => activeTag === 'all' || (s.tags || []).includes(activeTag))
    .filter(s =>
      s.name.toLowerCase().includes(search) ||
      s.description.toLowerCase().includes(search)
    )
    .sort((a,b) => (b.score||0)-(a.score||0))
    .forEach(s => {
      const featured = (s.score || 0) >= 10;
      const div = document.createElement('div');
      div.className =
        'bg-zinc-900 border border-zinc-800 rounded-2xl p-5 cursor-pointer';

      div.innerHTML = `
        ${featured ? `<span class="text-xs text-yellow-400">‚≠ê Featured</span>` : ''}
        <h3 class="text-lg font-semibold">${s.name}</h3>
        <p class="text-sm text-zinc-400">Score: ${s.score || 0}</p>
      `;
      div.onclick = () => openServerModal(s._id);
      serversGrid.appendChild(div);
    });
}

/* ================= MODAL ================= */
async function openServerModal(id) {
  currentServerId = id;
  const s = await fetch(API_URL + '/api/servers/' + id).then(r=>r.json());

  modalLogo.src = s.logo;
  modalName.textContent = s.name;
  modalDescription.textContent = s.description;
  modalTags.textContent = 'Tags: ' + (s.tags||[]).join(', ');
  modalOwner.textContent = s.submitterDiscord
    ? `Owner: ${s.submitterDiscord.username}`
    : 'Owner: Unknown';

  modalInvite.href = s.invite.startsWith('http')
    ? s.invite
    : 'https://discord.gg/' + s.invite;

  ratingScore.textContent = `Score: ${s.score || 0}`;

  modalComments.innerHTML = '';
  (s.comments||[]).forEach(c=>{
    const d=document.createElement('div');
    d.className='bg-zinc-800 p-2 rounded';
    d.textContent=`${c.user}: ${c.text}`;
    modalComments.appendChild(d);
  });

  const existing = document.getElementById('requestEditBtn');
  if (existing) existing.remove();

  if (
    currentUser &&
    s.submitterDiscord &&
    currentUser.userID === s.submitterDiscord.userID
  ) {
    const btn = document.createElement('button');
    btn.id='requestEditBtn';
    btn.textContent='Request Edit';
    btn.className='mt-4 bg-indigo-600 px-4 py-2 rounded';
    btn.onclick=()=>openEditRequestModal(s);
    serverModal.querySelector('div').appendChild(btn);
  }

  serverModal.classList.remove('hidden');
}

closeModal.onclick=()=>serverModal.classList.add('hidden');

/* ================= RATING ================= */
async function rate(value) {
  if (!token) return alert('Login required.');

  const res = await fetch(`${API_URL}/api/servers/${currentServerId}/rate`,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      Authorization:`Bearer ${token}`
    },
    body:JSON.stringify({value})
  });

  const data = await res.json();
  ratingScore.textContent = `Score: ${data.score}`;
  loadServers();
}

likeBtn.onclick=()=>rate(1);
dislikeBtn.onclick=()=>rate(-1);

/* ================= COMMENTS ================= */
commentForm.onsubmit=async e=>{
  e.preventDefault();
  if(!token) return alert('Login required.');
  await fetch(`${API_URL}/api/servers/${currentServerId}/comments`,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      Authorization:`Bearer ${token}`
    },
    body:JSON.stringify({text:e.target.comment.value})
  });
  e.target.reset();
  openServerModal(currentServerId);
};

/* ================= REPORT ================= */
reportServerBtn.onclick=async()=>{
  if(!token) return alert('Login required.');
  const reason=prompt('Reason?');
  if(!reason) return;
  await fetch(`${API_URL}/api/servers/${currentServerId}/report`,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      Authorization:`Bearer ${token}`
    },
    body:JSON.stringify({reason})
  });
  alert('Reported.');
};

/* ================= EDIT TAGS ================= */
addEditTagBtn.onclick=()=>{
  const v=editTagInput.value.trim().toLowerCase();
  if(v&&!editTags.includes(v)&&editTags.length<5){
    editTags.push(v);
    renderEditTags();
  }
  editTagInput.value='';
};

function renderEditTags(){
  editTagsList.innerHTML='';
  editTags.forEach(t=>{
    const s=document.createElement('span');
    s.className='bg-zinc-700 px-3 py-1 rounded flex gap-1';
    s.textContent=t;
    const b=document.createElement('button');
    b.textContent='√ó';
    b.onclick=()=>{editTags=editTags.filter(x=>x!==t);renderEditTags();};
    s.appendChild(b);
    editTagsList.appendChild(s);
  });
}

function openEditRequestModal(s){
  editRequestForm.name.value=s.name;
  editRequestForm.description.value=s.description;
  editRequestForm.logo.value=s.logo;
  editRequestForm.website.value=s.website||'';
  editRequestForm.language.value=s.language||'';
  editRequestForm.members.value=s.members||'';
  editRequestForm.nsfw.checked=s.nsfw||false;
  editTags=[...(s.tags||[])];
  renderEditTags();
  editRequestModal.classList.remove('hidden');
}

closeEditModal.onclick=()=>editRequestModal.classList.add('hidden');

editRequestForm.onsubmit=async e=>{
  e.preventDefault();
  if(!token) return alert('Login required.');
  await fetch(`${API_URL}/api/servers/${currentServerId}/request-edit`,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      Authorization:`Bearer ${token}`
    },
    body:JSON.stringify({
      name:e.target.name.value,
      description:e.target.description.value,
      logo:e.target.logo.value,
      website:e.target.website.value,
      language:e.target.language.value,
      members:e.target.members.value,
      nsfw:e.target.nsfw.checked,
      tags:editTags
    })
  });
  alert('Edit request sent.');
  editRequestModal.classList.add('hidden');
};

/* ================= EVENTS ================= */
searchInput.oninput=renderServers;
nsfwToggle.onchange=renderServers;

/* ================= INIT ================= */
loadServers();
</script>

</body>
</html>
