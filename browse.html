<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Browse Servers - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
  <div class="flex items-center gap-8 text-sm" id="navLinks">
    <a href="index.html">Home</a>
    <a href="browse.html">Browse</a>
    <a href="submit.html">Submit</a>
    <a href="messages.html">Messages</a>
    <a href="support.html">Support</a>
    <a href="login.html" id="loginBtn"
      class="rounded-full border border-white/20 px-4 py-2 hover:bg-white/10 transition">Login</a>
  </div>
</nav>

<section class="px-10 py-10">

  <h1 class="text-5xl font-bold mb-6">Browse Servers</h1>

  <!-- SEARCH / FILTERS -->
  <div class="flex flex-wrap gap-4 mb-6 items-center">
    <input id="searchInput" type="text" placeholder="Search servers..."
      class="p-3 rounded-xl bg-zinc-900 border border-zinc-800 flex-grow outline-none"/>

    <select id="tagFilter"
      class="p-3 rounded-xl bg-zinc-900 border border-zinc-800">
      <option value="all">All Tags</option>
    </select>

    <button id="filterBtn"
      class="px-5 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 transition">
      Filter
    </button>

    <label class="flex items-center gap-2 text-sm">
      <input type="checkbox" id="nsfwToggle"/> Show NSFW
    </label>
  </div>

  <!-- SERVERS GRID -->
  <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>

</section>

<!-- SERVER MODAL -->
<div id="serverModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-6 z-50">
  <div class="bg-zinc-900 rounded-2xl p-8 max-w-3xl w-full relative border border-zinc-800">

    <button id="closeModal" class="absolute top-4 right-4 text-zinc-400 hover:text-white text-2xl">&times;</button>

    <div class="flex items-center gap-4 mb-4">
      <div class="w-20 h-20 rounded-full border border-zinc-700 bg-zinc-950 flex items-center justify-center overflow-hidden">
        <img id="modalLogo" class="max-w-full max-h-full object-contain"/>
      </div>
      <div>
        <h2 id="modalName" class="text-3xl font-bold"></h2>
        <p id="modalTags" class="text-xs text-zinc-400"></p>
      </div>
    </div>

    <p id="modalDescription" class="text-zinc-300 mb-4"></p>

    <!-- RATING -->
    <div class="flex gap-1 mb-6 items-center">
      <div id="ratingStars" class="flex gap-1 text-3xl text-yellow-400"></div>
      <span id="ratingValue" class="text-sm text-zinc-400 ml-2"></span>
    </div>

    <a id="modalInvite" target="_blank"
      class="inline-flex px-8 py-3 rounded-xl font-semibold bg-gradient-to-r from-indigo-500 to-purple-600 hover:brightness-110 transition">
      ðŸš€ Join Server
    </a>

  </div>
</div>

<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>Â© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';

let servers = [];
let activeTag = 'all';

// LOAD SERVERS
async function loadServers() {
  const res = await fetch(`${API_URL}/api/servers`);
  servers = await res.json();
  buildTagFilter();
  renderServers();
}

// BUILD TAG FILTER DROPDOWN
function buildTagFilter() {
  const tags = new Set();
  servers.forEach(s => (s.tags || []).forEach(t => tags.add(t)));

  const dropdown = document.getElementById('tagFilter');
  dropdown.innerHTML = `<option value="all">All Tags</option>`;

  tags.forEach(tag => {
    const opt = document.createElement('option');
    opt.value = tag;
    opt.textContent = `#${tag}`;
    dropdown.appendChild(opt);
  });
}

// SORT SERVERS BY RATING
function sortServers(list) {
  return list.sort((a, b) => (b.rating || 0) - (a.rating || 0));
}

// RENDER SERVERS GRID
function renderServers() {
  const grid = document.getElementById('serversGrid');
  const search = document.getElementById('searchInput').value.toLowerCase();
  const nsfw = document.getElementById('nsfwToggle').checked;

  grid.innerHTML = '';

  let filtered = servers
    .filter(s => nsfw || !s.nsfw)
    .filter(s => activeTag === 'all' || (s.tags || []).includes(activeTag))
    .filter(s =>
      s.name.toLowerCase().includes(search) ||
      s.description.toLowerCase().includes(search)
    );

  filtered = sortServers(filtered);

  if (!filtered.length) {
    grid.innerHTML = '<div class="col-span-full text-center text-zinc-400 mt-10">No servers found</div>';
    return;
  }

  filtered.forEach(s => {
    const card = document.createElement('div');
    card.className =
      'group bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden hover:scale-[1.03] transition cursor-pointer';

    card.innerHTML = `
      <div class="h-44 bg-black flex items-center justify-center">
        <img src="${s.logo}" class="max-h-full"/>
      </div>

      <div class="p-5 space-y-2">
        <h3 class="text-lg font-semibold">${s.name}</h3>
        <p class="text-sm text-zinc-400 line-clamp-2">${s.description}</p>

        <div class="flex items-center gap-1 text-yellow-400">
          ${renderStars(s.rating || 0)}
          <span class="text-xs text-zinc-500 ml-1">(${s.rating || 0}/5)</span>
        </div>

        <div class="flex flex-wrap gap-1">
          ${(s.tags || []).map(t => `<span class="px-2 py-0.5 text-xs bg-zinc-800 rounded-full">#${t}</span>`).join('')}
        </div>

        <div class="flex justify-between items-center pt-2">
          <span class="text-xs text-zinc-500">${s.members || 0} members</span>
          <span class="text-indigo-400 text-sm font-semibold">View â†’</span>
        </div>
      </div>
    `;

    card.onclick = () => openServerModal(s);
    grid.appendChild(card);
  });
}

// STAR RENDERER
function renderStars(rating) {
  let out = '';
  for (let i = 1; i <= 5; i++) {
    out += i <= rating ? 'â˜…' : 'â˜†';
  }
  return out;
}

// OPEN MODAL
function openServerModal(server) {
  document.getElementById('modalLogo').src = server.logo;
  document.getElementById('modalName').textContent = server.name;
  document.getElementById('modalDescription').textContent = server.description;
  document.getElementById('modalTags').textContent = 'Tags: ' + (server.tags || []).join(', ');

  document.getElementById('modalInvite').href =
    server.invite.startsWith('http')
      ? server.invite
      : 'https://discord.gg/' + server.invite.replace(/^discord\.gg\/?/i, '');

  const stars = document.getElementById('ratingStars');
  const ratingValue = document.getElementById('ratingValue');
  stars.innerHTML = '';
  ratingValue.textContent = `(${server.rating || 0}/5)`;

  for (let i = 1; i <= 5; i++) {
    const star = document.createElement('span');
    star.textContent = i <= (server.rating || 0) ? 'â˜…' : 'â˜†';
    star.className = 'cursor-pointer';
    star.onclick = () => rateServer(server._id, i);
    stars.appendChild(star);
  }

  document.getElementById('serverModal').classList.remove('hidden');
}

document.getElementById('closeModal').onclick = () =>
  document.getElementById('serverModal').classList.add('hidden');

// RATE SERVER
async function rateServer(id, stars) {
  const token = localStorage.getItem('token');
  if (!token) return alert('Login required to rate servers');

  await fetch(`${API_URL}/api/servers/${id}/rate`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ stars })
  });

  loadServers();
}

// FILTER EVENTS
document.getElementById('filterBtn').onclick = () => {
  activeTag = document.getElementById('tagFilter').value;
  renderServers();
};

document.getElementById('searchInput').oninput = renderServers;
document.getElementById('nsfwToggle').onchange = renderServers;

loadServers();
</script>

</body>
</html>
