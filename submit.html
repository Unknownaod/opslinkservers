<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Server - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-10 py-6">
    <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
    <div class="flex items-center gap-8 text-sm" id="navLinks">
      <a href="index.html" class="hover:opacity-80">Home</a>
      <a href="browse.html" class="hover:opacity-80">Browse</a>
      <a href="submit.html" class="hover:opacity-80">Submit</a>
      <a href="messages.html" class="hover:opacity-80">Messages</a>
      <a href="support.html" class="hover:opacity-80">Support</a>
      <a href="login.html" id="loginBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Login</a>
      <a href="#" id="adminBtn" class="hidden rounded-full bg-red-600 text-white px-4 py-2 hover:bg-red-700">Admin Dashboard</a>
    </div>
  </nav>

  <section class="px-10 py-10 max-w-2xl mx-auto">
    <h1 class="text-5xl font-bold mb-6">Submit Your Discord Server</h1>

    <!-- Instructions & Rules -->
    <div class="bg-zinc-800 p-4 rounded text-zinc-300 mb-6">
      <h2 class="font-semibold mb-2">Submission Rules & Responsibilities</h2>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li>You must be the <strong>server owner</strong> or an <strong>authorized representative</strong>.</li>
        <li>All information submitted must be <strong>accurate and truthful</strong>.</li>
        <li>If your server is approved, <strong>you are responsible for its content, moderation, and community management</strong>.</li>
        <li>OpsLink Servers reserves the right to remove your server if it violates our guidelines.</li>
        <li>NSFW content must be properly labeled, or your server will be denied.</li>
        <li><strong>You must have our bot added to your server</strong> for live statistics (member count, online users) to work. Without it, your server submission may be denied.</li>
      </ul>
    </div>

    <!-- Submission Form -->
    <div class="bg-zinc-900/80 border border-zinc-800 p-6 rounded">
      <form id="submitForm" class="flex flex-col gap-4">

        <!-- Basic Info -->
        <input name="name" placeholder="Server Name" class="p-2 rounded bg-zinc-800" required/>
        <input name="invite" placeholder="Server Invite Link" class="p-2 rounded bg-zinc-800" required/>
        <textarea name="description" placeholder="Brief Description" class="p-2 rounded bg-zinc-800" required></textarea>

        <!-- Discord Bot Info -->
        <div class="bg-zinc-700 p-3 rounded text-sm mb-4">
          <p>To enable live statistics, you must add our bot to your server:</p>
          <a href="https://discord.com/oauth2/authorize?client_id=1466430352238055587&permissions=524288&integration_type=0&scope=bot"
             target="_blank"
             class="text-indigo-400 hover:underline">
            Add the OpsLink Bot
          </a>
          <p class="mt-2">Once added, enter your server's <strong>Discord Server ID</strong> below:</p>
          <input name="discordServerId" placeholder="Discord Server ID" class="p-2 rounded bg-zinc-800" required/>
        </div>

        <!-- Advanced Server Info -->
        <input name="language" placeholder="Primary Language (e.g., English)" class="p-2 rounded bg-zinc-800"/>
        <input name="members" type="number" placeholder="Approximate Number of Members" class="p-2 rounded bg-zinc-800"/>
        <select name="type" class="p-2 rounded bg-zinc-800">
          <option value="">Server Type</option>
          <option value="gaming">Gaming</option>
          <option value="community">Community</option>
          <option value="education">Education</option>
          <option value="hobby">Hobby / Interest</option>
          <option value="other">Other</option>
        </select>
        <textarea name="rules" placeholder="Server Rules (Optional)" class="p-2 rounded bg-zinc-800"></textarea>
        <input name="website" placeholder="Website / Social Links (Optional)" class="p-2 rounded bg-zinc-800"/>
        <label class="flex items-center gap-2">
          <input type="checkbox" name="nsfw"/> NSFW
        </label>

        <!-- Server Logo -->
        <label class="flex flex-col gap-2">
          Server Logo <span class="text-red-500">*</span>
          <input type="url" name="logo" id="logoInput" placeholder="https://example.com/logo.png" class="p-2 rounded bg-zinc-800 text-white" required/>
          <div id="logoPreviewContainer" class="mt-2 w-32 h-32 border-2 border-zinc-700 rounded overflow-hidden hidden">
            <img id="logoPreview" class="w-full h-full object-cover" alt="Logo Preview"/>
          </div>
        </label>

        <!-- Tags -->
        <label class="text-sm">Tags (up to 5 tags):</label>
        <div id="tagsContainer" class="flex gap-2 mb-4">
          <input type="text" id="tagInput" class="p-2 rounded bg-zinc-800" placeholder="Enter tag" />
          <button type="button" id="addTagBtn" class="bg-zinc-600 px-4 py-2 rounded text-white">Add Tag</button>
        </div>
        <div id="tagsList" class="flex flex-wrap gap-2 mb-4"></div>

        <!-- Acknowledgment -->
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" name="acknowledge" required/>
          I confirm I am the server owner or authorized representative and understand all responsibilities.
        </label>

        <button type="submit" class="bg-white text-black px-4 py-2 rounded hover:bg-zinc-200">Submit Server</button>
      </form>
    </div>
  </section>

  <!-- Footer -->
  <footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
    <span>© 2026 OpsLink Servers</span>
    <span>Not affiliated with Discord</span>
  </footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
let tags = [];
let currentUser = null;

const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');
const loginBtn = document.getElementById('loginBtn');
const adminBtn = document.getElementById('adminBtn');
const navLinks = document.getElementById('navLinks');

if (token && userStr) {
  currentUser = JSON.parse(userStr);
  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.onclick = () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.reload();
  };

  const welcomeSpan = document.createElement('span');
  welcomeSpan.textContent = `Welcome, ${currentUser.discordUsername}`;
  welcomeSpan.className = "text-sm text-zinc-300";
  navLinks.insertBefore(welcomeSpan, loginBtn);

  if (currentUser.role === 'admin') {
    adminBtn.classList.remove('hidden');
    adminBtn.href = 'dashboard.html';
  }
}

// ---------------- TAGS ----------------
const tagInput = document.getElementById('tagInput');
const addTagBtn = document.getElementById('addTagBtn');
const tagsList = document.getElementById('tagsList');

addTagBtn.onclick = () => {
  const value = tagInput.value.trim();
  if (value && !tags.includes(value) && tags.length < 5) {
    tags.push(value);
    renderTags();
  }
  tagInput.value = '';
};

function renderTags() {
  tagsList.innerHTML = '';
  tags.forEach(tag => {
    const span = document.createElement('span');
    span.className = 'bg-zinc-700 px-3 py-1 rounded flex items-center gap-1';
    span.textContent = tag;

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = '×';
    removeBtn.onclick = () => {
      tags = tags.filter(t => t !== tag);
      renderTags();
    };

    span.appendChild(removeBtn);
    tagsList.appendChild(span);
  });
}

// ---------------- LOGO PREVIEW ----------------
const logoInput = document.getElementById('logoInput');
const logoPreview = document.getElementById('logoPreview');
const logoPreviewContainer = document.getElementById('logoPreviewContainer');

logoInput.addEventListener('input', () => {
  const url = logoInput.value.trim();
  if (url) {
    logoPreview.src = url;
    logoPreviewContainer.classList.remove('hidden');
  } else {
    logoPreview.src = '';
    logoPreviewContainer.classList.add('hidden');
  }
});

// ---------------- SUBMIT ----------------
document.getElementById('submitForm').addEventListener('submit', async e => {
  e.preventDefault();

  if (!currentUser || !token) {
    alert('You must be logged in.');
    return (window.location.href = 'login.html');
  }

  const payload = {
    name: e.target.name.value.trim(),
    invite: e.target.invite.value.trim(),
    description: e.target.description.value.trim(),
    language: e.target.language.value.trim(),
    members: e.target.members.value,
    type: e.target.type.value,
    rules: e.target.rules.value.trim(),
    website: e.target.website.value.trim(),
    logo: logoInput.value.trim(),
    nsfw: e.target.nsfw.checked,
    tags: tags,
    discordServerId: e.target.discordServerId.value.trim() // required for bot
  };

  if (!payload.logo) return alert('Server logo is required.');
  if (!payload.discordServerId) return alert('You must add the OpsLink bot and provide your server ID.');

  try {
    const res = await fetch(`${API_URL}/api/servers`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) return alert(data.error || 'Submission failed');

    alert('Server submitted! Awaiting approval.');
    e.target.reset();
    tags = [];
    renderTags();
    logoPreviewContainer.classList.add('hidden');

  } catch (err) {
    console.error(err);
    alert('Submission failed.');
  }
});
</script>

<div id="transition-root"></div>
<script>
  fetch('/transition.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('transition-root').innerHTML = html;
    });
</script>
  
</body>
</html>
