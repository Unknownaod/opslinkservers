<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

<!-- ================= NAVBAR ================= -->
<nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold">OpsLink Admin Dashboard</div>
  <div class="flex items-center gap-8 text-sm">
    <a href="index.html" class="hover:opacity-80">Home</a>
    <button id="logoutBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">
      Logout
    </button>
  </div>
</nav>

<!-- ================= SERVERS ================= -->
<section class="px-10 py-10">
  <h1 class="text-4xl font-bold mb-6">All Server Submissions</h1>
  <input
    id="searchInput"
    type="text"
    placeholder="Search by name, submitter, or tags..."
    class="p-2 rounded bg-zinc-800 mb-6 w-full max-w-lg"
  />
  <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</section>

<!-- ================= EDIT REQUESTS ================= -->
<section class="px-10 py-10 border-t border-zinc-800">
  <h1 class="text-4xl font-bold mb-6">Pending Edit Requests</h1>
  <div id="editRequestsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</section>

<!-- ================= REPORTS ================= -->
<section class="px-10 py-10 border-t border-zinc-800">
  <h1 class="text-4xl font-bold mb-6">Active Reports</h1>
  <div id="reportsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</section>

<!-- ================= FOOTER ================= -->
<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>© 2026 OpsLink Servers</span>
  <span>Admin Panel Only</span>
</footer>

<script>
/* ======================================================
   CONFIG
====================================================== */
const API_URL = 'https://opslinkservers-backend.onrender.com';
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');

let servers = [];
let currentUser = null;

/* ======================================================
   ADMIN CHECK
====================================================== */
async function checkAdmin() {
  if (!token || !userStr) {
    alert('Admin login required.');
    window.location.href = '/login.html';
    return false;
  }

  currentUser = JSON.parse(userStr);
  if (currentUser.role !== 'admin') {
    alert('Admins only.');
    window.location.href = '/';
    return false;
  }

  return true;
}

/* ======================================================
   LOAD DATA
====================================================== */
async function loadServers() {
  const res = await fetch(`${API_URL}/api/servers/all`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  servers = await res.json();
  renderServers();
  renderEditRequests();
  renderReports();
}

/* ======================================================
   SERVERS
====================================================== */
function renderServers() {
  const grid = document.getElementById('serversGrid');
  const q = document.getElementById('searchInput').value.toLowerCase();
  grid.innerHTML = '';

  const filtered = servers.filter(s =>
    s.name?.toLowerCase().includes(q) ||
    s.submitterDiscord?.username?.toLowerCase().includes(q) ||
    s.tags?.some(t => t.includes(q))
  );

  if (!filtered.length) {
    grid.innerHTML = `<div class="col-span-full text-center text-zinc-400">No servers found.</div>`;
    return;
  }

  filtered.forEach(s => {
    const statusColor =
      s.status === 'approved' ? 'text-green-400' :
      s.status === 'denied' ? 'text-red-400' :
      'text-yellow-400';

    const card = document.createElement('div');
    card.className = 'bg-zinc-900 border border-zinc-800 p-4 rounded flex flex-col justify-between';

card.innerHTML = `
  <div class="space-y-1 text-sm">
    <h3 class="font-semibold text-lg">${s.name}</h3>

    <img src="${s.logo}" class="w-16 h-16 rounded mt-2 object-cover" />

    <p class="text-zinc-400">${s.description}</p>

    <p><span class="text-zinc-400">Invite:</span>
      <a href="${s.invite}" target="_blank" class="text-indigo-400 underline">
        ${s.invite}
      </a>
    </p>

    <p><span class="text-zinc-400">Language:</span> ${s.language || '—'}</p>
    <p><span class="text-zinc-400">Type:</span> ${s.type || '—'}</p>
    <p><span class="text-zinc-400">Members:</span> ${s.members ?? '—'}</p>
    <p><span class="text-zinc-400">NSFW:</span> ${s.nsfw ? 'Yes' : 'No'}</p>

    <p><span class="text-zinc-400">Tags:</span> ${s.tags?.join(', ') || '—'}</p>

    <p><span class="text-zinc-400">Website:</span>
      ${s.website
        ? `<a href="${s.website}" target="_blank" class="text-indigo-400 underline">${s.website}</a>`
        : '—'}
    </p>

    <p><span class="text-zinc-400">Rules:</span> ${s.rules || '—'}</p>

    <p><span class="text-zinc-400">Discord Server ID:</span> ${s.discordServerId}</p>

    <p><span class="text-zinc-400">Submitted by:</span>
      ${s.submitterDiscord?.username}#${s.submitterDiscord?.tag}
    </p>

    <p><span class="text-zinc-400">Status:</span>
      <span class="${statusColor}">${s.status}</span>
    </p>

    ${s.rejectionReason
      ? `<p class="text-red-400">Rejection Reason: ${s.rejectionReason}</p>`
      : ''}

    <p class="text-xs text-zinc-500">
      Created: ${new Date(s.createdAt).toLocaleString()}
    </p>
  </div>

  <div class="flex gap-2 mt-3"></div>
`;

    const btns = card.querySelector('div:last-child');

    if (s.status === 'pending') {
      btns.appendChild(actionBtn('Approve', 'bg-green-600', () => updateStatus(s._id, 'approved')));
      btns.appendChild(actionBtn('Deny', 'bg-red-600', () => {
        const reason = prompt('Reason?');
        if (reason !== null) updateStatus(s._id, 'denied', reason);
      }));
    }

    grid.appendChild(card);
  });
}

/* ======================================================
   EDIT REQUESTS (FIXED)
====================================================== */
function renderEditRequests() {
  const grid = document.getElementById('editRequestsGrid');
  grid.innerHTML = '';

  const edits = servers.flatMap(server =>
    (server.editRequests || [])
      .filter(e => e.status === 'pending')
      .map(e => ({ server, edit: e }))
  );

  if (!edits.length) {
    grid.innerHTML = `<div class="col-span-full text-center text-zinc-400">No pending edit requests.</div>`;
    return;
  }

  edits.forEach(({ server, edit }) => {
    const c = edit.changes || {};

    const card = document.createElement('div');
    card.className = 'bg-yellow-900/70 border border-yellow-800 p-4 rounded';

    card.innerHTML = `
      <h3 class="font-semibold">${server.name}</h3>
      <p class="text-xs text-zinc-300">By: ${server.submitterDiscord?.username || 'Unknown'}</p>
      <p class="text-xs mt-2">Description: ${c.description || '—'}</p>
      <p class="text-xs">Tags: ${(c.tags || []).join(', ') || '—'}</p>
      <p class="text-xs">NSFW: ${c.nsfw ? 'Yes' : 'No'}</p>
      <div class="flex gap-2 mt-3"></div>
    `;

    const btns = card.querySelector('div:last-child');
    btns.appendChild(actionBtn('Approve', 'bg-green-600', () => approveEdit(server._id, edit._id)));
    btns.appendChild(actionBtn('Deny', 'bg-red-600', () => denyEdit(server._id, edit._id)));

    grid.appendChild(card);
  });
}

/* ======================================================
   REPORTS
====================================================== */
function renderReports() {
  const grid = document.getElementById('reportsGrid');
  grid.innerHTML = '';

  const reports = servers.flatMap(s =>
    (s.reports || []).map(r => ({ server: s, report: r }))
  );

  if (!reports.length) {
    grid.innerHTML = `<div class="col-span-full text-center text-zinc-400">No active reports.</div>`;
    return;
  }

  reports.forEach(({ server, report }) => {
    const card = document.createElement('div');
    card.className = 'bg-red-900/60 border border-red-800 p-4 rounded';

    card.innerHTML = `
      <h3 class="font-semibold">${server.name}</h3>
      <p class="text-xs mt-1">Reason: ${report.reason}</p>
      <p class="text-xs text-zinc-300 mt-1">
        Reported: ${new Date(report.createdAt).toLocaleString()}
      </p>
    `;

    grid.appendChild(card);
  });
}

/* ======================================================
   ACTIONS
====================================================== */
async function updateStatus(id, status, rejectionReason = '') {
  await fetch(`${API_URL}/api/servers/${id}/status`, {
    method: 'PATCH',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ status, rejectionReason })
  });
  loadServers();
}

async function approveEdit(serverId, editId) {
  await fetch(`${API_URL}/api/servers/${serverId}/edit-approve`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ editId })
  });
  loadServers();
}

async function denyEdit(serverId, editId) {
  await fetch(`${API_URL}/api/servers/${serverId}/edit-deny`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ editId })
  });
  loadServers();
}

/* ======================================================
   HELPERS
====================================================== */
function actionBtn(label, cls, fn) {
  const b = document.createElement('button');
  b.textContent = label;
  b.className = `${cls} px-3 py-1 rounded`;
  b.onclick = fn;
  return b;
}

/* ======================================================
   INIT
====================================================== */
document.getElementById('searchInput').addEventListener('input', renderServers);
document.getElementById('logoutBtn').onclick = () => {
  localStorage.clear();
  window.location.href = '/login.html';
};

(async () => {
  if (await checkAdmin()) loadServers();
})();
</script>

</body>
</html>
