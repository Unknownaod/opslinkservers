<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-10 py-6">
    <div class="text-xl font-semibold tracking-wide">OpsLink Admin Dashboard</div>
    <div class="flex items-center gap-8 text-sm">
      <a href="index.html" class="hover:opacity-80">Home</a>
      <button id="logoutBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Logout</button>
    </div>
  </nav>

  <section class="px-10 py-10">
    <h1 class="text-4xl font-bold mb-6">All Servers</h1>

    <!-- Search -->
    <input id="searchInput" type="text" placeholder="Search servers..." class="p-2 rounded bg-zinc-800 mb-6 w-full max-w-lg"/>

    <!-- Servers Grid -->
    <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Footer -->
  <footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
    <span>Â© 2026 OpsLink Servers</span>
    <span>Admin Panel Only</span>
  </footer>

  <script>
    const API_URL = 'https://opslinkservers-backend.onrender.com';
    let servers = [];
    let currentUser = null;
    const token = localStorage.getItem('token');
    const userStr = localStorage.getItem('user');

    async function checkAdmin() {
      if (!token || !userStr) {
        alert('You must be logged in as admin to access this page.');
        window.location.href = '/login.html';
        return;
      }
      currentUser = JSON.parse(userStr);
      if (currentUser.role !== 'admin') {
        alert('Access denied. Admins only.');
        window.location.href = '/';
        return;
      }
    }

    async function sendSystemMessage(userId, message) {
      try {
        await fetch(`${API_URL}/api/messages`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userId, message })
        });
      } catch(err) {
        console.error('Failed to send system message:', err);
      }
    }

    async function approveServer(server) {
      if (!confirm(`Approve ${server.name}?`)) return;
      try {
        await fetch(`${API_URL}/api/servers/${server._id}/approve`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // Send system message to submitter
        await sendSystemMessage(server.submitter, `Your server "${server.name}" has been approved! ðŸŽ‰`);

        alert(`${server.name} approved!`);
        await loadServers();
      } catch(err) {
        console.error(err);
        alert('Failed to approve server.');
      }
    }

    async function denyServer(server) {
      const reason = prompt(`Enter reason for denying ${server.name}:`);
      if (!reason) return;
      try {
        await fetch(`${API_URL}/api/servers/${server._id}/deny`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason })
        });

        // Send system message to submitter
        await sendSystemMessage(server.submitter, `Your server "${server.name}" has been denied. Reason: ${reason}`);

        alert(`${server.name} denied!`);
        await loadServers();
      } catch(err) {
        console.error(err);
        alert('Failed to deny server.');
      }
    }

    async function deleteServer(server) {
      if (!confirm('Are you sure you want to permanently delete this server?')) return;
      try {
        await fetch(`${API_URL}/api/servers/${server._id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        alert('Server deleted!');
        await loadServers();
      } catch(err) {
        console.error(err);
        alert('Failed to delete server.');
      }
    }

    function renderServers() {
      const container = document.getElementById('serversGrid');
      const search = document.getElementById('searchInput').value.toLowerCase();
      container.innerHTML = '';

      const filtered = servers.filter(s =>
        s.name.toLowerCase().includes(search) || s.description.toLowerCase().includes(search)
      );

      if (filtered.length === 0) {
        const msg = document.createElement('div');
        msg.className = 'col-span-full text-center text-zinc-400 mt-10';
        msg.textContent = 'No servers to show...';
        container.appendChild(msg);
        return;
      }

      filtered.forEach(s => {
        const card = document.createElement('div');
        card.className = 'bg-zinc-900/80 border border-zinc-800 p-4 rounded';
        card.innerHTML = `
          <h3 class="text-lg font-semibold mb-1">${s.name}</h3>
          <p class="text-sm text-zinc-300 mb-2">${s.description}</p>
          <p class="text-xs text-zinc-500 mb-2">Tags: ${s.tags.join(', ')}</p>
          <p class="text-xs text-zinc-500 mb-2">Submitted by: ${s.discordUsername}</p>
          <p class="text-xs text-zinc-400 mb-2">Status: <span class="${s.status === 'approved' ? 'text-green-400' : s.status === 'denied' ? 'text-red-400' : 'text-zinc-400'}">${s.status}</span></p>
          <div class="flex gap-2 mt-2">
            ${s.status === 'pending' ? `
              <button class="approve-btn bg-green-600 px-3 py-1 rounded hover:bg-green-700">Approve</button>
              <button class="deny-btn bg-red-600 px-3 py-1 rounded hover:bg-red-700">Deny</button>
            ` : ''}
            <button class="delete-btn bg-gray-600 px-3 py-1 rounded hover:bg-gray-700">Delete</button>
          </div>
        `;

        const approveBtn = card.querySelector('.approve-btn');
        if (approveBtn) approveBtn.addEventListener('click', () => approveServer(s));

        const denyBtn = card.querySelector('.deny-btn');
        if (denyBtn) denyBtn.addEventListener('click', () => denyServer(s));

        card.querySelector('.delete-btn').addEventListener('click', () => deleteServer(s));

        container.appendChild(card);
      });
    }

    async function loadServers() {
      try {
        const res = await fetch(`${API_URL}/api/servers`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        servers = await res.json();
        renderServers();
      } catch(err) {
        console.error(err);
        alert('Failed to load servers.');
      }
    }

    document.getElementById('searchInput').addEventListener('input', renderServers);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    });

    // Initialize
    (async () => {
      await checkAdmin();
      await loadServers();
    })();
  </script>
</body>
</html>
