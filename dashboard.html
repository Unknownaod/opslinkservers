<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-10 py-6">
    <div class="text-xl font-semibold tracking-wide">OpsLink Admin Dashboard</div>
    <div class="flex items-center gap-8 text-sm">
      <a href="index.html" class="hover:opacity-80">Home</a>
      <button id="logoutBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Logout</button>
    </div>
  </nav>

  <section class="px-10 py-10">
    <h1 class="text-4xl font-bold mb-6">All Server Submissions</h1>

    <!-- Search -->
    <input id="searchInput" type="text" placeholder="Search by server name, submitter, or tags..." class="p-2 rounded bg-zinc-800 mb-6 w-full max-w-lg"/>

    <!-- Servers Grid -->
    <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Active Reports Section -->
  <section class="px-10 py-10 border-t border-zinc-800">
    <h1 class="text-4xl font-bold mb-6">Active Reports</h1>
    <div id="reportsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Footer -->
  <footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
    <span>Â© 2026 OpsLink Servers</span>
    <span>Admin Panel Only</span>
  </footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
let servers = [];
let currentUser = null;
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');

// --- Admin check ---
async function checkAdmin() {
  if (!token || !userStr) {
    alert('You must be logged in as admin to access this page.');
    window.location.href = '/login.html';
    return false;
  }
  currentUser = JSON.parse(userStr);
  if (currentUser.role !== 'admin') {
    alert('Access denied. Admins only.');
    window.location.href = '/';
    return false;
  }
  return true;
}

// --- Load all servers ---
async function loadServers() {
  try {
    const res = await fetch(`${API_URL}/api/servers/all`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    servers = await res.json();
    renderServers();
    renderReports();
  } catch(err) {
    console.error(err);
    alert('Failed to load servers.');
  }
}

// --- Render servers ---
function renderServers() {
  const container = document.getElementById('serversGrid');
  const search = document.getElementById('searchInput').value.toLowerCase();
  container.innerHTML = '';

  const filtered = servers.filter(s =>
    s.name?.toLowerCase().includes(search) ||
    s.description?.toLowerCase().includes(search) ||
    s.submitterDiscord?.username?.toLowerCase().includes(search) ||
    s.submitterDiscord?.tag?.toLowerCase().includes(search) ||
    s.tags?.some(tag => tag.toLowerCase().includes(search))
  );

  if (filtered.length === 0) {
    container.innerHTML = '<div class="col-span-full text-center text-zinc-400 mt-10">No servers to show...</div>';
    return;
  }

  filtered.forEach(s => {
    const card = document.createElement('div');
    card.className = 'bg-zinc-900/80 border border-zinc-800 p-4 rounded flex flex-col justify-between';

    const statusColor = s.status === 'approved' ? 'text-green-400' :
                        s.status === 'denied' ? 'text-red-400' :
                        'text-yellow-400';

    const inviteLink = s.invite?.startsWith('http') ? s.invite : `https://${s.invite}`;
    const logoUrl = s.logo ? `${API_URL}/${s.logo}` : '';

    card.innerHTML = `
      <h3 class="text-lg font-semibold mb-1">${s.name}</h3>
      ${logoUrl ? `<img src="${logoUrl}" alt="Server Logo" class="w-full h-32 object-cover mb-4 rounded-lg" />` : ''}
      <p class="text-sm text-zinc-300 mb-2">${s.description || 'No description'}</p>
      <p class="text-xs text-zinc-500 mb-1">Tags: ${s.tags?.join(', ') || 'None'}</p>
      <p class="text-xs text-zinc-500 mb-1">NSFW: ${s.nsfw ? 'Yes' : 'No'}</p>
      <p class="text-xs text-zinc-500 mb-1">Server Type: ${s.type || 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-1">Language: ${s.language || 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-1">Members: ${s.members || 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-1">Website/Social: ${s.website || 'N/A'}</p>
      ${s.rules ? `<p class="text-xs text-zinc-500 mb-1">Rules: ${s.rules}</p>` : ''}
      <p class="text-xs text-zinc-500 mb-1">Submitted by: ${s.submitterDiscord?.username || 'N/A'} (${s.submitterDiscord?.tag || 'N/A'})</p>
      <p class="text-xs text-zinc-500 mb-1">UserID: ${s.submitterDiscord?.userID || 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-1">Created: ${s.createdAt ? new Date(s.createdAt).toLocaleString() : 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-2">Updated: ${s.updatedAt ? new Date(s.updatedAt).toLocaleString() : 'N/A'}</p>
      ${s.status === 'denied' && s.rejectionReason ? `<p class="text-xs text-red-400 mb-2">Reason: ${s.rejectionReason}</p>` : ''}
      <p class="text-xs text-blue-400 mb-2">Invite: <a href="${inviteLink}" target="_blank" class="underline">${inviteLink || 'N/A'}</a></p>
      <p class="text-sm mb-2">Status: <span class="${statusColor} font-semibold">${s.status}</span></p>
      <div class="flex gap-2 flex-wrap"></div>
    `;

    const btnContainer = card.querySelector('div');

    if (s.status === 'pending') {
      const approveBtn = document.createElement('button');
      approveBtn.className = 'bg-green-600 px-3 py-1 rounded hover:bg-green-700';
      approveBtn.textContent = 'Approve';
      approveBtn.onclick = () => approveServer(s._id);
      btnContainer.appendChild(approveBtn);

      const denyBtn = document.createElement('button');
      denyBtn.className = 'bg-red-600 px-3 py-1 rounded hover:bg-red-700';
      denyBtn.textContent = 'Deny';
      denyBtn.onclick = () => denyServer(s._id);
      btnContainer.appendChild(denyBtn);
    }

    if (s.status === 'approved') {
      const joinBtn = document.createElement('a');
      joinBtn.href = inviteLink;
      joinBtn.target = '_blank';
      joinBtn.className = 'bg-blue-600 px-3 py-1 rounded hover:bg-blue-700';
      joinBtn.textContent = 'Join Server';
      btnContainer.appendChild(joinBtn);
    }

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'bg-orange-600 px-3 py-1 rounded hover:bg-orange-700';
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = () => deleteServer(s._id);
    btnContainer.appendChild(deleteBtn);

    container.appendChild(card);
  });
}

// --- Render Active Reports ---
function renderReports() {
  const container = document.getElementById('reportsGrid');
  container.innerHTML = '';

  const reportedServers = servers.filter(s => s.reports && s.reports.length > 0);

  if (reportedServers.length === 0) {
    container.innerHTML = '<div class="col-span-full text-center text-zinc-400 mt-10">No active reports.</div>';
    return;
  }

  reportedServers.forEach(s => {
    const card = document.createElement('div');
    card.className = 'bg-red-900/80 border border-red-800 p-4 rounded flex flex-col gap-2';

    const inviteLink = s.invite?.startsWith('http') ? s.invite : `https://${s.invite}`;

    card.innerHTML = `
      <h3 class="text-lg font-semibold mb-1">${s.name}</h3>
      <p class="text-xs text-zinc-300 mb-1">Submitted by: ${s.submitterDiscord?.username || 'N/A'} (${s.submitterDiscord?.tag || 'N/A'})</p>
      <p class="text-xs text-blue-400 mb-1">Invite: <a href="${inviteLink}" target="_blank" class="underline">${inviteLink || 'N/A'}</a></p>
      <p class="text-sm font-semibold mb-1">Reports:</p>
      <div class="flex flex-col gap-1"></div>
      <div class="mt-2">
        <button class="bg-orange-600 px-3 py-1 rounded hover:bg-orange-700 deleteBtn">Delete Server</button>
      </div>
    `;

    const reportsContainer = card.querySelector('div.flex.flex-col');
    s.reports.forEach(r => {
      const reportEl = document.createElement('p');
      reportEl.className = 'text-xs text-zinc-300';
      reportEl.textContent = `- ${r.reason} (by user: ${r.user || 'N/A'})`;
      reportsContainer.appendChild(reportEl);
    });

    const deleteBtn = card.querySelector('.deleteBtn');
    deleteBtn.onclick = () => deleteServer(s._id);

    container.appendChild(card);
  });
}

// --- Server actions ---
async function approveServer(id) {
  if (!confirm('Approve this server?')) return;
  await updateServerStatus(id, 'approved');
}
async function denyServer(id) {
  const reason = prompt('Enter reason for denial:');
  if (reason === null) return;
  await updateServerStatus(id, 'denied', reason);
}
async function deleteServer(id) {
  if (!confirm('Delete this server?')) return;
  try {
    const res = await fetch(`${API_URL}/api/servers/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (res.ok) {
      alert('Server deleted!');
      await loadServers();
    } else {
      const err = await res.json();
      alert('Failed: ' + (err.error || err.message));
    }
  } catch(err) {
    console.error(err);
    alert('Error deleting server.');
  }
}
async function updateServerStatus(id, status, reason = '') {
  try {
    const res = await fetch(`${API_URL}/api/servers/${id}/status`, {
      method: 'PATCH',
      headers: { 
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status, rejectionReason: reason })
    });
    if (res.ok) {
      alert(`Server ${status}!`);
      await loadServers();
    } else {
      const err = await res.json();
      alert('Failed: ' + (err.error || err.message));
    }
  } catch(err) {
    console.error(err);
    alert('Error updating server status.');
  }
}

document.getElementById('searchInput').addEventListener('input', renderServers);
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location.href = '/login.html';
});

// --- Initialize ---
(async () => {
  if (await checkAdmin()) {
    await loadServers();
  }
})();
</script>

</body>
</html>
