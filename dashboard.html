<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-10 py-6 border-b border-zinc-800">
    <div class="text-xl font-semibold tracking-wide">OpsLink Admin Dashboard</div>
    <div class="flex items-center gap-8 text-sm">
      <a href="index.html" class="hover:opacity-80">Home</a>
      <button id="logoutBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Logout</button>
    </div>
  </nav>

  <!-- Servers Section -->
  <section class="px-10 py-10">
    <h1 class="text-4xl font-bold mb-6">All Server Submissions</h1>
    <input id="searchInput" type="text" placeholder="Search by server name, submitter, or tags..." class="p-2 rounded bg-zinc-800 mb-6 w-full max-w-lg"/>
    <div id="serversGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Edit Requests Section -->
  <section class="px-10 py-10 border-t border-zinc-800">
    <h1 class="text-4xl font-bold mb-6">Pending Edit Requests</h1>
    <div id="editRequestsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Active Reports Section -->
  <section class="px-10 py-10 border-t border-zinc-800">
    <h1 class="text-4xl font-bold mb-6">Active Reports</h1>
    <div id="reportsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <!-- Footer -->
  <footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
    <span>Â© 2026 OpsLink Servers</span>
    <span>Admin Panel Only</span>
  </footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
let servers = [];
let currentUser = null;
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');

// --- Admin check ---
async function checkAdmin() {
  if (!token || !userStr) {
    alert('You must be logged in as admin.');
    window.location.href = '/login.html';
    return false;
  }

  currentUser = JSON.parse(userStr);

  if (currentUser.role !== 'admin') {
    alert('Admins only.');
    window.location.href = '/';
    return false;
  }

  return true;
}

// --- Load servers ---
async function loadServers() {
  try {
    const res = await fetch(`${API_URL}/api/servers/all`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    servers = await res.json();

    renderServers();
    renderEditRequests();
    renderReports();

  } catch (err) {
    console.error(err);
    alert('Failed to load servers.');
  }
}

// --- Render servers ---
function renderServers() {
  const container = document.getElementById('serversGrid');
  const search = document.getElementById('searchInput').value.toLowerCase();
  container.innerHTML = '';

  const filtered = servers.filter(s =>
    s.name?.toLowerCase().includes(search) ||
    s.description?.toLowerCase().includes(search) ||
    s.submitterDiscord?.username?.toLowerCase().includes(search) ||
    s.submitterDiscord?.tag?.toLowerCase().includes(search) ||
    s.tags?.some(tag => tag.toLowerCase().includes(search))
  );

  if (!filtered.length) {
    container.innerHTML = '<div class="col-span-full text-center text-zinc-400 mt-10">No servers to show...</div>';
    return;
  }

  filtered.forEach(s => {
    const card = document.createElement('div');
    card.className = 'bg-zinc-900/80 border border-zinc-800 p-4 rounded flex flex-col justify-between';

    const statusColor =
      s.status === 'approved' ? 'text-green-400' :
      s.status === 'denied' ? 'text-red-400' :
      'text-yellow-400';

    const inviteLink = s.invite?.startsWith('http') ? s.invite : `https://${s.invite}`;

    card.innerHTML = `
      <h3 class="text-lg font-semibold mb-1">${s.name}</h3>
      <p class="text-sm text-zinc-300 mb-2">${s.description || 'No description'}</p>
      <p class="text-xs text-zinc-500 mb-1">Tags: ${s.tags?.join(', ') || 'None'}</p>
      <p class="text-xs text-zinc-500 mb-1">NSFW: ${s.nsfw ? 'Yes' : 'No'}</p>
      <p class="text-xs text-zinc-500 mb-1">Members: ${s.members || 'N/A'}</p>
      <p class="text-xs text-zinc-500 mb-1">Submitted by: ${s.submitterDiscord?.username || 'N/A'}</p>
      <p class="text-sm mb-2">Status: <span class="${statusColor} font-semibold">${s.status}</span></p>
      <div class="flex gap-2 flex-wrap"></div>
    `;

    const btnContainer = card.querySelector('div');

    if (s.status === 'pending') {
      const approveBtn = document.createElement('button');
      approveBtn.className = 'bg-green-600 px-3 py-1 rounded';
      approveBtn.textContent = 'Approve';
      approveBtn.onclick = () => approveServer(s._id);
      btnContainer.appendChild(approveBtn);

      const denyBtn = document.createElement('button');
      denyBtn.className = 'bg-red-600 px-3 py-1 rounded';
      denyBtn.textContent = 'Deny';
      denyBtn.onclick = () => denyServer(s._id);
      btnContainer.appendChild(denyBtn);
    }

    container.appendChild(card);
  });
}

// --- Render edit requests (FIXED) ---
function renderEditRequests() {
  const container = document.getElementById('editRequestsGrid');
  container.innerHTML = '';

  const requests = servers.flatMap(s =>
    (s.editRequests || []).map(req => ({
      ...req,
      serverId: s._id,
      originalServer: s
    }))
  );

  if (!requests.length) {
    container.innerHTML = '<div class="col-span-full text-center text-zinc-400 mt-10">No pending edit requests.</div>';
    return;
  }

  requests.forEach(req => {
    const card = document.createElement('div');
    card.className = 'bg-yellow-900/80 border border-yellow-800 p-4 rounded';

    card.innerHTML = `
      <h3 class="text-lg font-semibold mb-1">${req.name || req.originalServer.name}</h3>
      <p class="text-xs text-zinc-300">Requested By: ${req.originalServer.submitterDiscord?.username || 'N/A'}</p>
      <p class="text-sm mt-2">Changes:</p>
      <p class="text-xs">Description: ${req.description || 'No change'}</p>
      <p class="text-xs">Tags: ${req.tags?.join(', ') || 'No change'}</p>
      <p class="text-xs">NSFW: ${req.nsfw ? 'Yes' : 'No'}</p>
      <div class="flex gap-2 mt-3"></div>
    `;

    const btns = card.querySelector('div');

    const approve = document.createElement('button');
    approve.className = 'bg-green-600 px-3 py-1 rounded';
    approve.textContent = 'Approve Edit';
    approve.onclick = () => approveEdit(req.serverId, req._id);

    const deny = document.createElement('button');
    deny.className = 'bg-red-600 px-3 py-1 rounded';
    deny.textContent = 'Deny Edit';
    deny.onclick = () => denyEdit(req.serverId, req._id);

    btns.appendChild(approve);
    btns.appendChild(deny);

    container.appendChild(card);
  });
}

// --- Server actions ---
async function approveServer(id) {
  if (!confirm('Approve this server?')) return;
  await updateServerStatus(id, 'approved');
}

async function denyServer(id) {
  const reason = prompt('Enter reason:');
  if (reason === null) return;
  await updateServerStatus(id, 'denied', reason);
}

async function updateServerStatus(id, status, reason = '') {
  await fetch(`${API_URL}/api/servers/${id}/status`, {
    method: 'PATCH',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ status, rejectionReason: reason })
  });
  await loadServers();
}

// --- Approve / deny edits (FIXED) ---
async function approveEdit(serverId, editId) {
  await fetch(`${API_URL}/api/servers/${serverId}/edit-approve`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ editId })
  });
  await loadServers();
}

async function denyEdit(serverId, editId) {
  await fetch(`${API_URL}/api/servers/${serverId}/edit-deny`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ editId })
  });
  await loadServers();
}

// --- Init ---
document.getElementById('searchInput').addEventListener('input', renderServers);
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.clear();
  window.location.href = '/login.html';
});

(async () => {
  if (await checkAdmin()) await loadServers();
})();
</script>

</body>
</html>
