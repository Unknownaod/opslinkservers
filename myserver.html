<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Server Analytics â€¢ OpsLink</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background:
    radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent),
    radial-gradient(900px 500px at 80% 10%, rgba(34,197,94,.14), transparent),
    #020617;
  font-family: Inter, system-ui, sans-serif;
  color:white;
}
.glass {
  background: linear-gradient(180deg, rgba(24,24,27,.88), rgba(9,9,11,.88));
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 16px;
  padding: 1rem;
  transition: all .3s;
}
.glass:hover {
  transform: translateY(-4px);
  box-shadow: 0 20px 60px rgba(99,102,241,.3);
}
.card-header { font-weight:600; font-size:0.85rem; color:#9ca3af; margin-bottom:0.5rem; }
canvas { background: rgba(255,255,255,0.03); border-radius:12px; width:100%!important; height:300px!important; }
.table-container { overflow-x:auto; }
</style>
</head>
<body class="min-h-screen p-6 md:p-12">

<!-- NAV -->
<nav class="flex justify-between items-center mb-8">
  <h1 class="text-2xl font-bold tracking-wide">OpsLink Analytics</h1>
  <a id="loginBtn" class="border border-white/10 rounded-full px-5 py-2 text-sm hover:bg-white/5 cursor-pointer">Login</a>
</nav>

<!-- TOP STATS -->
<div class="grid grid-cols-1 sm:grid-cols-6 gap-6 mb-8">
  <div class="glass text-center"><p class="card-header">Total Messages</p><p class="text-2xl font-bold" id="totalMessages">0</p></div>
  <div class="glass text-center"><p class="card-header">Unique Members</p><p class="text-2xl font-bold" id="uniqueMembers">0</p></div>
  <div class="glass text-center"><p class="card-header">Humans</p><p class="text-2xl font-bold" id="humans">0</p></div>
  <div class="glass text-center"><p class="card-header">Bots</p><p class="text-2xl font-bold" id="bots">0</p></div>
  <div class="glass text-center"><p class="card-header">Active Boosts</p><p class="text-2xl font-bold" id="boosts">0</p></div>
  <div class="glass text-center"><p class="card-header">Unique Channels</p><p class="text-2xl font-bold" id="uniqueChannels">0</p></div>
</div>

<!-- CHANNEL BREAKDOWN -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center"><p class="card-header">Text Channels</p><p class="text-2xl font-bold" id="textChannels">0</p></div>
  <div class="glass text-center"><p class="card-header">Voice Channels</p><p class="text-2xl font-bold" id="voiceChannels">0</p></div>
  <div class="glass text-center"><p class="card-header">Categories</p><p class="text-2xl font-bold" id="categoryChannels">0</p></div>
  <div class="glass text-center"><p class="card-header">Threads</p><p class="text-2xl font-bold" id="threads">0</p></div>
</div>

<!-- PRESENCE STATUS -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center"><p class="card-header">Online</p><p class="text-2xl font-bold" id="onlineMembers">0</p></div>
  <div class="glass text-center"><p class="card-header">Idle</p><p class="text-2xl font-bold" id="idleMembers">0</p></div>
  <div class="glass text-center"><p class="card-header">Do Not Disturb</p><p class="text-2xl font-bold" id="dndMembers">0</p></div>
  <div class="glass text-center"><p class="card-header">Offline</p><p class="text-2xl font-bold" id="offlineMembers">0</p></div>
</div>

<!-- MESSAGES OVER TIME -->
<div class="glass mb-8">
  <p class="card-header mb-3">Messages Over Time</p>
  <canvas id="messagesOverTime"></canvas>
</div>

<!-- TOP MEMBERS & CHANNELS -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <div class="glass p-4 flex flex-col gap-4">
    <p class="card-header">Top Members</p>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="table-container">
        <table class="min-w-full text-left text-sm">
          <thead>
            <tr class="text-zinc-400"><th>Rank</th><th>Username</th><th>Messages</th></tr>
          </thead>
          <tbody id="membersTable"></tbody>
        </table>
      </div>
      <div><canvas id="membersPie"></canvas></div>
    </div>
  </div>

  <div class="glass p-4 flex flex-col gap-4">
    <p class="card-header">Top Channels</p>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="table-container">
        <table class="min-w-full text-left text-sm">
          <thead>
            <tr class="text-zinc-400"><th>Rank</th><th>Channel</th><th>Messages</th></tr>
          </thead>
          <tbody id="channelsTable"></tbody>
        </table>
      </div>
      <div><canvas id="channelsPie"></canvas></div>
    </div>
  </div>
</div>

<!-- JOINS / LEAVES -->
<div class="glass mb-8"><p class="card-header mb-3">Joins vs Leaves Over Time</p><canvas id="joinsLeavesChart"></canvas></div>

<!-- BOOSTS -->
<div class="glass mb-8"><p class="card-header mb-3">Boosts Over Time</p><canvas id="boostsChart"></canvas></div>

<!-- EMOJI USAGE -->
<div class="glass mb-8"><p class="card-header mb-3">Top Emojis</p><canvas id="emojiChart"></canvas></div>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user') || 'null');
const loginBtn = document.getElementById('loginBtn');

loginBtn.textContent = token ? 'Logout' : 'Login';
loginBtn.onclick = () => { localStorage.clear(); location.href='login.html'; };

async function fetchDashboard() {
  if(!user) return;
  const res = await fetch(`${API_URL}/api/servers/dashboard`, { headers: { Authorization:`Bearer ${token}` }});
  const data = await res.json();

  // --- Top Stats ---
  document.getElementById('totalMessages').textContent = (data.totalMessages||0).toLocaleString();
  document.getElementById('uniqueMembers').textContent = (data.uniqueMembers||0).toLocaleString();
  document.getElementById('humans').textContent = (data.humans||0).toLocaleString();
  document.getElementById('bots').textContent = (data.bots||0).toLocaleString();
  document.getElementById('boosts').textContent = (data.boosts||0).toLocaleString();
  document.getElementById('uniqueChannels').textContent = (data.channels?.text + data.channels?.voice + data.channels?.category + data.channels?.threads || 0).toLocaleString();
  document.getElementById('textChannels').textContent = (data.channels?.text||0).toLocaleString();
  document.getElementById('voiceChannels').textContent = (data.channels?.voice||0).toLocaleString();
  document.getElementById('categoryChannels').textContent = (data.channels?.category||0).toLocaleString();
  document.getElementById('threads').textContent = (data.channels?.threads||0).toLocaleString();

  // --- Presence ---
  document.getElementById('onlineMembers').textContent = (data.online||0).toLocaleString();
  document.getElementById('idleMembers').textContent = (data.idle||0).toLocaleString();
  document.getElementById('dndMembers').textContent = (data.dnd||0).toLocaleString();
  document.getElementById('offlineMembers').textContent = (data.offline||0).toLocaleString();

  // --- Messages Over Time ---
  new Chart(document.getElementById('messagesOverTime'), {
    type:'line',
    data:{
      labels: (data.messagesOverTime||[]).map(d=>d.date),
      datasets:[{ label:'Messages', data:(data.messagesOverTime||[]).map(d=>d.count), borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.2)', fill:true }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#9ca3af' } }, y:{ ticks:{ color:'#9ca3af' } } } }
  });

  // --- Top Members ---
  const membersTable = document.getElementById('membersTable'); membersTable.innerHTML='';
  (data.topMembers||[]).forEach((m,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${m.username}</td><td>${m.messages.toLocaleString()}</td>`;
    membersTable.appendChild(tr);
  });
  new Chart(document.getElementById('membersPie'), {
    type:'doughnut',
    data:{ labels:(data.topMembers||[]).map(m=>m.username), datasets:[{ data:(data.topMembers||[]).map(m=>m.messages), backgroundColor:['#22c55e','#6366f1','#facc15','#ef4444','#f87171','#10b981'] }] },
    options:{ responsive:true, cutout:'70%', plugins:{ legend:{ labels:{ color:'#9ca3af' }}} }
  });

  // --- Top Channels ---
  const channelsTable = document.getElementById('channelsTable'); channelsTable.innerHTML='';
  (data.topChannels||[]).forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${c.name}</td><td>${c.messages.toLocaleString()}</td>`;
    channelsTable.appendChild(tr);
  });
  new Chart(document.getElementById('channelsPie'), {
    type:'doughnut',
    data:{ labels:(data.topChannels||[]).map(c=>c.name), datasets:[{ data:(data.topChannels||[]).map(c=>c.messages), backgroundColor:['#22c55e','#6366f1','#facc15','#ef4444','#f87171','#10b981'] }] },
    options:{ responsive:true, cutout:'70%', plugins:{ legend:{ labels:{ color:'#9ca3af' }}} }
  });

  // --- Joins/Leaves ---
  new Chart(document.getElementById('joinsLeavesChart'), {
    type:'line',
    data:{
      labels:(data.joinsLeaves||[]).map(d=>d.date),
      datasets:[
        { label:'Joins', data:(data.joinsLeaves||[]).map(d=>d.joins), borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.2)', fill:true },
        { label:'Leaves', data:(data.joinsLeaves||[]).map(d=>d.leaves), borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.2)', fill:true }
      ]
    },
    options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#9ca3af' } } }, scales:{ x:{ ticks:{ color:'#9ca3af' } }, y:{ ticks:{ color:'#9ca3af' } } } }
  });

  // --- Boosts Over Time ---
  new Chart(document.getElementById('boostsChart'), {
    type:'bar',
    data:{ labels:(data.boostsOverTime||[]).map(d=>d.date), datasets:[{ label:'Boosts', data:(data.boostsOverTime||[]).map(d=>d.count), backgroundColor:'#facc15' }] },
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#9ca3af' } }, y:{ ticks:{ color:'#9ca3af' } } } }
  });

  // --- Emoji Usage ---
  new Chart(document.getElementById('emojiChart'), {
    type:'doughnut',
    data:{ labels:(data.topEmojis||[]).map(e=>e.emoji), datasets:[{ data:(data.topEmojis||[]).map(e=>e.count), backgroundColor:['#22c55e','#6366f1','#facc15','#ef4444','#f87171','#10b981','#a855f7','#14b8a6'] }] },
    options:{ responsive:true, cutout:'60%', plugins:{ legend:{ labels:{ color:'#9ca3af' } } } }
  });
}

fetchDashboard();
</script>
</body>
</html>
