<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server Dashboard • OpsLink</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background: radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent),
              radial-gradient(900px 500px at 80% 10%, rgba(34,197,94,.14), transparent),
              #020617;
  font-family: Inter, system-ui, sans-serif;
  color:white;
}
.glass {
  background: linear-gradient(180deg, rgba(24,24,27,.88), rgba(9,9,11,.88));
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 16px;
  padding: 1rem;
  margin-bottom: 1rem;
}
.card-header { font-weight:600; font-size:0.85rem; color:#9ca3af; margin-bottom:0.5rem; }
canvas { background: rgba(255,255,255,0.03); border-radius:12px; width:100%!important; height:300px!important; }
.table-container { overflow-x:auto; }
</style>
</head>
<body class="min-h-screen p-6 md:p-12">

<h1 class="text-4xl font-bold mb-6" id="serverName">Loading...</h1>

<!-- TOP STATS -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Humans</p>
    <p class="text-2xl font-bold" id="humans">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Bots</p>
    <p class="text-2xl font-bold" id="bots">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Boosts</p>
    <p class="text-2xl font-bold" id="boosts">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Total Members</p>
    <p class="text-2xl font-bold" id="totalMembers">0</p>
  </div>
</div>

<!-- PRESENCE -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Online</p>
    <p class="text-2xl font-bold" id="onlineMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Idle</p>
    <p class="text-2xl font-bold" id="idleMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">DND</p>
    <p class="text-2xl font-bold" id="dndMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Offline</p>
    <p class="text-2xl font-bold" id="offlineMembers">0</p>
  </div>
</div>

<!-- CHANNELS -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Text Channels</p>
    <p class="text-2xl font-bold" id="textChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Voice Channels</p>
    <p class="text-2xl font-bold" id="voiceChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Categories</p>
    <p class="text-2xl font-bold" id="categoryChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Threads</p>
    <p class="text-2xl font-bold" id="threads">0</p>
  </div>
</div>

<!-- CHARTS -->
<div class="glass mb-8">
  <p class="card-header mb-3">Messages Over Time</p>
  <canvas id="messagesOverTime"></canvas>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <div class="glass p-4 flex flex-col gap-4">
    <p class="card-header">Top Members</p>
    <div class="table-container">
      <table class="min-w-full text-left text-sm">
        <thead>
          <tr class="text-zinc-400">
            <th class="px-2 py-1">Rank</th>
            <th class="px-2 py-1">Username</th>
            <th class="px-2 py-1">Messages</th>
          </tr>
        </thead>
        <tbody id="membersTable"></tbody>
      </table>
    </div>
  </div>

  <div class="glass p-4 flex flex-col gap-4">
    <p class="card-header">Top Channels</p>
    <div class="table-container">
      <table class="min-w-full text-left text-sm">
        <thead>
          <tr class="text-zinc-400">
            <th class="px-2 py-1">Rank</th>
            <th class="px-2 py-1">Channel</th>
            <th class="px-2 py-1">Messages</th>
          </tr>
        </thead>
        <tbody id="channelsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<footer class="text-sm text-zinc-400 mt-12 flex justify-between">
  <span>© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script src="https://cdn.jsdelivr.net/npm/discord.js-light-browser/dist/discord.min.js"></script>
<script>
/* ================= CONFIG ================= */
const API_URL = 'https://opslinkservers-backend.onrender.com';
const BOT_TOKEN = 'MTQ2NjQzMDM1MjIzODA1NTU4Nw.GmePNe.W2j51ZwVZz-32qu0PQBx5MEjpdGtCPA7BGL9bw'; // <-- Only you see this

const urlParams = new URLSearchParams(window.location.search);
const serverId = urlParams.get('server');
let messagesChart;

/* ================= DISCORD LOGIN ================= */
async function loginBot() {
  if (!BOT_TOKEN) {
    alert('Bot token missing!');
    return null;
  }

  const client = new Discord.Client({
    intents: [
      Discord.Intents.Guilds,
      Discord.Intents.GuildMembers,
      Discord.Intents.GuildPresences,
      Discord.Intents.GuildMessages
    ]
  });

  await client.login(BOT_TOKEN);
  return client;
}

/* ================= FETCH ANALYTICS ================= */
async function fetchServerData() {
  try {
    // Step 1: Get server info from backend
    const serverRes = await fetch(`${API_URL}/api/servers/${serverId}`);
    if (!serverRes.ok) throw new Error('Failed to fetch server info');
    const serverData = await serverRes.json();

    // Step 2: Login bot
    const botClient = await loginBot();
    if (!botClient) return;

    // Step 3: Fetch guild using server ID from Mongo
    const guild = await botClient.guilds.fetch(serverData.discordServerId);
    const members = await guild.members.fetch({ withPresences: true });
    const humans = members.filter(m => !m.user.bot).size;
    const bots = members.filter(m => m.user.bot).size;

    const online = members.filter(m => m.presence?.status === 'online').size;
    const idle = members.filter(m => m.presence?.status === 'idle').size;
    const dnd = members.filter(m => m.presence?.status === 'dnd').size;
    const offline = members.size - (online + idle + dnd);

    const channels = {
      text: guild.channels.cache.filter(c => c.type === Discord.ChannelType.GuildText).size,
      voice: guild.channels.cache.filter(c => c.type === Discord.ChannelType.GuildVoice).size,
      category: guild.channels.cache.filter(c => c.type === Discord.ChannelType.GuildCategory).size,
      threads: guild.channels.cache.filter(c => c.isThread()).size
    };

    // Display data
    document.getElementById('serverName').textContent = serverData.name || 'Unknown Server';
    document.getElementById('humans').textContent = humans.toLocaleString();
    document.getElementById('bots').textContent = bots.toLocaleString();
    document.getElementById('boosts').textContent = serverData.boosts || 0;
    document.getElementById('totalMembers').textContent = members.size.toLocaleString();

    document.getElementById('onlineMembers').textContent = online.toLocaleString();
    document.getElementById('idleMembers').textContent = idle.toLocaleString();
    document.getElementById('dndMembers').textContent = dnd.toLocaleString();
    document.getElementById('offlineMembers').textContent = offline.toLocaleString();

    document.getElementById('textChannels').textContent = channels.text.toLocaleString();
    document.getElementById('voiceChannels').textContent = channels.voice.toLocaleString();
    document.getElementById('categoryChannels').textContent = channels.category.toLocaleString();
    document.getElementById('threads').textContent = channels.threads.toLocaleString();

    // Messages chart (placeholder)
    const ctx = document.getElementById('messagesOverTime');
    if (messagesChart) messagesChart.destroy();
    messagesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Now'],
        datasets: [{ label:'Messages', data:[0], borderColor:'#22c55e', backgroundColor:'rgba(34,197,94,0.2)', fill:true }]
      },
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#9ca3af' } }, y:{ ticks:{ color:'#9ca3af' } } } }
    });

    document.getElementById('membersTable').innerHTML = '<tr><td colspan="3" class="text-center text-zinc-400">Live analytics</td></tr>';
    document.getElementById('channelsTable').innerHTML = '<tr><td colspan="3" class="text-center text-zinc-400">Live analytics</td></tr>';

  } catch(err) {
    console.error(err);
    document.body.innerHTML = '<h2 class="text-red-500 text-center mt-20">Failed to load server data.</h2>';
  }
}

fetchServerData();
setInterval(fetchServerData, 15000);
</script>
</body>
</html>
