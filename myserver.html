<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server Dashboard • OpsLink</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background: radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent),
              radial-gradient(900px 500px at 80% 10%, rgba(34,197,94,.14), transparent),
              #020617;
  font-family: Inter, system-ui, sans-serif;
  color:white;
}
.glass {
  background: linear-gradient(180deg, rgba(24,24,27,.88), rgba(9,9,11,.88));
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 16px;
  padding: 1rem;
  margin-bottom: 1rem;
}
.card-header { font-weight:600; font-size:0.85rem; color:#9ca3af; margin-bottom:0.5rem; }
canvas { background: rgba(255,255,255,0.03); border-radius:12px; width:100%!important; height:300px!important; }
.table-container { overflow-x:auto; }
</style>
</head>
<body class="min-h-screen p-6 md:p-12">

<!-- HEADER -->
<h1 class="text-4xl font-bold mb-6" id="serverName">Loading...</h1>

<!-- TOP STATS -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Humans</p>
    <p class="text-2xl font-bold" id="humans">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Bots</p>
    <p class="text-2xl font-bold" id="bots">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Boosts</p>
    <p class="text-2xl font-bold" id="boosts">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Total Members</p>
    <p class="text-2xl font-bold" id="totalMembers">0</p>
  </div>
</div>

<!-- PRESENCE -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Online</p>
    <p class="text-2xl font-bold" id="onlineMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Idle</p>
    <p class="text-2xl font-bold" id="idleMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">DND</p>
    <p class="text-2xl font-bold" id="dndMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Offline</p>
    <p class="text-2xl font-bold" id="offlineMembers">0</p>
  </div>
</div>

<!-- CHANNELS -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Text Channels</p>
    <p class="text-2xl font-bold" id="textChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Voice Channels</p>
    <p class="text-2xl font-bold" id="voiceChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Categories</p>
    <p class="text-2xl font-bold" id="categoryChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Threads</p>
    <p class="text-2xl font-bold" id="threads">0</p>
  </div>
</div>

<!-- CHARTS -->
<div class="glass mb-8">
  <p class="card-header mb-3">Messages Over Time</p>
  <canvas id="messagesOverTime"></canvas>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <div class="glass p-4 flex flex-col gap-4">
    <p class="card-header">Top Members</p>
    <div class="table-container">
      <table class="min-w-full text-left text-sm">
        <thead>
          <tr class="text-zinc-400">
            <th class="px-2 py-1">Rank</th>
            <th class="px-2 py-1">Username</th>
            <th class="px-2 py-1">Messages</th>
          </tr>
        </thead>
        <tbody id="membersTable"></tbody>
      </table>
    </div>
  </div>

  <div class="glass p-4 flex flex-col gap-4">
    <p class="card-header">Top Channels</p>
    <div class="table-container">
      <table class="min-w-full text-left text-sm">
        <thead>
          <tr class="text-zinc-400">
            <th class="px-2 py-1">Rank</th>
            <th class="px-2 py-1">Channel</th>
            <th class="px-2 py-1">Messages</th>
          </tr>
        </thead>
        <tbody id="channelsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="text-sm text-zinc-400 mt-12 flex justify-between">
  <span>© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';

// Get server ID from query string
const urlParams = new URLSearchParams(window.location.search);
const serverId = urlParams.get('server');

if (!serverId) {
  document.body.innerHTML = '<h2 class="text-red-500 text-center mt-20">No server specified!</h2>';
}

// Charts placeholders
let messagesChart;

// Fetch and render server analytics
async function fetchServerData() {
  try {
    const res = await fetch(`${API_URL}/api/servers/${serverId}`);
    if (!res.ok) throw new Error('Failed to fetch server data');
    const data = await res.json();

    document.getElementById('serverName').textContent = data.name || 'Unknown Server';

    // Members
    const humans = data.humans || 0;
    const bots = data.bots || 0;
    const total = data.members || 0;
    document.getElementById('humans').textContent = humans.toLocaleString();
    document.getElementById('bots').textContent = bots.toLocaleString();
    document.getElementById('totalMembers').textContent = total.toLocaleString();

    // Presence
    document.getElementById('onlineMembers').textContent = (data.online || 0).toLocaleString();
    document.getElementById('idleMembers').textContent = (data.idle || 0).toLocaleString();
    document.getElementById('dndMembers').textContent = (data.dnd || 0).toLocaleString();
    document.getElementById('offlineMembers').textContent = (data.offline || 0).toLocaleString();

    // Channels
    document.getElementById('textChannels').textContent = (data.channels?.text || 0).toLocaleString();
    document.getElementById('voiceChannels').textContent = (data.channels?.voice || 0).toLocaleString();
    document.getElementById('categoryChannels').textContent = (data.channels?.category || 0).toLocaleString();
    document.getElementById('threads').textContent = (data.channels?.threads || 0).toLocaleString();

    // Messages chart
    const ctx = document.getElementById('messagesOverTime');
    if (messagesChart) messagesChart.destroy();
    messagesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: (data.messagesOverTime || []).map(d => d.date),
        datasets: [{ label: 'Messages', data: (data.messagesOverTime || []).map(d => d.count), borderColor: '#22c55e', backgroundColor:'rgba(34,197,94,0.2)', fill:true }]
      },
      options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#9ca3af' } }, y:{ ticks:{ color:'#9ca3af' } } } }
    });

    // Top members
    const membersTable = document.getElementById('membersTable');
    membersTable.innerHTML = '';
    (data.topMembers || []).forEach((m,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2 py-1">${i+1}</td><td class="px-2 py-1">${m.username}</td><td class="px-2 py-1">${m.messages.toLocaleString()}</td>`;
      membersTable.appendChild(tr);
    });

    // Top channels
    const channelsTable = document.getElementById('channelsTable');
    channelsTable.innerHTML = '';
    (data.topChannels || []).forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2 py-1">${i+1}</td><td class="px-2 py-1">${c.name}</td><td class="px-2 py-1">${c.messages.toLocaleString()}</td>`;
      channelsTable.appendChild(tr);
    });

  } catch(err) {
    console.error(err);
    document.body.innerHTML = '<h2 class="text-red-500 text-center mt-20">Failed to load server data.</h2>';
  }
}

// Auto-refresh every 15 seconds
fetchServerData();
setInterval(fetchServerData, 15000);
</script>
</body>
</html>
