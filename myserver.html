<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Server Analytics • OpsLink</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  background:
    radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent),
    radial-gradient(900px 500px at 80% 10%, rgba(34,197,94,.14), transparent),
    #020617;
  font-family: Inter, system-ui, sans-serif;
}

.glass {
  background: linear-gradient(180deg, rgba(24,24,27,.88), rgba(9,9,11,.88));
  backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,.06);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.04),
    0 30px 80px rgba(0,0,0,.6);
  transition: all .35s ease;
}

.glass:hover {
  transform: translateY(-6px);
  box-shadow: 0 40px 100px rgba(99,102,241,.35);
}

.stat {
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  padding: 14px;
}

canvas {
  background: rgba(255,255,255,.04);
  border-radius: 16px;
  padding: 12px;
}

.badge-approved {
  background: linear-gradient(90deg,#22c55e,#4ade80);
  color:#022c22;
}
.badge-pending {
  background: linear-gradient(90deg,#facc15,#f87171);
  color:#3b0d0c;
}
</style>
</head>

<body class="text-white min-h-screen">

<!-- NAV -->
<nav class="glass flex justify-between items-center px-12 py-6">
  <h1 class="text-2xl font-bold tracking-wide">OpsLink</h1>
  <a id="loginBtn" class="border border-white/10 rounded-full px-5 py-2 text-sm hover:bg-white/5 cursor-pointer">
    Login
  </a>
</nav>

<!-- HEADER -->
<header class="px-14 pt-12 pb-8">
  <h2 class="text-5xl font-bold mb-2">Server Analytics</h2>
  <p class="text-zinc-400 text-sm">Growth, activity, and presence insights</p>
</header>

<main class="px-14 pb-32">
  <div id="serversContainer" class="grid grid-cols-1 2xl:grid-cols-2 gap-10"></div>
</main>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user') || 'null');
const loginBtn = document.getElementById('loginBtn');

loginBtn.textContent = token ? 'Logout' : 'Login';
loginBtn.onclick = () => {
  localStorage.clear();
  location.href = 'login.html';
};

async function fetchServers() {
  if (!user) return;
  const res = await fetch(`${API_URL}/api/servers/mine`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const servers = await res.json();
  servers.forEach(renderServer);
}

async function renderServer(server) {
  const res = await fetch(`${API_URL}/api/servers/${server._id}`);
  const a = await res.json();

  const card = document.createElement('div');
  card.className = 'glass p-8 rounded-3xl flex flex-col gap-8';

  card.innerHTML = `
    <!-- HEADER -->
    <div class="flex justify-between items-center">
      <div class="flex gap-5 items-center">
        <img src="${server.logo}" class="w-16 h-16 rounded-2xl object-cover border border-white/10">
        <div>
          <h3 class="text-xl font-semibold">${server.name}</h3>
          <p class="text-xs text-zinc-400 max-w-sm">${server.description || 'No description'}</p>
        </div>
      </div>
      <span class="px-3 py-1 text-[10px] font-bold tracking-widest rounded-full ${server.status==='approved'?'badge-approved':'badge-pending'}">
        ${server.status.toUpperCase()}
      </span>
    </div>

    <!-- STATS -->
    <div class="grid grid-cols-4 gap-4">
      ${stat('Members', a.members)}
      ${stat('Humans', a.humans)}
      ${stat('Bots', a.bots)}
      ${stat('Boosts', a.boosts)}
    </div>

    <div class="grid grid-cols-4 gap-4">
      ${stat('Online', a.online)}
      ${stat('Idle', a.idle)}
      ${stat('DND', a.dnd)}
      ${stat('Offline', a.offline)}
    </div>

    <!-- CHARTS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <canvas id="growth-${server._id}" height="180"></canvas>
      <canvas id="presence-${server._id}" height="180"></canvas>
    </div>

    <!-- JOINS / LEAVES -->
    <div class="grid grid-cols-4 gap-4">
      ${delta('Joins 24h', a.joinsLast24h, 'emerald')}
      ${delta('Leaves 24h', a.leavesLast24h, 'rose')}
      ${delta('Joins 7d', a.joinsLast7d, 'emerald')}
      ${delta('Leaves 7d', a.leavesLast7d, 'rose')}
    </div>

    <p class="text-[10px] text-center text-zinc-500">
      Data since bot install • Updated ${new Date(a.updatedAt).toLocaleString()}
    </p>
  `;

  document.getElementById('serversContainer').appendChild(card);
  renderCharts(server._id, a);
}

function stat(label, value) {
  return `
    <div class="stat text-center">
      <p class="text-[10px] uppercase text-zinc-400">${label}</p>
      <p class="text-xl font-semibold">${value ?? 0}</p>
    </div>
  `;
}

function delta(label, value, color) {
  return `
    <div class="stat text-center bg-${color}-500/10 border-${color}-400/20">
      <p class="text-[10px] text-${color}-400">${label}</p>
      <p class="text-lg font-semibold text-${color}-300">${value ?? 0}</p>
    </div>
  `;
}

function renderCharts(id, a) {
  new Chart(document.getElementById(`growth-${id}`), {
    type: 'line',
    data: {
      labels: (a.memberSnapshots || []).map(d => d.date),
      datasets: [{
        label: 'Members',
        data: (a.memberSnapshots || []).map(d => d.count),
        borderColor: '#6366f1',
        tension: .4,
        fill: false
      }]
    },
    options: {
      plugins:{ legend:{ display:false }},
      scales:{ x:{ ticks:{ color:'#9ca3af'}}, y:{ ticks:{ color:'#9ca3af'}}}
    }
  });

  new Chart(document.getElementById(`presence-${id}`), {
    type: 'doughnut',
    data: {
      labels:['Online','Idle','DND','Offline'],
      datasets:[{
        data:[a.online,a.idle,a.dnd,a.offline],
        backgroundColor:['#22c55e','#facc15','#ef4444','#6b7280']
      }]
    },
    options:{ cutout:'70%', plugins:{ legend:{ labels:{ color:'#9ca3af'}}}}
  });
}

fetchServers();
</script>

</body>
</html>
