<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server Dashboard • OpsLink</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background: radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent),
              radial-gradient(900px 500px at 80% 10%, rgba(34,197,94,.14), transparent),
              #020617;
  font-family: Inter, system-ui, sans-serif;
  color:white;
}
.glass {
  background: linear-gradient(180deg, rgba(24,24,27,.88), rgba(9,9,11,.88));
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 16px;
  padding: 1rem;
  margin-bottom: 1rem;
}
.card-header { font-weight:600; font-size:0.85rem; color:#9ca3af; margin-bottom:0.5rem; }
canvas { background: rgba(255,255,255,0.03); border-radius:12px; width:100%!important; height:300px!important; }
.table-container { overflow-x:auto; }
</style>
</head>
<body class="min-h-screen p-6 md:p-12">

<h1 class="text-4xl font-bold mb-6" id="serverName">Loading...</h1>

<!-- TOP STATS -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Humans</p>
    <p class="text-2xl font-bold" id="humans">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Bots</p>
    <p class="text-2xl font-bold" id="bots">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Boosts</p>
    <p class="text-2xl font-bold" id="boosts">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Total Members</p>
    <p class="text-2xl font-bold" id="totalMembers">0</p>
  </div>
</div>

<!-- PRESENCE -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Online</p>
    <p class="text-2xl font-bold" id="onlineMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Idle</p>
    <p class="text-2xl font-bold" id="idleMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">DND</p>
    <p class="text-2xl font-bold" id="dndMembers">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Offline</p>
    <p class="text-2xl font-bold" id="offlineMembers">0</p>
  </div>
</div>

<!-- CHANNELS -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
  <div class="glass text-center">
    <p class="card-header">Text Channels</p>
    <p class="text-2xl font-bold" id="textChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Voice Channels</p>
    <p class="text-2xl font-bold" id="voiceChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Categories</p>
    <p class="text-2xl font-bold" id="categoryChannels">0</p>
  </div>
  <div class="glass text-center">
    <p class="card-header">Threads</p>
    <p class="text-2xl font-bold" id="threads">0</p>
  </div>
</div>

<!-- CHARTS -->
<div class="glass mb-8">
  <p class="card-header mb-3">Messages Over Time</p>
  <canvas id="messagesOverTime"></canvas>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <div class="glass p-4 flex flex-col gap-4">
    <p class="card-header">Top Members</p>
    <div class="table-container">
      <table class="min-w-full text-left text-sm">
        <thead>
          <tr class="text-zinc-400">
            <th class="px-2 py-1">Rank</th>
            <th class="px-2 py-1">Username</th>
            <th class="px-2 py-1">Messages</th>
          </tr>
        </thead>
        <tbody id="membersTable"></tbody>
      </table>
    </div>
  </div>

  <div class="glass p-4 flex flex-col gap-4">
    <p class="card-header">Top Channels</p>
    <div class="table-container">
      <table class="min-w-full text-left text-sm">
        <thead>
          <tr class="text-zinc-400">
            <th class="px-2 py-1">Rank</th>
            <th class="px-2 py-1">Channel</th>
            <th class="px-2 py-1">Messages</th>
          </tr>
        </thead>
        <tbody id="channelsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<footer class="text-sm text-zinc-400 mt-12 flex justify-between">
  <span>© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
const urlParams = new URLSearchParams(window.location.search);
const serverId = urlParams.get('server');

let messagesChart;

if (!serverId) {
  document.body.innerHTML = '<h2 class="text-red-500 text-center mt-20">No server specified!</h2>';
}

// Fetch server info and live analytics
async function fetchServerData() {
  try {
    // Server info (static, e.g., name, boosts)
    const serverRes = await fetch(`${API_URL}/api/servers/${serverId}`);
    const serverData = serverRes.ok ? await serverRes.json() : {};

    // Live analytics (updated by bot)
    const liveRes = await fetch(`${API_URL}/api/servers/${serverId}/live`);
    const liveData = liveRes.ok ? await liveRes.json() : {};

    // Server name
    document.getElementById('serverName').textContent = serverData.name || liveData.name || 'Unknown Server';

    // Top stats
    document.getElementById('humans').textContent = (liveData.humans || 0).toLocaleString();
    document.getElementById('bots').textContent = (liveData.bots || 0).toLocaleString();
    document.getElementById('boosts').textContent = (liveData.boosts || 0).toLocaleString();
    document.getElementById('totalMembers').textContent = (liveData.members || 0).toLocaleString();

    // Presence
    document.getElementById('onlineMembers').textContent = (liveData.online || 0).toLocaleString();
    document.getElementById('idleMembers').textContent = (liveData.idle || 0).toLocaleString();
    document.getElementById('dndMembers').textContent = (liveData.dnd || 0).toLocaleString();
    document.getElementById('offlineMembers').textContent = (liveData.offline || 0).toLocaleString();

    // Channels
    document.getElementById('textChannels').textContent = (liveData.channels?.text || 0).toLocaleString();
    document.getElementById('voiceChannels').textContent = (liveData.channels?.voice || 0).toLocaleString();
    document.getElementById('categoryChannels').textContent = (liveData.channels?.category || 0).toLocaleString();
    document.getElementById('threads').textContent = (liveData.channels?.threads || 0).toLocaleString();

    // Messages chart placeholder
    const ctx = document.getElementById('messagesOverTime');
    if (messagesChart) messagesChart.destroy();
    messagesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Now'], // no history yet
        datasets: [{
          label: 'Messages',
          data: [0], // TODO: add historical message counts if stored
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34,197,94,0.2)',
          fill: true
        }]
      },
      options: {
        responsive:true,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ ticks:{ color:'#9ca3af' } }, y:{ ticks:{ color:'#9ca3af' } } }
      }
    });

    // Top members table
    if (liveData.topMembers?.length) {
      document.getElementById('membersTable').innerHTML = liveData.topMembers.map((m,i)=>`
        <tr>
          <td class="px-2 py-1">${i+1}</td>
          <td class="px-2 py-1">${m[0]}</td>
          <td class="px-2 py-1">${m[1]}</td>
        </tr>
      `).join('');
    } else {
      document.getElementById('membersTable').innerHTML = '<tr><td colspan="3" class="text-center text-zinc-400">No data yet</td></tr>';
    }

    // Top channels table
    if (liveData.topChannels?.length) {
      document.getElementById('channelsTable').innerHTML = liveData.topChannels.map((c,i)=>`
        <tr>
          <td class="px-2 py-1">${i+1}</td>
          <td class="px-2 py-1">${c[0]}</td>
          <td class="px-2 py-1">${c[1]}</td>
        </tr>
      `).join('');
    } else {
      document.getElementById('channelsTable').innerHTML = '<tr><td colspan="3" class="text-center text-zinc-400">No data yet</td></tr>';
    }

  } catch(err) {
    console.error(err);
    document.body.innerHTML = '<h2 class="text-red-500 text-center mt-20">Failed to load server data.</h2>';
  }
}

fetchServerData();
setInterval(fetchServerData, 15000);
</script>

</body>
</html>
