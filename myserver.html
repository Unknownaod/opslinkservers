<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Server Dashboard - OpsLink</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6">
  <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
  <div class="flex items-center gap-8 text-sm" id="navLinks">
    <a href="index.html" class="hover:opacity-80">Home</a>
    <a href="browse.html" class="hover:opacity-80">Browse</a>
    <a href="submit.html" class="hover:opacity-80">Submit</a>
    <a href="login.html" id="loginBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Login</a>
  </div>
</nav>

<!-- DASHBOARD SECTION -->
<section class="px-10 py-10 max-w-5xl mx-auto">
  <div id="serverHeader" class="flex items-center gap-6 mb-6">
    <img id="serverIcon" src="" alt="Server Icon" class="w-24 h-24 rounded-full bg-zinc-800">
    <div>
      <h1 id="serverName" class="text-4xl font-bold"></h1>
      <p id="serverStatus" class="text-zinc-400"></p>
      <a id="serverInvite" href="#" target="_blank" class="text-blue-400 underline text-sm mt-1 inline-block">Join Server</a>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

    <!-- MEMBER & PRESENCE STATS -->
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold text-xl mb-4">Members & Presence</h2>
      <ul id="memberStats" class="text-sm space-y-1">
        <li>Total Members: <span id="totalMembers">-</span></li>
        <li>Humans: <span id="humans">-</span></li>
        <li>Bots: <span id="bots">-</span></li>
        <li>Online: <span id="online">-</span></li>
        <li>Idle: <span id="idle">-</span></li>
        <li>Do Not Disturb: <span id="dnd">-</span></li>
        <li>Offline: <span id="offline">-</span></li>
        <li>Boosts: <span id="boosts">-</span></li>
      </ul>
    </div>

    <!-- CHANNEL STATS -->
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold text-xl mb-4">Channels</h2>
      <ul id="channelStats" class="text-sm space-y-1">
        <li>Text Channels: <span id="textChannels">-</span></li>
        <li>Voice Channels: <span id="voiceChannels">-</span></li>
        <li>Categories: <span id="categories">-</span></li>
        <li>Threads: <span id="threads">-</span></li>
      </ul>
    </div>

  </div>

  <!-- TOP ACTIVITY -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold text-xl mb-2">Top Members</h2>
      <ul id="topMembers" class="text-sm space-y-1"></ul>
    </div>
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold text-xl mb-2">Top Channels</h2>
      <ul id="topChannels" class="text-sm space-y-1"></ul>
    </div>
    <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
      <h2 class="font-semibold text-xl mb-2">Top Emojis</h2>
      <ul id="topEmojis" class="text-sm space-y-1"></ul>
    </div>
  </div>

  <!-- JOIN/LEAVE COUNTERS -->
  <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50 mb-8">
    <h2 class="font-semibold text-xl mb-2">Server Activity</h2>
    <p>Joins since bot started: <span id="joins">-</span></p>
    <p>Leaves since bot started: <span id="leaves">-</span></p>
  </div>

  <!-- RECENT MESSAGES -->
  <div class="p-4 rounded border border-zinc-700 bg-zinc-900/50">
    <h2 class="font-semibold text-xl mb-2">Message Activity</h2>
    <ul id="recentMessages" class="text-sm space-y-1"></ul>
  </div>

</section>

<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>Â© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
const loginBtn = document.getElementById('loginBtn');

let user = null;

/* ================= LOGIN CHECK ================= */
function checkLogin() {
  const token = localStorage.getItem('token');
  const userStr = localStorage.getItem('user');

  if (!token || !userStr) {
    alert('You must be logged in to view this dashboard.');
    location.href = 'login.html';
    return false;
  }

  user = JSON.parse(userStr);

  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.onclick = () => {
    localStorage.clear();
    location.reload();
  };

  return true;
}

/* ================= FETCH SERVER DATA ================= */
async function fetchServerData() {
  const params = new URLSearchParams(window.location.search);
  const serverId = params.get('server');
  if (!serverId) return;

  try {
    const token = localStorage.getItem('token');
    // Server info from backend
    const resServer = await fetch(`${API_URL}/api/servers/mine`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const servers = await resServer.json();
    const server = servers.find(s => s._id === serverId);
    if (!server) throw new Error('Server not found or you do not own it');

    document.getElementById('serverName').textContent = server.name;
    document.getElementById('serverStatus').textContent = `Status: ${server.status}`;
    document.getElementById('serverInvite').href = server.invite || '#';
    document.getElementById('serverIcon').src = server.icon || 'https://via.placeholder.com/128';

    // Fetch live analytics
    const resLive = await fetch(`${API_URL}/api/servers/${serverId}/live`);
    if (!resLive.ok) throw new Error('Failed to fetch live analytics');
    const live = await resLive.json();

    // MEMBER STATS
    document.getElementById('totalMembers').textContent = live.members || '-';
    document.getElementById('humans').textContent = live.humans || '-';
    document.getElementById('bots').textContent = live.bots || '-';
    document.getElementById('online').textContent = live.online || '-';
    document.getElementById('idle').textContent = live.idle || '-';
    document.getElementById('dnd').textContent = live.dnd || '-';
    document.getElementById('offline').textContent = live.offline || '-';
    document.getElementById('boosts').textContent = live.boosts || '-';

    // CHANNEL STATS
    document.getElementById('textChannels').textContent = live.channels?.text || '-';
    document.getElementById('voiceChannels').textContent = live.channels?.voice || '-';
    document.getElementById('categories').textContent = live.channels?.category || '-';
    document.getElementById('threads').textContent = live.channels?.threads || '-';

    // TOP ACTIVITY
    const renderList = (id, items) => {
      const ul = document.getElementById(id);
      ul.innerHTML = '';
      if (!items || !items.length) { ul.innerHTML = '<li>-</li>'; return; }
      items.forEach(([name, count]) => {
        const li = document.createElement('li');
        li.textContent = `${name}: ${count}`;
        ul.appendChild(li);
      });
    };
    renderList('topMembers', live.topMembers);
    renderList('topChannels', live.topChannels);
    renderList('topEmojis', live.topEmojis);

    // JOINS / LEAVES
    document.getElementById('joins').textContent = live.joinsSinceStart || 0;
    document.getElementById('leaves').textContent = live.leavesSinceStart || 0;

    // RECENT MESSAGES (aggregate top 10 members)
    const recentUl = document.getElementById('recentMessages');
    recentUl.innerHTML = '';
    if (live.topMembers?.length) {
      live.topMembers.slice(0,10).forEach(([name, count]) => {
        const li = document.createElement('li');
        li.textContent = `${name} sent ${count} messages`;
        recentUl.appendChild(li);
      });
    } else {
      recentUl.innerHTML = '<li>-</li>';
    }

  } catch (err) {
    alert(err.message);
    console.error(err);
  }
}

/* ================= INIT ================= */
if (checkLogin()) {
  fetchServerData();
  setInterval(fetchServerData, 15000); // refresh every 15s
}
</script>
</body>
</html>
