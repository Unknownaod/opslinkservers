<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Server Analytics — OpsLink</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gradient-to-br from-black via-zinc-900 to-black text-white min-h-screen">

<nav class="flex justify-between items-center px-10 py-6 border-b border-zinc-800">
  <div class="font-semibold text-xl">OpsLink • Server Analytics</div>
  <button id="logout" class="text-red-400 hover:text-red-300 text-sm">Logout</button>
</nav>

<main class="max-w-7xl mx-auto px-10 py-10 space-y-12">

<!-- HEADER -->
<section class="flex items-center gap-6">
  <img id="icon" class="w-20 h-20 rounded-xl border border-zinc-700 bg-zinc-800">
  <div>
    <h1 id="name" class="text-4xl font-bold">Loading…</h1>
    <p id="meta" class="text-zinc-400 text-sm"></p>
  </div>
</section>

<!-- OVERVIEW -->
<section class="grid grid-cols-2 md:grid-cols-4 gap-6">
  <div class="card"><p>Members</p><h2 id="members"></h2></div>
  <div class="card"><p>Active (24h)</p><h2 id="active"></h2></div>
  <div class="card"><p>Messages (24h)</p><h2 id="messages"></h2></div>
  <div class="card"><p>Health Score</p><h2 id="health"></h2></div>
</section>

<!-- CHARTS -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <div class="panel"><h3>Member Growth</h3><canvas id="growthChart"></canvas></div>
  <div class="panel"><h3>Message Volume</h3><canvas id="messageChart"></canvas></div>
</section>

<section class="panel">
  <h3>Moderation Load</h3>
  <canvas id="modChart"></canvas>
</section>

<!-- TABLES -->
<section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <div class="panel">
    <h3>Channel Activity</h3>
    <table class="w-full text-sm text-zinc-300">
      <thead><tr><th>Channel</th><th>Messages</th></tr></thead>
      <tbody id="channels"></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>Invites</h3>
    <table class="w-full text-sm text-zinc-300">
      <thead><tr><th>Code</th><th>Joins</th></tr></thead>
      <tbody id="invites"></tbody>
    </table>
  </div>
</section>

<section class="panel">
  <h3>System & Bot Events</h3>
  <div id="events" class="space-y-2 text-sm"></div>
</section>

</main>

<footer class="px-10 py-6 border-t border-zinc-800 text-zinc-400 text-sm">
  Analytics powered by OpsLink Bot
</footer>

<style>
.card {
  background:#18181b;
  border:1px solid #27272a;
  padding:1.25rem;
  border-radius:1rem;
}
.card p { color:#a1a1aa;font-size:.8rem }
.card h2 { font-size:1.8rem;font-weight:700 }
.panel {
  background:#18181b;
  border:1px solid #27272a;
  padding:1.5rem;
  border-radius:1rem;
}
.panel h3 { font-weight:600;margin-bottom:.75rem }
</style>

<script>
const API = "https://opslinkservers-backend.onrender.com";
const id = new URLSearchParams(location.search).get('server');
const token = localStorage.getItem('token');

if (!id || !token) location.href = 'login.html';

logout.onclick = () => { localStorage.clear(); location.href='index.html'; };

(async () => {
  const res = await fetch(`${API}/api/servers/${id}/analytics/full`, {
    headers:{Authorization:`Bearer ${token}`}
  });

  if (!res.ok) return alert("Unauthorized");

  const d = await res.json();

  icon.src = d.server.icon;
  name.textContent = d.server.name;
  meta.textContent = `Boosts: ${d.server.boosts} • Level ${d.server.boostLevel} • ${d.server.features.join(', ')}`;

  members.textContent = d.members.total;
  active.textContent = d.activity.active24h;
  messages.textContent = d.messages.count24h;
  health.textContent = d.health.score;

  new Chart(growthChart,{
    type:'line',
    data:{labels:d.members.history.labels,datasets:[{data:d.members.history.values,tension:.4}]}
  });

  new Chart(messageChart,{
    type:'bar',
    data:{labels:d.messages.history.labels,datasets:[{data:d.messages.history.values}]}
  });

  new Chart(modChart,{
    type:'bar',
    data:{labels:['Warnings','Timeouts','Kicks','Bans'],
    datasets:[{data:[
      d.moderation.warnings,
      d.moderation.timeouts,
      d.moderation.kicks,
      d.moderation.bans
    ]}]}
  });

  channels.innerHTML = d.channels.top.map(c =>
    `<tr><td>${c.name}</td><td>${c.messages}</td></tr>`
  ).join('');

  invites.innerHTML = d.invites.map(i =>
    `<tr><td>${i.code}</td><td>${i.joins}</td></tr>`
  ).join('');

  events.innerHTML = d.events.map(e =>
    `<div class="border border-zinc-700 rounded p-2">${e}</div>`
  ).join('');
})();
</script>

</body>
</html>
