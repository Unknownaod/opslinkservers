<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Servers • OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-zinc-900 text-white min-h-screen">

<!-- Navbar -->
<nav class="flex justify-between items-center px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold">OpsLink</div>
  <div class="flex items-center gap-6">
    <a href="index.html" class="hover:opacity-80">Home</a>
    <a href="browse.html" class="hover:opacity-80">Browse</a>
    <a href="support.html" class="hover:opacity-80">Support</a>
    <a href="#" id="loginBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Login</a>
  </div>
</nav>

<header class="px-10 py-10">
  <h1 class="text-4xl font-bold mb-2">My Servers Dashboard</h1>
  <p class="text-zinc-300">Live analytics for your Discord communities.</p>
</header>

<main class="px-10 pb-32">
  <div id="serversContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
</main>

<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
const loginBtn = document.getElementById('loginBtn');

let user = null;

// ================== LOGIN CHECK ==================
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');

if (!token || !userStr) {
  loginBtn.textContent = 'Login';
  loginBtn.href = 'login.html';
} else {
  user = JSON.parse(userStr);
  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.onclick = () => {
    localStorage.clear();
    location.reload();
  };
}

// ================== FETCH MY SERVERS ==================
async function fetchMyServers() {
  if (!user) return;

  try {
    const res = await fetch(`${API_URL}/api/servers/mine`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const servers = await res.json();

    if (!servers.length) {
      document.getElementById('serversContainer').innerHTML =
        '<p class="text-zinc-400">You have no servers submitted yet.</p>';
      return;
    }

    servers.forEach(renderServerCard);

  } catch (err) {
    console.error(err);
    document.getElementById('serversContainer').innerHTML =
      '<p class="text-red-500">Failed to load servers.</p>';
  }
}

// ================== RENDER SERVER CARD ==================
async function renderServerCard(server) {
  const container = document.getElementById('serversContainer');

  let analytics = {};
  try {
    const res = await fetch(`${API_URL}/api/servers/${server._id}`);
    analytics = await res.json();
  } catch (err) {
    console.error('Analytics fetch failed:', err);
  }

  const div = document.createElement('div');
  div.className = 'bg-zinc-800 p-6 rounded-xl border border-zinc-700 shadow-lg flex flex-col gap-4';

  div.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="${server.logo}" class="w-12 h-12 rounded-full border border-zinc-700 object-cover">
        <div>
          <h2 class="text-xl font-semibold">${server.name}</h2>
          <p class="text-zinc-400 text-sm">${server.description || 'No description'}</p>
        </div>
      </div>
      <span class="px-3 py-1 rounded-full text-xs font-semibold ${server.status === 'approved' ? 'bg-green-600' : 'bg-yellow-600'}">
        ${server.status.toUpperCase()}
      </span>
    </div>

    <!-- STATS GRID -->
    <div class="grid grid-cols-2 gap-3">
      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Members</p>
        <p class="text-lg font-semibold">${analytics.members || 0}</p>
      </div>

      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Humans / Bots</p>
        <p class="text-lg font-semibold">${analytics.humans || 0} / ${analytics.bots || 0}</p>
      </div>

      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Boosts</p>
        <p class="text-lg font-semibold">${analytics.boosts || 0}</p>
      </div>

      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Online</p>
        <p class="text-lg font-semibold">${analytics.online || 0}</p>
      </div>
    </div>

    <!-- CHANNEL COUNTS -->
    <div class="grid grid-cols-3 gap-3">
      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Text</p>
        <p class="text-lg font-semibold">${analytics.channels?.text || 0}</p>
      </div>

      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Voice</p>
        <p class="text-lg font-semibold">${analytics.channels?.voice || 0}</p>
      </div>

      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Categories</p>
        <p class="text-lg font-semibold">${analytics.channels?.category || 0}</p>
      </div>
    </div>

    <!-- CHARTS -->
    <canvas id="messagesChart-${server._id}" class="mt-2 h-36"></canvas>
    <canvas id="presenceChart-${server._id}" class="mt-2 h-36"></canvas>

    <!-- GROWTH -->
    <div class="grid grid-cols-2 gap-3">
      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Joins (24h)</p>
        <p class="text-lg font-semibold text-green-400">+${analytics.joinsLast24h || 0}</p>
      </div>

      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-xs text-zinc-400">Leaves (24h)</p>
        <p class="text-lg font-semibold text-red-400">-${analytics.leavesLast24h || 0}</p>
      </div>
    </div>

    <p class="text-xs text-zinc-500">
      Last updated: ${analytics.updatedAt ? new Date(analytics.updatedAt).toLocaleString() : 'N/A'}
    </p>
  `;

  container.appendChild(div);

  // ================== CHARTS ==================

  new Chart(document.getElementById(`messagesChart-${server._id}`), {
    type: 'bar',
    data: {
      labels: ['24h', '7d'],
      datasets: [{
        label: 'Messages',
        data: [analytics.messagesLast24h || 0, analytics.messagesLast7d || 0]
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });

  new Chart(document.getElementById(`presenceChart-${server._id}`), {
    type: 'doughnut',
    data: {
      labels: ['Online', 'Idle', 'DND', 'Offline'],
      datasets: [{
        data: [
          analytics.online || 0,
          analytics.idle || 0,
          analytics.dnd || 0,
          analytics.offline || 0
        ]
      }]
    },
    options: { responsive: true }
  });
}

// ================== INIT ==================
fetchMyServers();
</script>

</body>
</html>
