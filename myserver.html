<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Server Dashboard - OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-black text-white overflow-x-hidden">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-10 py-6">
  <div class="text-xl font-semibold tracking-wide">OpsLink Servers</div>
  <div class="flex items-center gap-8 text-sm" id="navLinks">
    <a href="index.html" class="hover:opacity-80">Home</a>
    <a href="browse.html" class="hover:opacity-80">Browse</a>
    <a href="submit.html" class="hover:opacity-80">Submit</a>
    <a href="login.html" id="loginBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Login</a>
  </div>
</nav>

<!-- DASHBOARD SECTION -->
<section class="px-10 py-10 max-w-5xl mx-auto">
  <div class="flex items-center gap-6 mb-8">
    <img id="serverIcon" class="w-20 h-20 rounded-xl" src="" alt="Server Icon">
    <h1 id="serverName" class="text-4xl font-bold"></h1>
    <a id="serverInvite" class="ml-auto bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-700 text-sm" target="_blank">Join Server</a>
  </div>

  <!-- TABS -->
  <div class="flex border-b border-zinc-700 mb-6">
    <button id="tabDashboard" class="px-4 py-2 font-semibold border-b-2 border-indigo-600">Dashboard</button>
    <button id="tabComments" class="px-4 py-2 font-semibold text-zinc-400 hover:text-white">Comments</button>
  </div>

  <div id="tabContent">
    <!-- DASHBOARD CONTENT -->
    <div id="dashboardContent">
      <div id="analytics" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-4 bg-zinc-800 rounded-xl">
          <h2 class="font-semibold text-xl mb-2">Members</h2>
          <ul class="space-y-1">
            <li>Total: <span id="membersTotal">0</span></li>
            <li>Humans: <span id="humans">0</span></li>
            <li>Bots: <span id="bots">0</span></li>
            <li>Online: <span id="online">0</span></li>
            <li>Idle: <span id="idle">0</span></li>
            <li>DND: <span id="dnd">0</span></li>
            <li>Offline: <span id="offline">0</span></li>
          </ul>
        </div>

        <div class="p-4 bg-zinc-800 rounded-xl">
          <h2 class="font-semibold text-xl mb-2">Channels</h2>
          <ul class="space-y-1">
            <li>Text: <span id="textChannels">0</span></li>
            <li>Voice: <span id="voiceChannels">0</span></li>
            <li>Categories: <span id="categoryChannels">0</span></li>
            <li>Threads: <span id="threadChannels">0</span></li>
          </ul>
        </div>

        <div class="p-4 bg-zinc-800 rounded-xl">
          <h2 class="font-semibold text-xl mb-2">Server Activity</h2>
          <ul class="space-y-1">
            <li>Joins since start: <span id="joins">0</span></li>
            <li>Leaves since start: <span id="leaves">0</span></li>
            <li>Boosts: <span id="boosts">0</span></li>
          </ul>
        </div>

        <div class="p-4 bg-zinc-800 rounded-xl">
          <h2 class="font-semibold text-xl mb-2">Top Members (Messages)</h2>
          <ul id="topMembers" class="list-decimal list-inside space-y-1"></ul>
        </div>

        <div class="p-4 bg-zinc-800 rounded-xl">
          <h2 class="font-semibold text-xl mb-2">Top Channels (Messages)</h2>
          <ul id="topChannels" class="list-decimal list-inside space-y-1"></ul>
        </div>

        <div class="p-4 bg-zinc-800 rounded-xl">
          <h2 class="font-semibold text-xl mb-2">Top Emojis</h2>
          <ul id="topEmojis" class="list-decimal list-inside space-y-1"></ul>
        </div>
      </div>
    </div>

    <!-- COMMENTS CONTENT -->
    <div id="commentsContent" class="hidden">
      <div id="commentsDiv" class="flex flex-col gap-4">
        <p class="text-zinc-400">Loading comments...</p>
      </div>
    </div>
  </div>
</section>

<script>
// URLs and server ID
const API_URL = 'https://opslinkservers-backend.onrender.com';
const serverId = new URLSearchParams(window.location.search).get('server');

// Tabs
const tabDashboard = document.getElementById('tabDashboard');
const tabComments = document.getElementById('tabComments');
const dashboardContent = document.getElementById('dashboardContent');
const commentsContent = document.getElementById('commentsContent');

// Render analytics
function renderAnalytics(data) {
  document.getElementById('serverName').textContent = data.name;
  document.getElementById('serverIcon').src = data.icon || 'https://via.placeholder.com/80';
  document.getElementById('serverInvite').href = data.invite || '#';

  document.getElementById('humans').textContent = data.humans;
  document.getElementById('bots').textContent = data.bots;
  document.getElementById('online').textContent = data.online;
  document.getElementById('idle').textContent = data.idle;
  document.getElementById('dnd').textContent = data.dnd;
  document.getElementById('offline').textContent = data.offline;

  document.getElementById('textChannels').textContent = data.channels.text;
  document.getElementById('voiceChannels').textContent = data.channels.voice;
  document.getElementById('categoryChannels').textContent = data.channels.category;
  document.getElementById('threadChannels').textContent = data.channels.threads;

  document.getElementById('joins').textContent = data.joinsSinceStart;
  document.getElementById('leaves').textContent = data.leavesSinceStart;
  document.getElementById('boosts').textContent = data.boosts;

  // Top members/channels/emojis
  const topMembers = document.getElementById('topMembers');
  topMembers.innerHTML = '';
  data.topMembers.forEach(m => topMembers.innerHTML += `<li>${m[0]} - ${m[1]} messages</li>`);

  const topChannels = document.getElementById('topChannels');
  topChannels.innerHTML = '';
  data.topChannels.forEach(c => topChannels.innerHTML += `<li>${c[0]} - ${c[1]} messages</li>`);

  const topEmojis = document.getElementById('topEmojis');
  topEmojis.innerHTML = '';
  data.topEmojis.forEach(e => topEmojis.innerHTML += `<li>${e[0]} - ${e[1]} uses</li>`);
}

// Fetch live analytics every 20s
async function fetchAnalytics() {
  try {
    const res = await fetch(`${API_URL}/api/servers/${serverId}/live`);
    if (!res.ok) throw new Error('Failed to fetch live analytics');
    const data = await res.json();
    renderAnalytics(data);
  } catch (err) {
    console.error('Analytics fetch error:', err);
  }
}

// Fetch member count separately from the backend
async function fetchMemberCount() {
  try {
    const res = await fetch(`${API_URL}/api/servers/${serverId}`);
    if (!res.ok) throw new Error('Failed to fetch member count');
    const data = await res.json();
    document.getElementById('membersTotal').textContent = data.members;
  } catch (err) {
    console.error('Member count fetch error:', err);
  }
}

// Fetch comments
async function fetchComments() {
  try {
    const res = await fetch(`${API_URL}/api/servers/${serverId}`);
    if (!res.ok) throw new Error('Failed to fetch comments');
    const data = await res.json();
    const commentsDiv = document.getElementById('commentsDiv');
    commentsDiv.innerHTML = '';
    if (!data.comments.length) {
      commentsDiv.innerHTML = '<p class="text-zinc-400">No comments yet.</p>';
      return;
    }
    data.comments.forEach(c => {
      const div = document.createElement('div');
      div.className = 'p-4 bg-zinc-800 rounded-xl';
      div.innerHTML = `<strong>${c.user}#${c.tag}:</strong> ${c.text}<br><span class="text-sm text-zinc-400">${new Date(c.createdAt).toLocaleString()}</span>`;
      commentsDiv.appendChild(div);
    });
  } catch (err) {
    console.error(err);
  }
}

// INITIAL FETCH
fetchAnalytics();
fetchMemberCount();
setInterval(() => {
  fetchAnalytics();    // update all analytics except member count
  fetchMemberCount();  // update member count separately to keep DB source consistent
}, 20000);

// Tabs
tabDashboard.onclick = () => {
  dashboardContent.classList.remove('hidden');
  commentsContent.classList.add('hidden');
  tabDashboard.classList.add('border-indigo-600');
  tabDashboard.classList.remove('text-zinc-400');
  tabComments.classList.remove('border-indigo-600');
  tabComments.classList.add('text-zinc-400');
};

tabComments.onclick = () => {
  fetchComments();
  commentsContent.classList.remove('hidden');
  dashboardContent.classList.add('hidden');
  tabComments.classList.add('border-indigo-600');
  tabComments.classList.remove('text-zinc-400');
  tabDashboard.classList.remove('border-indigo-600');
  tabDashboard.classList.add('text-zinc-400');
};
</script>

</body>
</html>
