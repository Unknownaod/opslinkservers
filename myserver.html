<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Servers • OpsLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-zinc-900 text-white min-h-screen">

<!-- Navbar -->
<nav class="flex justify-between items-center px-10 py-6 border-b border-zinc-800">
  <div class="text-xl font-semibold">OpsLink</div>
  <div class="flex items-center gap-6">
    <a href="index.html" class="hover:opacity-80">Home</a>
    <a href="browse.html" class="hover:opacity-80">Browse</a>
    <a href="support.html" class="hover:opacity-80">Support</a>
    <a href="#" id="loginBtn" class="rounded-full border border-white px-4 py-2 hover:bg-white/10">Login</a>
  </div>
</nav>

<!-- Hero -->
<header class="px-10 py-10">
  <h1 class="text-4xl font-bold mb-2">My Servers Dashboard</h1>
  <p class="text-zinc-300">View all analytics and activity for your Discord servers.</p>
</header>

<main class="px-10 pb-32">

  <div id="serversContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

</main>

<footer class="px-10 py-10 border-t border-zinc-800 text-sm text-zinc-400 flex justify-between">
  <span>© 2026 OpsLink Servers</span>
  <span>Not affiliated with Discord</span>
</footer>

<script>
const API_URL = 'https://opslinkservers-backend.onrender.com';
const loginBtn = document.getElementById('loginBtn');

let user = null;

// ================== LOGIN CHECK ==================
const token = localStorage.getItem('token');
const userStr = localStorage.getItem('user');

if (!token || !userStr) {
  loginBtn.textContent = 'Login';
  loginBtn.href = 'login.html';
} else {
  user = JSON.parse(userStr);
  loginBtn.textContent = 'Logout';
  loginBtn.href = '#';
  loginBtn.onclick = () => {
    localStorage.clear();
    location.reload();
  };
}

// ================== FETCH MY SERVERS ==================
async function fetchMyServers() {
  if (!user) return;

  try {
    const res = await fetch(`${API_URL}/api/servers/mine`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const servers = await res.json();

    if (!servers.length) {
      document.getElementById('serversContainer').innerHTML = '<p class="text-zinc-400">You have no servers submitted yet.</p>';
      return;
    }

    servers.forEach(renderServerCard);

  } catch (err) {
    console.error(err);
    document.getElementById('serversContainer').innerHTML = '<p class="text-red-500">Failed to load servers.</p>';
  }
}

// ================== RENDER SERVER CARD ==================
async function renderServerCard(server) {
  const container = document.getElementById('serversContainer');

  // Fetch analytics from bot endpoint
  let analytics = {};
  try {
    const res = await fetch(`${API_URL}/api/servers/${server._id}`); // server details including comments
    analytics = await res.json();
  } catch(err) {
    console.error('Failed to fetch analytics for', server.name, err);
  }

  const div = document.createElement('div');
  div.className = 'bg-zinc-800 p-6 rounded-xl border border-zinc-700 shadow-lg flex flex-col gap-4';

  div.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="${server.logo}" class="w-12 h-12 rounded-full object-cover border border-zinc-700"/>
        <div>
          <h2 class="text-xl font-semibold">${server.name}</h2>
          <p class="text-zinc-400 text-sm">${server.description || 'No description'}</p>
        </div>
      </div>
      <span class="px-3 py-1 rounded-full text-sm font-semibold ${server.status==='approved'?'bg-green-600':'bg-yellow-600'}">
        ${server.status.toUpperCase()}
      </span>
    </div>

    <div class="grid grid-cols-2 gap-4 mt-4">
      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-zinc-400 text-xs">Total Members</p>
        <p class="text-lg font-semibold">${analytics.members?.total || server.members || 0}</p>
      </div>
      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-zinc-400 text-xs">Humans / Bots</p>
        <p class="text-lg font-semibold">${analytics.members?.humans || 0} / ${analytics.members?.bots || 0}</p>
      </div>
      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-zinc-400 text-xs">Boosts</p>
        <p class="text-lg font-semibold">${analytics.boosts || 0}</p>
      </div>
      <div class="bg-zinc-900 p-3 rounded">
        <p class="text-zinc-400 text-xs">Online / Idle / DND / Offline</p>
        <p class="text-lg font-semibold">
          ${analytics.presence?.online || 0} / ${analytics.presence?.idle || 0} / ${analytics.presence?.dnd || 0} / ${analytics.presence?.offline || 0}
        </p>
      </div>
    </div>

    <canvas id="messagesChart-${server._id}" class="mt-4 w-full h-40"></canvas>
    <canvas id="presenceChart-${server._id}" class="mt-4 w-full h-40"></canvas>

    <div class="mt-4">
      <h3 class="font-semibold text-lg mb-2">Recent Comments</h3>
      <div class="flex flex-col gap-2 max-h-48 overflow-y-auto">
        ${analytics.comments?.length ? analytics.comments.map(c => `
          <div class="p-2 bg-zinc-900 rounded">
            <p class="text-sm text-zinc-300"><strong>${c.user}#${c.tag}</strong> • ${new Date(c.createdAt).toLocaleDateString()}</p>
            <p>${c.text}</p>
          </div>
        `).join('') : '<p class="text-zinc-400 text-sm">No comments yet</p>'}
      </div>
    </div>
  `;

  container.appendChild(div);

  // ================== CHARTS ==================
  const messagesCtx = document.getElementById(`messagesChart-${server._id}`);
  new Chart(messagesCtx, {
    type: 'bar',
    data: {
      labels: ['Last 24h', 'Last 7d'],
      datasets: [{
        label: 'Messages',
        data: [analytics.messages?.last24h || 0, analytics.messages?.last7d || 0],
        backgroundColor: ['#6366F1','#10B981']
      }]
    },
    options: { responsive:true, plugins:{ legend:{display:false} } }
  });

  const presenceCtx = document.getElementById(`presenceChart-${server._id}`);
  new Chart(presenceCtx, {
    type: 'doughnut',
    data: {
      labels: ['Online','Idle','DND','Offline'],
      datasets: [{
        data: [
          analytics.presence?.online || 0,
          analytics.presence?.idle || 0,
          analytics.presence?.dnd || 0,
          analytics.presence?.offline || 0
        ],
        backgroundColor: ['#22C55E','#FACC15','#EF4444','#6B7280']
      }]
    },
    options: { responsive:true }
  });
}

// ================== INIT ==================
fetchMyServers();
</script>

</body>
</html>
